# وحدة التحليلات (Analytics Module)

تقدم هذه الوحدة طبقة كاملة لجمع بيانات التفاعل مع عملاء التاجر، حساب المقاييس، وإرجاع تقارير جاهزة للاستهلاك عبر واجهات REST مخصّصة للتاجر والإدارة.

## التبعية
- تستخدم `MongooseModule` مع مخططات `MessageSession`, `Order`, `Product`, `MissingResponse`, `KleemMissingResponse`, `Merchant`, `Channel`.
- تعتمد على وحدات داخلية مثل `ProductsModule`, `FaqModule`, `NotificationsModule`, و`CommonModule` (لتقديم خدمات مترجمة).
- تستبدل التبعيات عبر `AnalyticsRepository` باستخدام التنفيذ الافتراضي `MongoAnalyticsRepository`.

## التكوين
1. تأكد من تسجيل المخططات المذكورة في قاعدة بيانات MongoDB.
2. استورد `AnalyticsModule` في الوحدة الجذرية أو الوحدة المسؤولة عن مجالات التاجر.
3. وفّر إعدادات الاتصال بقاعدة البيانات وإعدادات المنطقة الزمنية ضمن تكوين التطبيق.
4. اضبط أي متغيرات بيئية تستخدم في حساب المقاييس أو إرسال الإشعارات (مثلاً إعدادات البريد أو القنوات).

## الخدمات المتاحة
- `getOverview`: إرجاع ملخص للجلسات، الرسائل، الطلبات، الكلمات المفتاحية، الأداء المالي، وCsat لمختلف الفترات (`week | month | quarter`).
- `getMessagesTimeline`، `getTopKeywords`، `getTopProducts`: لتقسيم النشاط حسب اليوم/الساعة أو إظهار العناصر الأكثر تكرارًا.
- إدارة حالات `missing responses` بما يشمل: `createFromWebhook`, `listMissingResponses`, `markResolved`, `bulkResolveMarch`, `stats`, `addToKnowledge`.
- دعم حالات Kleem (المفقودات الناتجة عن التكامل) عبر `createKleemFromWebhook`, `listKleemMissing`, `updateKleemMissing`, `bulkResolve`.
- `notifyMissingStatsToUser`: إرسال تنبيهات تسلط الضوء على أبرز مشاكل الردود الناقصة للقنوات المختلفة.

## وحدات التحكم
- `AnalyticsController`: واجهات REST مخصصة للتاجر، تشمل لوحات التحكم، الجداول، وإدارة الردود الناقصة.
- `AnalyticsAdminController`: نقاط نهاية إضافية لمشرفي النظام لإجراء تحليلات شاملة على مستوى المنصة.

## مثال على الاستخدام داخل خدمة أخرى
```typescript
import { AnalyticsService } from 'src/modules/analytics/analytics.service';

@Injectable()
export class DashboardService {
  constructor(private readonly analyticsService: AnalyticsService) {}

  async loadOverview(merchantId: string) {
    return this.analyticsService.getOverview(merchantId, 'month');
  }
}
```

## الاختبارات
- استخدم مجلد `__tests__/` لإضافة أو تشغيل الاختبارات الوظيفية (unit/integration) الخاصة بالمخازن والخدمات.

## شرح مفصل للعمليات

### الغرض الرئيسي
تقدم هذه الوحدة نظامًا شاملاً لجمع وتحليل بيانات التفاعلات بين التجار وعملائهم، مع توفير مقاييس وتقارير جاهزة للاستهلاك عبر واجهات REST.

### العمليات الرئيسية:

#### 1. جمع البيانات الأساسية
- **الجلسات (Sessions)**: تتبع جلسات المحادثات بين العملاء والمساعد الآلي
- **الرسائل (Messages)**: تسجيل كل رسالة واردة وصادرة مع الطوابع الزمنية
- **الطلبات (Orders)**: ربط عمليات الشراء بالتفاعلات
- **المنتجات (Products)**: تتبع المنتجات المذكورة في المحادثات

#### 2. عمليات المقاييس والإحصائيات

**`getOverview`**:
- حساب عدد الجلسات والتغيير المئوي مقارنة بالفترة السابقة
- إجمالي عدد الرسائل المرسلة
- الكلمات المفتاحية الأكثر تكرارًا
- المنتجات الأكثر ذكرًا
- توزيع الاستخدام عبر القنوات (Telegram, WhatsApp, Webchat)
- إحصائيات الطلبات: العدد، التغيير المئوي، التوزيع حسب الحالة، إجمالي المبيعات
- CSAT (رضا العميل) ووقت الرد الأول
- عدد المشاكل المفتوحة ومتوسط قيمة الطلب

**`getMessagesTimeline`**:
- رسم خط زمني لعدد الرسائل
- تجميع البيانات يوميًا أو ساعيًا حسب الفترة المحددة

**`getTopKeywords`** & **`getTopProducts`**:
- استخراج الكلمات المفتاحية الأكثر تكرارًا
- تحديد المنتجات الأكثر ذكرًا في المحادثات

#### 3. إدارة الردود الناقصة (Missing Responses)

**`createFromWebhook`**:
- تلقي إشعارات من المساعد الآلي عند عدم قدرته على الرد
- حفظ تفاصيل المشكلة: السؤال، الرد الآلي، تحليل الذكاء الاصطناعي

**`listMissingResponses`**:
- استعلام وتصفية الردود الناقصة حسب:
  - حالة الحل (محلول/غير محلول)
  - القناة (Telegram/WhatsApp/Webchat)
  - نوع المشكلة (رد ناقص/منتج غير متوفر)
  - نص البحث في السؤال أو الرد أو رقم الجلسة
  - نطاق زمني محدد

**`markResolved`** & **`bulkResolveMarch`**:
- وضع علامة "محلول" على المشاكل الفردية أو الجماعية
- ربط المستخدم الذي قام بالحل

**`addToKnowledge`**:
- تحويل المشكلة الناقصة إلى سؤال وجواب في قاعدة المعرفة
- إنشاء إدخال جديد في `FaqModule`
- وضع علامة محلول تلقائيًا

**`stats`**:
- إحصائيات يومية للمشاكل الناقصة خلال فترة محددة

#### 4. عمليات Kleem (التكامل الخاص)
- **`createKleemFromWebhook`**: تلقي مشاكل من نظام Kleem
- **`listKleemMissing`**: استعراض المشاكل
- **`updateKleemMissing`**: تحديث حالة المشكلة
- **`bulkResolve`**: حل جماعي

#### 5. التنبيهات والإشعارات
**`notifyMissingStatsToUser`**:
- إرسال تقارير دورية للتجار حول المشاكل الشائعة
- تسليط الضوء على القنوات الأكثر مشاكل
- استخدام `NotificationsService` للإرسال

### الأمان والصلاحيات
- كل عملية تتحقق من ملكية التاجر للبيانات
- رمي `ForbiddenException` عند محاولة الوصول غير المصرح
- التحقق من صحة البيانات الواردة عبر DTOs

### التكامل مع الوحدات الأخرى
- **FaqModule**: لإضافة معرفة جديدة من المشاكل
- **NotificationsModule**: للتنبيهات
- **CommonModule**: للترجمة والخدمات المشتركة
- **ProductsModule**: للبيانات المنتجية

### الاعتبارات الفنية
- استخدام MongoDB مع Mongoose للاستعلامات المعقدة
- دعم الاستعلامات الزمنية والتجميعات
- تنظيف البيانات القديمة لتجنب التضخم
- اختبارات شاملة في مجلد `__tests__`

## اعتبارات إضافية
- تأكد من تنظيف البيانات القديمة أو أرشفتها عبر مهام مجدولة لتجنب تضخم مجموعات MongoDB.
- راقب الأذونات: بعض العمليات مثل `addToKnowledge` تتحقق من ملكية التاجر وتلقي استثناء `ForbiddenException` عند المخالفة.
- استعمل `NotificationsService` بشكل مسؤول لتفادي إرسال تنبيهات متكررة للمستخدمين النهائيين.

