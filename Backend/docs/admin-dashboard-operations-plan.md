# خطة عمليات لوحة تحكم الأدمن (التطوير المستقبلي)

> وثيقة تخطيط لعمليات وإمكانيات لوحة تحكم الأدمن التي يُقترح إضافتها أو تطويرها بعد اكتمال المسارات الأساسية.

---

## 1. ما تم تنفيذه (المرجع الحالي)

- **لوحة رئيسية:** `GET /admin/dashboard` — إحصائيات مجمعة (تجار، مستخدمين، استهلاك).
- **التجار:** قائمة، إحصائيات، تفاصيل، تحديث حالة (active, status).
- **المستخدمون:** قائمة، إحصائيات، تفاصيل، تحديث دور/حالة.
- **الاستهلاك:** قائمة استهلاك شهري، إحصائيات، تفاصيل تاجر.
- **الخطط:** CRUD + تفعيل/أرشفة تحت `admin/plans`.
- **القنوات، التوجيهات، AI، التحليلات، الكاش، الدعم، كليم:** مسارات إدارية موثقة في `ADMIN_ROUTES.md`.

---

## 2. عمليات مقترحة للتطوير (حسب الأولوية)

### المرحلة أ: تعزيز لوحة التحكم والبيانات ✅ (تم تنفيذها)

| # | العملية | الوصف | المسار/الآلية |
|---|---------|--------|-------------------------|
| أ.1 | **إحصائيات زمنية للوحة الرئيسية** | ترند يومي للتجار والمستخدمين، ترند شهري للاستهلاك | `GET /admin/dashboard/trends?period=7d\|30d` |
| أ.2 | **تصدير قوائم (CSV)** | تصدير قائمة التجار، المستخدمين، التذاكر، الاستهلاك | `GET /admin/merchants/export`، `admin/users/export`، `admin/support/export`، `admin/usage/export` |
| أ.3 | **بحث نصي في القوائم** | بحث في أسماء/بريد/موضوع التذاكر | معامل `search` في Query DTOs + `$text` في الـ repository |
| أ.4 | **ترتيب وتصفية متقدمة** | ترتيب حسب تاريخ، اسم، حالة؛ تصفية حسب خطة اشتراك | `sortBy`, `sortOrder`, `subscriptionTier` في الـ DTOs |

---

### المرحلة ب: إدارة التجار والمستخدمين (عمليات إضافية) ✅ (تم تنفيذها)

| # | العملية | الوصف | المسار/الآلية المقترحة |
|---|---------|--------|-------------------------|
| ب.1 | **تعليق/إعادة تفعيل تاجر (مع سبب)** | تعليق تاجر مع تخزين السبب وتاريخ الإجراء | `POST /admin/merchants/:id/suspend` و `POST /admin/merchants/:id/unsuspend` مع body `{ reason }` |
| ب.2 | **سجل إجراءات تاجر (Audit)** | عرض من قام بماذا ومتى على التاجر | جدول/مجموعة `merchant_audit_log` + `GET /admin/merchants/:id/audit-log` |
| ب.3 | **إعادة تعيين كلمة مرور مستخدم (أدمن)** | تعيين كلمة مؤقتة وإرجاعها للأدمن | `POST /admin/users/:id/reset-password` (يُرجع `{ temporaryPassword }`) |
| ب.4 | **تعطيل/تفعيل مستخدم مع سبب** | تعطيل حساب مع تخزين السبب للأرشفة | توسيع `PATCH /admin/users/:id` مع `reason` في body |
| ب.5 | **ربط مستخدم بتاجر (تعيين merchantId)** | للأعضاء أو الموظفين المرتبطين بمتجر | `PATCH /admin/users/:id` مع دعم `merchantId` |

---

### المرحلة ج: الاستهلاك والفوترة ✅ (تم تنفيذها)

| # | العملية | الوصف | المسار/الآلية المقترحة |
|---|---------|--------|-------------------------|
| ج.1 | **تنبيهات تجاوز الحد** | قائمة تجار تجاوزوا حد الرسائل أو قاربوه | `GET /admin/usage/alerts?monthKey=&thresholdPercent=&limit=` |
| ج.2 | **إعادة تعيين الاستهلاك (استثنائي)** | إعادة عداد شهر معيّن لتاجر (بموافقة/سجل) | `POST /admin/usage/:merchantId/reset?monthKey=YYYY-MM` مع تسجيل في merchant_audit_log |
| ج.3 | **تقرير استهلاك لفترة مخصصة** | استهلاك حسب أشهر متعددة | `GET /admin/usage/report?from=YYYY-MM&to=YYYY-MM` |
| ج.4 | **ربط الاستهلاك بالخطة والحد** | عرض الحد و% الاستهلاك لكل تاجر | توسيع `GET /admin/usage` بمعلومات messageLimit، usagePercent، isUnlimited |

---

### المرحلة د: الدعم والتذاكر ✅ (تم تنفيذها)

| # | العملية | الوصف | المسار/الآلية المقترحة |
|---|---------|--------|-------------------------|
| د.1 | **تعيين تذكرة لموظف دعم** | حقل `assignedTo` وتحديثه من الأدمن | إضافة `assignedTo` في الـ schema + `PATCH /admin/support/:id` مع `assignedTo` |
| د.2 | **إضافة رد/تعليق على تذكرة** | ردود أدمن (داخلية أو علنية) | حقل `replies` فرعي + `POST /admin/support/:id/replies` |
| د.3 | **إحصائيات التذاكر** | عدد حسب الحالة، متوسط وقت الحل | `GET /admin/support/stats` |
| د.4 | **إشعار عند تحديث التذكرة** | إشعار عند تغيير الحالة أو إضافة رد | NotifyUser إن وُجد createdBy، أو إيميل للزائر |

---

### المرحلة هـ: النظام والأمان ✅ (تم تنفيذها)

| # | العملية | الوصف | المسار/الآلية |
|---|---------|--------|-------------------------|
| هـ.1 | **سجل تدقيق عام (Audit Log)** | تسجيل تعديلات أدمن (من، ماذا، متى، على أي مورد) | `admin_audit_log` + interceptor تلقائي + `GET /admin/system/audit-log` |
| هـ.2 | **إدارة جلسات الأدمن** | عرض/إلغاء جلسات أدمن نشطة | `GET /admin/system/sessions`، `DELETE /admin/system/sessions/:jti` |
| هـ.3 | **قفل/فتح واجهات حساسة** | إيقاف مؤقت لإنشاء حسابات أو تسجيل تجار جدد | `DISABLE_USER_SIGNUP`، `DISABLE_MERCHANT_SIGNUP` + `GET /admin/system/feature-flags` |
| هـ.4 | **نسخ احتياطي واستعادة** | نقطة استدعاء لبدء نسخ احتياطي | `POST /admin/system/backup` (يتطلب `BACKUP_TRIGGER_URL`) |

---

### المرحلة و: التقارير والتحليلات ✅ (تم تنفيذها)

| # | العملية | الوصف | المسار/الآلية |
|---|---------|--------|-------------------------|
| و.1 | **تقرير نشاط التجار** | آخر نشاط، عدد المحادثات، تفعيل القنوات | `GET /admin/reports/merchant-activity/:merchantId` |
| و.2 | **تقرير التحويلات/التسجيل** | عدد تسجيلات التجار والمستخدمين حسب الفترة | `GET /admin/reports/signups?from=YYYY-MM-DD&to=YYYY-MM-DD` |
| و.3 | **تحليلات كليم (توسيع)** | ملخص الردود المفقودة (مفتوحة/محلولة) | `GET /admin/reports/kleem-summary` |
| و.4 | **تقرير الاستخدام حسب الخطة** | توزيع التجار على الخطط واستهلاك كل خطة | `GET /admin/reports/usage-by-plan?monthKey=YYYY-MM` |

---

### المرحلة ز: واجهة لوحة التحكم (Frontend)

| # | العملية | الوصف | ملاحظات |
|---|---------|--------|---------|
| ز.1 | **شاشة لوحة رئيسية** | عرض إحصائيات من `GET /admin/dashboard` مع رسوم بيانية بسيطة | استخدام الـ API الحالي أو توسيعه بترندات (المرحلة أ.1) |
| ز.2 | **شاشات قوائم (تجار، مستخدمين، تذاكر، استهلاك)** | جداول مع فلترة، ترقيم، بحث، وروابط للتفاصيل | ربط بمسارات الـ admin الحالية |
| ز.3 | **شاشات تفاصيل (تاجر/مستخدم/تذكرة)** | عرض كامل + أزرار تحديث حالة / تعليق / إلخ | ربط بـ GET by id و PATCH الحالية |
| ز.4 | **إدارة الخطط** | قائمة خطط، إنشاء/تعديل/أرشفة من الواجهة | ربط بـ `admin/plans` |
| ز.5 | **تنبيهات ورسائل للأدمن** | إشعارات لتذاكر جديدة، تجاوز حدود، أخطاء نظام | WebSocket أو polling من نقاط موجودة/جديدة |
| ز.6 | **صلاحيات فرعية (أدوار أدمن)** | إن وُجدت أدوار مثل Super Admin / Support Admin | توسيع نموذج الصلاحيات والـ guards في الـ Backend |

---

## 3. ترتيب تنفيذ مقترح

```
المرحلة أ  → تعزيز البيانات واللوحة (ترندات، تصدير، بحث)
المرحلة ب  → عمليات إضافية على التجار والمستخدمين (تعليق، سجل، إعادة كلمة مرور)
المرحلة ج  → الاستهلاك والتنبيهات وإعادة التعيين
المرحلة د  → تعزيز التذاكر (تعيين، ردود، إحصائيات)
المرحلة هـ → سجل تدقيق وأمان
المرحلة و  → تقارير وتحليلات إضافية
المرحلة ز  → واجهة لوحة التحكم (يمكن توازيها مع أ–و حسب الفريق)
```

---

## 4. معايير تقنية موحدة

- **الأمان:** كل عملية حساسة (تعليق تاجر، إعادة كلمة مرور، نسخ احتياطي) تُسجّل في سجل تدقيق إن وُجد.
- **الأداء:** قوائم كبيرة تستخدم ترقيم صفحي وفلترة على مستوى قاعدة البيانات؛ تجنّب تحميل كل السجلات دفعة واحدة.
- **التوثيق:** أي مسار جديد يُضاف إلى `ADMIN_ROUTES.md` ويُوسم في Swagger تحت **Admin**.
- **الاختبارات:** إضافة unit tests للـ controllers والخدمات الجديدة على غرار المسارات الإدارية الحالية.

---

## 5. مراجع

- قائمة المسارات الإدارية الحالية: `Backend/docs/ADMIN_ROUTES.md`
- خطة تنفيذ المسارات الإدارية: `Backend/docs/admin-routes-execution-plan.md`

---

*آخر تحديث: 2025-02-11*
