# ==============================================
# Kleem / Vite React SPA - Hostinger/LiteSpeed
# ==============================================

# --------- الأساسيات ---------
Options -Indexes

# توجيه كامل روابط الـSPA إلى index.html (مع استثناء الأصول الفعلية)
<IfModule mod_rewrite.c>
  RewriteEngine On
  RewriteBase /

  # HTTP -> HTTPS (اتركه مفعّل إن كان لديك SSL)
  RewriteCond %{HTTPS} off
  RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

  # www -> non-www (اختياري)
  RewriteCond %{HTTP_HOST} ^www\.(.*)$ [NC]
  RewriteRule ^(.*)$ https://%1/$1 [R=301,L]

  # استثناءات ملفات الخدمة إن وُجدت (PWA/Service Worker/manifest/widget)
  RewriteRule ^(manifest\.webmanifest|service-worker\.js|sw\.js|robots\.txt|sitemap\.xml|widget\.js)$ - [L]

  # لا تُحوِّل انطلاقة طلبات الأصول الموجودة فعلاً
  RewriteCond %{REQUEST_FILENAME} -f [OR]
  RewriteCond %{REQUEST_FILENAME} -d
  RewriteRule ^ - [L]

  # أي مسار آخر يعود إلى index.html (SPA)
  RewriteRule . /index.html [L]
</IfModule>

# --------- الضغط (Gzip/Brotli) ---------
# LiteSpeed غالباً يفعِّل Brotli تلقائياً من لوحة الاستضافة.
# نضيف Gzip كاحتياط.
<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/plain text/html text/xml text/css
  AddOutputFilterByType DEFLATE application/json application/javascript application/xml application/xhtml+xml image/svg+xml
  # WASM إن وجد
  AddOutputFilterByType DEFLATE application/wasm
</IfModule>

# --------- التخزين المؤقت (Cache-Control/Expires) ---------
# ملفات ذات هاش آمنة للكاش الطويل (Vite ينتج أسماء بها hash)
<IfModule mod_headers.c>
  <FilesMatch "\.(?:js|mjs|css|woff2?|ttf|eot|svg|png|jpg|jpeg|gif|webp|avif)$">
    Header set Cache-Control "public, max-age=31536000, immutable"
  </FilesMatch>

  # HTML لا كاش (لتحديثات فورية بعد النشر)
  <FilesMatch "\.(?:html)$">
    Header set Cache-Control "no-cache, no-store, must-revalidate"
    Header set Pragma "no-cache"
    Header set Expires "0"
  </FilesMatch>
</IfModule>

<IfModule mod_expires.c>
  ExpiresActive On
  # أصول ثابتة
  ExpiresByType text/css "access plus 1 year"
  ExpiresByType application/javascript "access plus 1 year"
  ExpiresByType image/png "access plus 1 year"
  ExpiresByType image/jpg "access plus 1 year"
  ExpiresByType image/jpeg "access plus 1 year"
  ExpiresByType image/gif "access plus 1 year"
  ExpiresByType image/svg+xml "access plus 1 year"
  ExpiresByType image/webp "access plus 1 year"
  ExpiresByType font/woff "access plus 1 year"
  ExpiresByType font/woff2 "access plus 1 year"
  # HTML قصير/لا كاش
  ExpiresByType text/html "access plus 0 seconds"
</IfModule>

# --------- رؤوس الأمان العملية ---------
<IfModule mod_headers.c>
  # منع Clickjacking
  Header always set X-Frame-Options "SAMEORIGIN"
  # منع MIME Sniffing
  Header always set X-Content-Type-Options "nosniff"
  # سياسة Referrer
  Header always set Referrer-Policy "strict-origin-when-cross-origin"
  # HSTS (فعّل فقط إن كان HTTPS دائمًا على الدومين والجميع)
  Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

  # ملاحظة: X-XSS-Protection قديمة وغير فعّالة على المتصفحات الحديثة؛ لا حاجة لها.

  # ------ Content Security Policy ------
  # عدّل الدومينات في connect-src/img-src/font-src بما يناسبك:
  # - API:      https://api.kaleem-ai.com
  # - WebSocket: wss://api.kaleem-ai.com
  # - MinIO/Uploads (إن وُجد): https://minio.your-domain.com أو IP
  # - خطوط Google: fonts.googleapis.com / fonts.gstatic.com
  # تحليلات:  www.googletagmanager.com / www.google-analytics.com
  Header always set Content-Security-Policy "\
default-src 'self'; \
script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.googletagmanager.com; \
style-src  'self' 'unsafe-inline' https://fonts.googleapis.com; \
font-src   'self' https://fonts.gstatic.com data:; \
img-src * data:;\
connect-src 'self' https://api.kaleem-ai.com wss://api.kaleem-ai.com https://31.97.155.167:3000 https://www.google-analytics.com;


  # (اختياري) حماية الرفع عبر CORS للخطوط/الصور/الويدجت من دوميناتك الفرعية
  <FilesMatch "\.(?:woff2?|ttf|eot|svg|png|jpg|jpeg|webp|avif|js)$">
    Header set Access-Control-Allow-Origin "*"
    Header set Access-Control-Allow-Methods "GET, OPTIONS"
  </FilesMatch>
</IfModule>

# --------- منع الوصول للملفات الحساسة ---------
<FilesMatch "^\.">
  Require all denied
</FilesMatch>

<FilesMatch "\.(htaccess|htpasswd|ini|log|sh|sql|conf)$">
  Require all denied
</FilesMatch>

# --------- ملاحظات PHP (اختياري) ---------
# إن كان المسار يعمل على PHP وتحتاج رفع ملفات أكبر:
<IfModule mod_php.c>
  php_value upload_max_filesize 64M
  php_value post_max_size 64M
  php_value max_execution_time 300
  php_value max_input_vars 3000
</IfModule>
AddType application/javascript .js
AddType application/javascript .mjs
AddType text/css .css
AddType application/wasm .wasm
