# ูุซููุฉ ุฎุทูุท ุจูุงูุงุช ุงูุฐูุงุก/RAG - ููุตุฉ Kaleem

## ๐ ูุธุฑุฉ ุนุงูุฉ

ูุฐู ุงููุซููุฉ ุชุตู ูุธุงู RAG (Retrieval-Augmented Generation) ูู ููุตุฉ Kaleemุ ูุงูุฐู ูุชุถูู ูุตุงุฏุฑ ุงููุนุฑูุฉุ ุงุณุชุฑุงุชูุฌูุงุช ุงูุชุฌุฒุฆุฉุ ุชูููุฏ ุงูู Embeddingsุ ุญุฏูุฏ ุงูุญุฌูุ ุงูุชุญุฏูุซุงุชุ ูุฅุณุชุฑุงุชูุฌูุฉ ุฅุนุงุฏุฉ ุงูููุฑุณุฉ.

---

## ๐ฏ ูุตุงุฏุฑ ุงููุนุฑูุฉ (Knowledge Sources)

### 1. ูุตุงุฏุฑ ุงููุนุฑูุฉ ุงูุฑุฆูุณูุฉ

#### ุฃ) ุงูุฃุณุฆูุฉ ุงูุดุงุฆุนุฉ (FAQs)

- **ุงููุตุฏุฑ**: ูุงุนุฏุฉ ุจูุงูุงุช MongoDB - `bot_faqs` collection
- **ุงูููุน**: ุฃุณุฆูุฉ ูุฃุฌูุจุฉ ููุธูุฉ
- **ุงููุบุฉ**: ุงูุนุฑุจูุฉ (ุงูุชุฑุงุถู) ูุน ุฏุนู ูุชุนุฏุฏ ุงููุบุงุช
- **ุงููุนุฑูุงุช**:
  - `faqId`: ูุนุฑู ุงูุณุคุงู ูู MongoDB
  - `question`: ูุต ุงูุณุคุงู
  - `answer`: ูุต ุงูุฅุฌุงุจุฉ
  - `tags`: ุชุตูููุงุช ุงูุณุคุงู
  - `locale`: ุงููุบุฉ (ar, en, etc.)

#### ุจ) ุงููุซุงุฆู ุงููุฑููุนุฉ (Documents)

- **ุงููุตุฏุฑ**: ูููุงุช ูุฑููุนุฉ ุนุจุฑ ูุงุฌูุฉ ุงููุณุชุฎุฏู
- **ุงูุฃููุงุน ุงููุฏุนููุฉ**:
  - PDF (`application/pdf`)
  - Word Documents (`.docx`)
  - Excel Files (`.xlsx`, `.xls`)
- **ุงูุชุฎุฒูู**: MinIO S3-compatible storage
- **ุงููุนุฑูุงุช**:
  - `documentId`: ูุนุฑู ุงููุซููุฉ
  - `merchantId`: ูุนุฑู ุงูุชุงุฌุฑ
  - `text`: ุงููุต ุงููุณุชุฎุฑุฌ
  - `chunkIndex`: ููุฑุณ ุงููุทุนุฉ
  - `totalChunks`: ุฅุฌูุงูู ุงููุทุน

#### ุฌ) ุงููุนุฑูุฉ ูู ุงูููุจ (Web Knowledge)

- **ุงููุตุฏุฑ**: ุฑูุงุจุท URL ูุฑููุนุฉ ูู ูุจู ุงูุชุงุฌุฑ
- **ุงูุงุณุชุฎุฑุงุฌ**: Playwright + FastAPI Extractor Service
- **ุงููุนุฑูุงุช**:
  - `url`: ุงูุฑุงุจุท ุงูุฃุตูู
  - `text`: ุงููุต ุงููุณุชุฎุฑุฌ
  - `type`: ููุน ุงููุตุฏุฑ (url)
  - `source`: ูุตุฏุฑ ุงููุนุฑูุฉ (web)

#### ุฏ) ุงูููุชุฌุงุช (Products)

- **ุงููุตุฏุฑ**: ููุชุฌุงุช ุงูุชุงุฌุฑ ูู ููุตุงุช ุงูุชุฌุงุฑุฉ ุงูุฅููุชุฑูููุฉ
- **ุงูุชูุงูู**: Salla, Zid, Shopify
- **ุงููุนุฑูุงุช**:
  - `mongoId`: ูุนุฑู ุงูููุชุฌ ูู MongoDB
  - `name`: ุงุณู ุงูููุชุฌ
  - `description`: ูุตู ุงูููุชุฌ
  - `price`: ุงูุณุนุฑ
  - `categoryName`: ุงุณู ุงููุฆุฉ
  - `images`: ุตูุฑ ุงูููุชุฌ

---

## ๐ง ุงุณุชุฑุงุชูุฌูุงุช ุงูุชุฌุฒุฆุฉ (Chunking Strategies)

### 1. ุชุฌุฒุฆุฉ ุงููุซุงุฆู (Document Chunking)

```typescript
// ุญุฌู ุงููุทุนุฉ ุงููุตูู ูููุซุงุฆู
const maxChunkSize = 500; // ุญุฑู

// ุงุณุชุฑุงุชูุฌูุฉ ุงูุชุฌุฒุฆุฉ
const chunks = text.match(new RegExp(`.{1,${maxChunkSize}}`, "gs")) ?? [];
```

**ุงููุนุงููุฑ**:

- **ุญุฌู ุงููุทุนุฉ**: 500 ุญุฑู ูุญุฏ ุฃูุตู
- **ุงูุญุฏ ุงูุฃุฏูู**: 30 ุญุฑู (ุชุฌุงูู ุงููุทุน ุงูุตุบูุฑุฉ)
- **ุงูุชุฏุงุฎู**: ูุง ููุฌุฏ ุชุฏุงุฎู ุจูู ุงููุทุน
- **ุงูุญุฏ ุงูุฃูุตู ูููุต ูู Payload**: 2000 ุญุฑู

### 2. ุชุฌุฒุฆุฉ ุงููุนุฑูุฉ ูู ุงูููุจ (Web Knowledge Chunking)

```typescript
// ุชุฌุฒุฆุฉ ุงููุต ุงููุณุชุฎุฑุฌ ูู ุงูููุจ
const chunks = (text.match(/.{1,1000}/gs) ?? []).map((s) => s.trim());
```

**ุงููุนุงููุฑ**:

- **ุญุฌู ุงููุทุนุฉ**: 1000 ุญุฑู
- **ุงูุญุฏ ุงูุฃุฏูู**: 30 ุญุฑู
- **ููุชุฑุฉ ุงููุญุชูู**: ูุฌุจ ุฃู ูุญุชูู ุนูู 3 ุฃุญุฑู ุนุฑุจูุฉ ุนูู ุงูุฃูู
- **ุงูุชุญูู ูู ุงููุงุฆุฏุฉ**: `isUsefulChunk()` function

### 3. ุชุฌุฒุฆุฉ ุงูููุชุฌุงุช (Product Chunking)

```typescript
// ุชุฌุฒุฆุฉ ูุนูููุงุช ุงูููุชุฌ
const vectorText = {
  name: product.name,
  description: product.description,
  categoryName: product.categoryName,
  specsBlock: product.specsBlock,
  keywords: product.keywords,
  // ... ุงููุฒูุฏ ูู ุงูุญููู
};
```

**ุงููุนุงููุฑ**:

- **ูุต ูุงุญุฏ ูุชูุงูู**: ูุง ูุชู ุชุฌุฒุฆุฉ ุงูููุชุฌุงุช
- **ุฌููุน ุงููุนูููุงุช**: ูุชู ุชุถููู ุฌููุน ุญููู ุงูููุชุฌ ูู ูุต ูุงุญุฏ

---

## ๐ง ุชูููุฏ ุงูู Embeddings

### 1. ุฎุฏูุฉ ุงูู Embeddings

**ุงูุชูููุฉ**: FastAPI + Sentence Transformers
**ุงููููุฐุฌ**: `paraphrase-multilingual-MiniLM-L12-v2`
**ุงูุจุนุฏ**: 384 ุจุนุฏ (dimension)

```python
# embedding-service/main.py
model_name = "paraphrase-multilingual-MiniLM-L12-v2"
model = SentenceTransformer(model_name)

@app.post("/embed")
def embed(req: EmbeddingRequest):
    embeddings = model.encode(req.texts, show_progress_bar=False).tolist()
    return EmbeddingResponse(embeddings=embeddings)
```

### 2. ูุนุงูุฌุฉ ุงููุตูุต ููู Embeddings

```typescript
// ุชุญููู ุงูุจูุงูุงุช ุฅูู ูุต ูุงุจู ููู embedding
private toStringList(val: any, seen: WeakSet<any> = new WeakSet(), depth = 0): string[] {
  const MAX_DEPTH = 4;

  // ูุนุงูุฌุฉ ุงูุฃููุงุน ุงููุฎุชููุฉ ูู ุงูุจูุงูุงุช
  if (typeof val === 'string' || typeof val === 'number' || typeof val === 'boolean') {
    return [String(val)];
  }

  // ูุนุงูุฌุฉ ุงููุตูููุงุช ูุงููุงุฆูุงุช
  // ... ููุทู ุงูุชุญููู
}
```

---

## ๐ ุญุฏูุฏ ุงูุญุฌู (Size Limits)

### 1. ุญุฏูุฏ ุงููููุงุช

| ููุน ุงูููู | ุงูุญุฏ ุงูุฃูุตู | ููุงุญุธุงุช              |
| --------- | ----------- | -------------------- |
| PDF       | 10MB        | ูุนุงูุฌุฉ ุนุจุฑ pdf-parse |
| Word      | 10MB        | ูุนุงูุฌุฉ ุนุจุฑ mammoth   |
| Excel     | 10MB        | ูุนุงูุฌุฉ ุนุจุฑ xlsx      |
| ุงูุตูุฑ     | 5MB         | ูุนุงูุฌุฉ ุนุจุฑ sharp     |

### 2. ุญุฏูุฏ ุงููุตูุต

| ุงูููุน  | ุงูุญุฏ ุงูุฃูุตู   | ุงูุญุฏ ุงูุฃุฏูู |
| ------ | ------------- | ----------- |
| ูุซุงุฆู  | 500 ุญุฑู/ูุทุนุฉ  | 30 ุญุฑู      |
| ููุจ    | 1000 ุญุฑู/ูุทุนุฉ | 30 ุญุฑู      |
| FAQ    | ูุง ููุฌุฏ ุญุฏ    | 10 ุญุฑู      |
| ููุชุฌุงุช | ูุง ููุฌุฏ ุญุฏ    | 5 ุญุฑู       |

### 3. ุญุฏูุฏ ูุงุนุฏุฉ ุงูุจูุงูุงุช

| ุงููููู           | ุงูุญุฏ ุงูุฃูุตู    | ููุงุญุธุงุช              |
| ---------------- | -------------- | -------------------- |
| Qdrant Vector    | 1000 ููุทุฉ/ุฏูุนุฉ | ูุนุงูุฌุฉ ูุฌูุนุฉ         |
| MongoDB Document | 16MB           | ุญุฏ MongoDB ุงูุงูุชุฑุงุถู |
| Redis Cache      | 512MB          | ุญุฏ Redis ุงูุงูุชุฑุงุถู   |
| MinIO Object     | 5GB            | ุญุฏ MinIO ุงูุงูุชุฑุงุถู   |

---

## ๐ ุงูุชุญุฏูุซุงุช ูุฅุนุงุฏุฉ ุงูููุฑุณุฉ

### 1. ุงุณุชุฑุงุชูุฌูุฉ ุงูุชุญุฏูุซ

#### ุฃ) ุงูุชุญุฏูุซ ุงูููุฑู (Real-time Updates)

```typescript
// ุชุญุฏูุซ FAQ ููุฑู
async create(dto: CreateBotFaqDto) {
  const doc = await this.botFaqModel.create(dto);

  // ุชูููุฏ embedding ููุฑู
  const embedding = await this.vectorService.embed(text);
  await this.vectorService.upsertBotFaqs([{
    id: this.pointId(doc.id.toString()),
    vector: embedding,
    payload: { /* ... */ }
  }]);

  // ุชุญุฏูุซ ุงูุญุงูุฉ
  doc.vectorStatus = 'ok';
  await doc.save();
}
```

#### ุจ) ุงูุชุญุฏูุซ ุงููุฌูุน (Batch Updates)

```typescript
// ูุนุงูุฌุฉ ูุฌูุนุฉ ูููุซุงุฆู
@Process('process')
async process(job: Job<DocumentJobData>) {
  // ูุนุงูุฌุฉ ุงูููู
  const chunks = await this.processDocument(doc);

  // ุฅุฑุณุงู ูุฌูุน ุฅูู Qdrant
  const batchSize = 2;
  for (let i = 0; i < chunks.length; i += batchSize) {
    const batch = chunks.slice(i, i + batchSize);
    await this.qdrant.upsert(this.documentCollection, {
      wait: true,
      points: batch
    });
  }
}
```

### 2. ุฅุณุชุฑุงุชูุฌูุฉ ุฅุนุงุฏุฉ ุงูููุฑุณุฉ

#### ุฃ) ุฅุนุงุฏุฉ ุงูููุฑุณุฉ ุงูุชููุงุฆูุฉ

- **ุงูููุชุฌุงุช**: ุนูุฏ ุชุญุฏูุซ ุงูููุชุฌ ูู ููุตุฉ ุงูุชุฌุงุฑุฉ
- **ุงููุซุงุฆู**: ุนูุฏ ุฑูุน ููู ุฌุฏูุฏ
- **ุงูููุจ**: ุนูุฏ ุฅุถุงูุฉ ุฑุงุจุท ุฌุฏูุฏ

#### ุจ) ุฅุนุงุฏุฉ ุงูููุฑุณุฉ ุงููุฌุฏููุฉ

```typescript
// ูููุฉ ูุฌุฏููุฉ ูุฅุนุงุฏุฉ ููุฑุณุฉ ุงูุจูุงูุงุช ุงููุฏููุฉ
@Cron('0 2 * * *') // ูู ููู ูู ุงูุณุงุนุฉ 2 ุตุจุงุญุงู
async reindexOldData() {
  // ุฅุนุงุฏุฉ ููุฑุณุฉ ุงูุจูุงูุงุช ุงูุฃูุฏู ูู 30 ููู
  const oldData = await this.getOldData();
  await this.reindexData(oldData);
}
```

#### ุฌ) ุฅุนุงุฏุฉ ุงูููุฑุณุฉ ุงููุฏููุฉ

- **ูุงุฌูุฉ ุงูุฅุฏุงุฑุฉ**: ุฅููุงููุฉ ุฅุนุงุฏุฉ ููุฑุณุฉ ุงูุจูุงูุงุช ูุฏููุงู
- **API**: endpoints ูุฅุนุงุฏุฉ ููุฑุณุฉ ูุฌููุนุงุช ูุญุฏุฏุฉ
- **ุงููุฑุงูุจุฉ**: ุชุชุจุน ุญุงูุฉ ุฅุนุงุฏุฉ ุงูููุฑุณุฉ

---

## ๐ ุงูุจุญุซ ุงูุฏูุงูู (Semantic Search)

### 1. ุงูุจุญุซ ุงูููุญุฏ (Unified Search)

```typescript
async unifiedSemanticSearch(text: string, merchantId: string, topK = 5) {
  const vector = await this.embed(text);
  const searchTargets = [
    { name: 'faqs', type: 'faq' },
    { name: 'documents', type: 'document' },
    { name: 'web_knowledge', type: 'web' }
  ];

  // ุงูุจุญุซ ูู ุฌููุน ุงููุตุงุฏุฑ
  const allResults = await Promise.all(
    searchTargets.map(async (target) => {
      const results = await this.qdrant.search(target.name, {
        vector,
        limit: topK * 2,
        with_payload: true,
        filter: {
          must: [{ key: 'merchantId', match: { value: merchantId } }]
        }
      });
      return results.map(item => ({
        type: target.type,
        score: item.score,
        data: item.payload,
        id: item.id
      }));
    })
  );

  // ุฅุนุงุฏุฉ ุชุฑุชูุจ ุงููุชุงุฆุฌ ุจุงุณุชุฎุฏุงู Gemini
  const rerankedResults = await geminiRerankTopN({
    query: text,
    candidates: allResults.flat(),
    topN: topK
  });

  return rerankedResults;
}
```

### 2. ุฅุนุงุฏุฉ ุชุฑุชูุจ ุงููุชุงุฆุฌ (Reranking)

**ุงูุชูููุฉ**: Google Gemini Reranking
**ุงููุฏู**: ุชุญุณูู ุฏูุฉ ุงููุชุงุฆุฌ ุงููุฑุฌุนุฉ
**ุงููุฏุฎูุงุช**: ุงููุชุงุฆุฌ ุงูุฃูููุฉ ูู Qdrant
**ุงููุฎุฑุฌุงุช**: ุงููุชุงุฆุฌ ุงููุฑุชุจุฉ ุญุณุจ ุงูุตูุฉ

---

## ๐ ุงููุฑุงูุจุฉ ูุงูุฃุฏุงุก

### 1. ููุงููุณ ุงูุฃุฏุงุก

| ุงููููุงุณ         | ุงููุฏู   | ุงูุชุญุฐูุฑ |
| --------------- | ------- | ------- |
| ููุช ุงูุงุณุชุฌุงุจุฉ   | < 200ms | > 500ms |
| ุฏูุฉ ุงูุจุญุซ       | > 85%   | < 70%   |
| ูุนุฏู ุงููุฌุงุญ     | > 99%   | < 95%   |
| ุงุณุชุฎุฏุงู ุงูุฐุงูุฑุฉ | < 80%   | > 90%   |

### 2. ูุฑุงูุจุฉ ุงููุธุงู

```typescript
// ูุฑุงูุจุฉ ุญุงูุฉ ุงูู embeddings
async checkEmbeddingHealth() {
  const metrics = {
    totalVectors: await this.qdrant.getCollectionInfo(),
    failedEmbeddings: await this.getFailedEmbeddings(),
    processingQueue: await this.getQueueStatus(),
    lastUpdate: await this.getLastUpdateTime()
  };

  return metrics;
}
```

### 3. ุงูุชูุจููุงุช

- **ูุดู ุงูู Embeddings**: ุชูุจูู ููุฑู ุนูุฏ ูุดู ุชูููุฏ ุงูู embeddings
- **ุงูุฎูุงุถ ุงูุฃุฏุงุก**: ุชูุจูู ุนูุฏ ุชุฌุงูุฒ ุญุฏูุฏ ุงูุฃุฏุงุก
- **ูุดุงูู ุงูุชุฎุฒูู**: ุชูุจูู ุนูุฏ ุงูุชูุงุก ุงูุชุฎุฒูู
- **ุฃุฎุทุงุก ุงููุนุงูุฌุฉ**: ุชูุจูู ุนูุฏ ูุดู ูุนุงูุฌุฉ ุงููููุงุช

---

## ๐๏ธ ุงูุตูุงูุฉ ูุงูุชุญุณูู

### 1. ุชูุธูู ุงูุจูุงูุงุช

```typescript
// ุญุฐู ุงูุจูุงูุงุช ุงููุฏููุฉ
async cleanupOldData() {
  // ุญุฐู ุงูู vectors ุงููุฏููุฉ
  await this.qdrant.delete('old_vectors', {
    filter: {
      must: [{
        key: 'createdAt',
        range: { lt: Date.now() - 90 * 24 * 60 * 60 * 1000 } // 90 ููู
      }]
    }
  });

  // ุญุฐู ุงููููุงุช ุงููุคูุชุฉ
  await this.cleanupTempFiles();
}
```

### 2. ุชุญุณูู ุงูุฃุฏุงุก

- **ุถุบุท ุงูุจูุงูุงุช**: ุถุบุท ุงููุตูุต ุงูุทูููุฉ
- **ุงูุชุฎุฒูู ุงููุคูุช**: ุชุฎุฒูู ุงูู embeddings ุงููุณุชุฎุฏูุฉ ุจูุซุฑุฉ
- **ุงููุนุงูุฌุฉ ุงููุชูุงุฒูุฉ**: ูุนุงูุฌุฉ ูุชุนุฏุฏุฉ ูููููุงุช ุงููุจูุฑุฉ
- **ุชุญุณูู ุงูุงุณุชุนูุงูุงุช**: ุชุญุณูู ุงุณุชุนูุงูุงุช Qdrant

### 3. ุงููุณุฎ ุงูุงุญุชูุงุทู

- **Qdrant**: ูุณุฎ ุงุญุชูุงุทูุฉ ููููุฉ ููู vectors
- **MongoDB**: ูุณุฎ ุงุญุชูุงุทูุฉ ุฃุณุจูุนูุฉ ููุจูุงูุงุช
- **MinIO**: ูุณุฎ ุงุญุชูุงุทูุฉ ูููููุงุช ุงููุฑููุนุฉ
- **Redis**: ูุณุฎ ุงุญุชูุงุทูุฉ ููุฅุนุฏุงุฏุงุช ุงููุคูุชุฉ

---

## ๐ ุฎุทุฉ ุงูุชุทููุฑ ุงููุณุชูุจููุฉ

### 1. ุชุญุณููุงุช ูุตูุฑุฉ ุงููุฏู (3 ุฃุดูุฑ)

- [ ] ุฏุนู ุงููุฒูุฏ ูู ุฃููุงุน ุงููููุงุช (PPT, TXT, HTML)
- [ ] ุชุญุณูู ุฎูุงุฑุฒููุฉ ุงูุชุฌุฒุฆุฉ
- [ ] ุฅุถุงูุฉ ุฏุนู ููุตูุฑ ูุงููุตูุต ุงููุณุชุฎุฑุฌุฉ ูููุง
- [ ] ุชุญุณูู ูุงุฌูุฉ ูุฑุงูุจุฉ ุงููุธุงู

### 2. ุชุญุณููุงุช ูุชูุณุทุฉ ุงููุฏู (6 ุฃุดูุฑ)

- [ ] ุฏุนู ุงูุจุญุซ ูุชุนุฏุฏ ุงููุบุงุช
- [ ] ุฅุถุงูุฉ ุชุตููู ุชููุงุฆู ูููุญุชูู
- [ ] ุชุญุณูู ุฎูุงุฑุฒููุฉ ุฅุนุงุฏุฉ ุงูุชุฑุชูุจ
- [ ] ุฅุถุงูุฉ ุชุญูููุงุช ูุชูุฏูุฉ ููุงุณุชุฎุฏุงู

### 3. ุชุญุณููุงุช ุทูููุฉ ุงููุฏู (12 ุดูุฑ)

- [ ] ุฏุนู ุงูุจุญุซ ุงูุตูุชู
- [ ] ุฅุถุงูุฉ ุฐูุงุก ุงุตุทูุงุนู ูุชุญุณูู ุงูุงุณุชุนูุงูุงุช
- [ ] ุฏุนู ุงูุจุญุซ ูู ุงูููุฏูู
- [ ] ุชุทููุฑ ูุธุงู ุชูุตูุงุช ุฐูู

---

## ๐ ุงููุฑุงุฌุน ูุงูุฑูุงุจุท

- [Qdrant Documentation](https://qdrant.tech/documentation/)
- [Sentence Transformers](https://www.sbert.net/)
- [MongoDB Vector Search](https://www.mongodb.com/products/platform/atlas-vector-search)
- [FastAPI Documentation](https://fastapi.tiangolo.com/)
- [NestJS Documentation](https://nestjs.com/)

---

_ุขุฎุฑ ุชุญุฏูุซ: ุฏูุณูุจุฑ 2024_
_ุงูุฅุตุฏุงุฑ: 1.0.0_
