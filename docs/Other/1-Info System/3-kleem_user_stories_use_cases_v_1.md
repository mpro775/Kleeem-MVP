# Kleem — User Stories & Use Cases (v1.1)

**التاريخ:** 17 سبتمبر 2025  
**نطاق:** V1 → V1.2 وفق وثيقتي الرؤية وSRS الإصدار 1.1  

> الهدف: توفير قصص مستخدم وسيناريوهات استخدام واقعية وقابلة للاختبار، مرتبطة بمعايير قبول واضحة (Gherkin)، وخريطة تتبّع إلى متطلبات SRS.

---

## 0) الشخصيات (Personas)
- **مالك المتجر (Admin)**: يهيّئ القنوات، يخصّص الودجت، يدير المعرفة، يطالع التحليلات.
- **مشغّل الدعم (Agent)**: يتابع المحادثات من الـ Inbox، يسلّم الطلبات المعقّدة، يعلّم النظام عبر التقييم.
- **محلل النمو (Analyst)**: يعاين مؤشرات الأداء ويستخرج الرؤى.
- **العميل النهائي (Shopper)**: يتحدث مع Kleem عبر القنوات، يستعلم عن المنتجات/السياسات، يكوّن نية شراء.

---

## 1) خريطة الإبيكس (Epics) وربطها بـ SRS
| Epic | الوصف | متطلبات SRS ذات الصلة | الأولوية |
|---|---|---|---|
| EP-CHAN | إدارة القنوات وInbox موحّد | CHAN-001/002, WIDG-001, ORD-001 | Must |
| EP-AI | الذكاء والـ Intent/RAG | AI-001/002/003/004, PROD-001/002/003, KB-003 | Must |
| EP-KB | إدارة المعرفة والاستيراد | KB-001/002/004 | Must |
| EP-STF | المتجر المصغّر + Chat-to-Buy | STF-001/002/003 | Should |
| EP-AN | التحليلات والتقارير | AN-001/002/003 | Must |
| EP-AUTH | المصادقة/الأدوار/MFA | AUTH-001/002/003 | Must |
| EP-MEDIA | OCR/ASR | MEDIA-001/002/003 | Should |

> المبدأ: نبدأ بـ Must للإطلاق، ثم Should خلال V1.1/V1.2.

---

## 2) قصص المستخدم (User Stories)
> الصياغة: كـ [نوع المستخدم] أريد [هدف] لكي [قيمة]  
> كل قصة تحتوي معايير قبول **Given/When/Then**.

### 2.1 EP-AUTH — المصادقة والأدوار
**US-AUTH-01** — تسجيل الدخول بالبريد/كلمة المرور  
- كـ **Admin/Agent** أريد تسجيل الدخول لكي أصل للوحة التحكم.
- **AC (Gherkin):**  
  ```gherkin
  Scenario: نجاح تسجيل الدخول
  Given حساب صالح بالبريد وكلمة المرور
  When أرسل الطلب إلى /auth/login
  Then أتلقى رمز JWT صالحًا وسجل جلسة مفعّل
  And يتم تطبيق سياسة القفل بعد خمول X دقائق
  ```

**US-AUTH-02** — أدوار وصلاحيات  
- كـ **Admin** أريد تحديد صلاحيات Agent/Analyst لكي أضمن التحكم بالوصول.
- **AC:** منع الوصول لنقاط نهاية خارج الدور، تسجيل محاولات الرفض.

**US-AUTH-03** — MFA اختياري  
- كـ **Admin** أريد تفعيل MFA لحسابي لزيادة الأمان.  
- **AC:** عند التفعيل يُطلب رمز ثاني عامل عند كل تسجيل دخول.

---

### 2.2 EP-CHAN — القنوات والInbox الموحّد
**US-CHAN-01** — ربط واتساب Cloud API  
- كـ **Admin** أريد ربط رقم واتساب عبر Cloud API لكي أتلقى الرسائل في Kleem.
- **AC:** حفظ Webhook/Token بنجاح، استقبال رسالة اختبار في الـ Inbox.

**US-CHAN-02** — ربط تيليغرام بوت  
- كـ **Admin** أريد ربط توكن بوت تيليغرام لكي يدعم القناة.
- **AC:** اختبار اتصال ناجح، ظهور قناة "Telegram" في الفلاتر.

**US-CHAN-03** — ودجت الويب الشات  
- كـ **Admin** أريد توليد كود تضمين الودجت مع تخصيص الألوان/الشعار/اللغة.
- **AC:** زر معاينة حيّة، وسوم RTL/LTR صحيحة، كود Script جاهز للنسخ.

**US-CHAN-04** — Inbox موحّد مع فلاتر  
- كـ **Agent** أريد رؤية جميع المحادثات عبر القنوات بفلاتر حالة/قناة/عميل.
- **AC:** بحث نصي/زمني، مؤشرات حالة الكتابة/التسليم، إشعارات فورية.

**US-CHAN-05** — تسليم إلى بشري (Handoff)  
- كـ **Agent** أريد استلام محادثة تصعيد عندما يفشل الذكاء.
- **AC:** تغيير مالك المحادثة إلى Agent، إيقاف ردود البوت مؤقتًا.

---

### 2.3 EP-AI — الذكاء والنيّة والحقائق
**US-AI-01** — Intent-first Routing  
- كـ **Shopper** عندما أسأل عن منتج، أريد أن يفهم Kleem نيّتي ويستدعي البحث الدلالي.
- **AC:** إذا كانت النيّة "منتج" يجب استدعاء PROD قبل الرد.

**US-AI-02** — RAG للمنتجات قبل الرد  
- كـ **Shopper** أريد إجابات مبنية على بيانات حقيقية (اسم/سعر/رابط/بدائل).
- **AC:** منع أي رد منتج إن فشل استدعاء أداة الحقيقة (PROD).

**US-AI-03** — نصيحة تدريب عند الإبهام  
- كـ **Admin** أريد أن أسجّل الأسئلة غير المجابة تلقائيًا لتدريب المعرفة.
- **AC:** إنشاء سجل missing_response مع نص السؤال وتحليل السبب.

**US-AI-04** — نبرة مخصّصة للتاجر  
- كـ **Admin** أريد تخصيص نبرة الرد (ودية/رسمية) ليطابق الهوية.
- **AC:** تُحترم النبرة في ≥90% من الردود وفق اختبار لغوي.

---

### 2.4 EP-PROD — البحث الدلالي على المنتجات
**US-PROD-01** — استعلام دلالي وإظهار النتائج  
- كـ **Shopper** أريد نتائج تحتوي اسم/سعر/رابط للمنتج.
- **AC:** ≥ منتج واحد أو رسالة عدم توفر + بدائل 3 على الأقل عندما توجد.

**US-PROD-02** — أسئلة استكشافية ("وش عندكم؟")  
- كـ **Shopper** أريد قائمة أقسام رئيسية لأبدأ التصفّح.
- **AC:** إرجاع أقسام قابلة للنقر/المتابعة.

**US-PROD-03** — مسارات فشل واضحة  
- كـ **Shopper** عند عدم وجود نتائج، أريد رسالة واضحة مع اقتراحات تحسين البحث.
- **AC:** عرض أمثلة لعبارات بديلة وتسجيل الحدث تحليليًا.

---

### 2.5 EP-KB — إدارة المعرفة
**US-KB-01** — استيراد ملفات ومعاينة الاستخراج  
- كـ **Admin** أريد رفع Word/Excel/PDF والروابط وإدارة FAQs.
- **AC:** معاينة النص المستخرج، إمكانية تعديل العناوين/الأقسام.

**US-KB-02** — مراجعة قبل النشر (Approval)  
- كـ **Admin** أريد Workflow موافقة قبل نشر مقال معرفة.
- **AC:** حالات (Draft → Review → Published) مع سجل مراجعات.

**US-KB-03** — بحث دلالي داخل المعرفة  
- كـ **Agent/Shopper** أريد إجابات سياسات مختصرة مع رابط المصدر.
- **AC:** ذكر المقال/القسم المصدر في الرد (عند الإمكان).

---

### 2.6 EP-STF — المتجر المصغّر
**US-STF-01** — استعراض كتالوج بفلترة أساسية  
- كـ **Shopper** أريد تصفح القائمة/التفاصيل بثيم المتجر.
- **AC:** فلترة بالنوع/السعر/التصنيف، سرعة تحميل ≤ 2 ث.

**US-STF-02** — Chat-to-Buy  
- كـ **Shopper** عند الضغط على "الدردشة للشراء" يفتح القناة ويمرر سياق المنتج.
- **AC:** تمرير معرف المنتج/الرابط، تسجيل Order Intent.

**US-STF-03** — تسجيل نية الشراء  
- كـ **Admin** أريد لوحة نوايا شراء مرتبطة بالعملاء.
- **AC:** عرض المصدر/التاريخ/المنتج، فلاتر وتحليلات أساسية.

---

### 2.7 EP-AN — التحليلات
**US-AN-01** — لوحة مؤشرات أساسية  
- كـ **Admin/Analyst** أريد لوحة تعرض الرضا/الحل الذاتي/الزمن/القنوات.
- **AC:** فلاتر زمنية (يومي/أسبوعي/شهري) وتصدير CSV/PDF.

**US-AN-02** — قائمة الأسئلة غير المجابة  
- كـ **Admin** أريد قائمة بالمفقودات لتغذيتها في المعرفة.
- **AC:** تعيين مسؤول وتتبّع الإغلاق خلال ≤ 24 ساعة.

---

## 3) سيناريوهات استخدام (Use Cases) — سردي مختصر

### UC-01 — استعلام منتج وتحويل للموقع
- **الممثل:** Shopper  
- **المسار الأساسي:** يرسل سؤال → النظام يفهم النيّة (منتج) → يستدعي PROD → يعرض 3 نتائج ببيانات (اسم/سعر/رابط) → المستخدم يضغط نتيجة → تُسجّل نية شراء.  
- **مسارات بديلة:** لا نتائج → اقتراح بدائل/تحسين صياغة → تسجيل missing_response إذا التباس.

### UC-02 — سؤال سياسة شحن
- **الممثل:** Shopper  
- **المسار الأساسي:** يسأل عن الشحن → بحث دلالي على KB → رد مختصر + رابط قسم السياسة.  
- **بديل:** لا مقال مناسب → تسجيل missing_response → إشعار Admin.

### UC-03 — تسليم إلى Agent
- **الممثل:** Agent  
- **المسار:** فشل الذكاء/تقييم سلبي → إشعار الـ Inbox → Agent يستلم المحادثة → يتابع يدويًا.

### UC-04 — تدريب المعرفة من المفقودات
- **الممثل:** Admin  
- **المسار:** يعاين قائمة missing_response → ينشئ/يعدّل مقال → يمر Workflow الموافقة → النشر.

---

## 4) معايير القبول غير الوظيفية (NFR Acceptance)
- **الأداء:** زمن رد AI ≤ 5 ث في المتوسط (P95 ≤ 8 ث)، واجهة ≤ 2 ث (P95 ≤ 3 ث).  
- **الاعتمادية:** SLA شهري ≥ 99.9%، RTO ≤ 4h، RPO ≤ 1h.  
- **الأمان:** تفعيل HTTPS/HSTS/CSP، JWT+RBAC، Secrets مخزّنة آمنًا، Audit Logs.  
- **المراقبة:** مقاييس Prometheus (HTTP/DB/Cache/Business)، لوحات Grafana، تنبيهات.  
- **الخصوصية:** Right-to-be-forgotten، إخفاء PII في السجلات، تصدير بيانات العميل.  
- **i18n/a11y:** دعم ar/en، RTL، WCAG 2.1 للمكوّنات الرئيسية.

---

## 5) تتبّع المتطلبات (Traceability Matrix)
| Story/Use Case | متطلبات SRS | ملاحظات |
|---|---|---|
| US-CHAN-01/02/03/04/05 | CHAN-001/002, WIDG-001, ORD-001 | ربط قنوات + Inbox + Handoff |
| US-AI-01/02/03/04 | AI-001/002/003/004, PROD-001/002/003, KB-003 | Intent/RAG/نبرة/مفقودات |
| US-KB-01/02/03 | KB-001/002/003/004 | إدارة المعرفة + Workflow |
| US-PROD-01/02/03 | PROD-001/002/003 | بحث منتجات/بدائل/فشل |
| US-STF-01/02/03 | STF-001/002/003 | كتالوج + Chat-to-Buy + نوايا |
| US-AN-01/02 | AN-001/002/003 | لوحات/تذكير مفقودات |
| US-AUTH-* | AUTH-001/002/003/004 | Login/Roles/MFA/SSO |

---

## 6) تعريف الإنجاز (Definition of Done)
- استيفاء معايير القبول (Functional + NFR).  
- تغطية اختبارات وحدة ≥ 70% (هدف الإطلاق)، وتخطيط للوصول إلى 85%.  
- اختبارات تكامل + E2E (Playwright) على المسارات الحرجة.  
- توثيق REST (Swagger) محدث، وRunbooks مختصرة للحوادث.  
- لوحات Grafana تحتوي لوحات الميزة الجديدة (HTTP/DB/Cache + Business KPIs).

---

## 7) بيانات اختبار (Test Data) — مقترح أولي
- **تاجر تجريبي:** merchantId=demo-001، لغات ar/en، ألوان أساسية.  
- **كتالوج:** 50 منتجًا بفئات متنوعة، 10 غير متوفرة لتجربة البدائل.  
- **معرفة:** 8 مقالات سياسات (شحن، إرجاع، دفع)، 15 سؤالاً شائعًا.  
- **عملاء:** 20 عميلًا افتراضيًا مع سجل محادثات قصير.  
- **قنوات:** واتساب Sandbox، تيليغرام Bot، ودجت مضمّن على صفحة اختبار.

---

## 8) الحواف والحالات الاستثنائية (Edge Cases)
- نص عام جدًا ("مرحبا") → رد ترحيبي + اقتراحات.
- صور بدون نص مقروء → مسار فشل OCR + نص بديل.
- بطء في موفّر خارجي (WhatsApp/Shopify) → مهلة زمنية + رسالة اعتذارية + تسجيل.
- اختلاف لهجي/أخطاء إملائية جسيمة → تصحيح هجائي مبدئي ثم Intent.
- تعارض دور/صلاحية → 403 ورسالة واضحة، مع تسجيل الحدث.

---

## 9) خطة التقسيم (Release Slicing)
- **Sprint 1:** AUTH + ربط تيليغرام + Inbox بسيط.
- **Sprint 2:** RAG منتجات + Intent + ودجت تضمين.
- **Sprint 3:** KB استيراد + موافقات + أسئلة سياسات.
- **Sprint 4:** متجر مصغّر + Chat-to-Buy + Order Intent.
- **Sprint 5:** تحليلات أساسية + Missing Responses + تنبيهات.
- **Sprint 6 (Hardening):** NFR/أمان/مراقبة + UAT.

---

## 10) ملاحظات التنفيذ
- استخدام Feature Flags لتفعيل القنوات على مراحل.  
- حفظ مفاتيح القنوات في Secret Manager/Env آمن.  
- بناء مقاييس Prometheus لكل Epic (http_request_duration_seconds, cache_hit/miss, business_*).  
- إضافة لوحات Grafana لكل قناة ومسار AI.

