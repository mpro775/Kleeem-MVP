# Kaleem AI — نظرة عامة على النظام
*آخر تحديث: 2025-09-27 00:26*

> **ملف موجز (صفحة–صفحتين)** يشرح الصورة الكبيرة للنظام بحيث يستطيع أي عضو (هندسة/منتج/SRE/أمن) فهم كيف يعمل Kaleem بسرعة وأين يغوص في التفاصيل لاحقًا (API Docs، Runbooks، ERD…).

---

## 1) Purpose & Scope
**Kaleem AI** منصة SaaS متعددة المستأجرين تساعد التجار على تشغيل التجارة/المحادثات الذكية عبر قنوات متعددة (Webchat، Telegram، WhatsApp Cloud، Instagram، Messenger) مع بحث دلالي، توصيات، وأتمتة خدمة العملاء.
يغطي هذا المستند: نظرة معمارية عالية المستوى، التدفقات الرئيسة، النشر والتشغيل، الأمان، المراقبة، والتكاملات.

## 2) Personas & Top Use Cases
- **التاجر/صاحب المتجر**: إدارة القنوات، إعداد المتجر، تحميل المنتجات، تتبع المحادثات والطلبات.
- **العميل النهائي**: محادثة مع البوت للعثور على المنتجات، الاستفسارات، إنشاء الطلب/السلة.
- **فريق التشغيل/SRE/الأمن**: تشغيل المنظومة، المراقبة، الاستجابة للحوادث، إدارة الأسرار والصلاحيات.

**3 سيناريوهات عليا**
1) عميل يسأل عن منتج → البوت يستدعي بحثًا دلاليًا → يعرض منتجات متوافقة ويقود إلى طلب/سلة.
2) استفسار سياسات المتجر (الشحن/الاستبدال) → البوت يجلب سياق المتجر ويجيب آليًا.
3) حدث خارجي (Webhook) من قناة/متجر → يُعالج عبر الـ Worker وينعكس على المحادثة واللوحة.

## 3) Value & KPIs
**القيمة**: تقليل زمن الرد، رفع دقة الإجابة والتحويلات، توحيد القنوات، وأتمتة متقدمة بذكاء.
**مؤشرات رئيسية (عينات مقترحة)**:
- تغطية إجابات البوت (Answer Coverage) ≥ 85%، ودقة مفهومية ≥ 90% للسياسات المتكررة.
- زمن أول رد للعميل (FRT) ≤ 2s عبر القنوات الشائعة.
- نسبة تحويل محادثة→طلب ≥ 3–5% (للمتاجر النشطة).
- التوافر الشهري لمنصة الـ API ≥ 99.9%، ونجاح Webhooks ≥ 99%.
- Hit Ratio للكاش: L1 ≥ 40%، L2 (Redis) ≥ 80% للقراءات الساخنة.

## 4) البنية المعمارية عالية المستوى (C4)
**المكونات الرئيسية:**
- **API (NestJS)**: واجهات REST/GraphQL، مصادقة JWT، حماية التوقيعات، Idempotency Guard.
- **Workers**: معالجة المهام غير المتزامنة (Webhooks، Embeddings، رسائل، Outbox).
- **قواعد البيانات**:
  - **MongoDB** (المخزن الأساسي متعدد المستأجرين باستخدام `merchantId`).
  - **Qdrant** (قاعدة بيانات المتجهات للبحث الدلالي).
  - **Redis** (التخزين المؤقت، الجلسات، قوائم الانتظار).
- **تخزين الملفات**: **MinIO** للصور والوثائق.
- **أدوات الأتمتة**: **n8n** للعمليات والتدفقات.
- **الواجهات الأمامية**:
  - **لوحة تحكم التاجر** (React/Vite) للإدارة والتحليلات.
  - **Webchat** للتفاعل مع العملاء.
- **البوابة**: **Nginx** (TLS، عكس Proxy، ضغط).

**التكاملات الخارجية**: Telegram، WhatsApp Business، Instagram، Facebook Messenger، منصات التجارة (Salla، Zid، Shopify).

## 5) تدفقات الطلبات والأحداث
**المتزامنة (قراءة/كتابة):**
- عميل → قناة → API → كاش/قاعدة بيانات → رد فوري.
- مفتاح Idempotency للعمليات الحساسة (الطلبات، المدفوعات).

**غير المتزامنة (Webhooks/قوائم الانتظار):**
- Webhook من قناة → API (تحقق التوقيع) → قائمة انتظار → Worker.
- **Outbox Pattern** لضمان إرسال الأحداث + إعادة المحاولة مع Backoff + DLQ.
- **Cache Warmer** للمفاتيح الساخنة والتحديثات التلقائية.

## 6) نموذج البيانات الأساسي
- **مفتاح التعددية**: `merchantId` على جميع الكيانات الرئيسية.
- **الكيانات الأساسية**: Merchant، Channel، Product، Category، Order، Lead، Conversation، Message، WebhookEvent، OutboxEvent.
- **الفهارس الحرجة**:
  - `products(tenantId, status, categoryId, price, createdAt)`
  - `orders(tenantId, status, customerId, createdAt)`
  - فهارس نصية ومتجهية في MongoDB و Qdrant.
- **الاتساق النهائي** للمشتقات (العدادات، البيانات المُحسنة) عبر Workers.

## 7) النشر والبيئات
- **البيئات**: development، staging، production (فصل صارم للمتغيرات البيئية).
- **الاستضافة**: Docker Compose على VPS مع إمكانية التوسع لـ Kubernetes.
- **استراتيجية الإصدار**: صور مُسماة بالإصدار (SemVer)، ترقية تدريجية، Rollback عبر الوسوم السابقة، هجرة قاعدة البيانات الآمنة.

## 8) Availability & Performance
- **SLO API**: التوافر 99.9% شهريًا؛ **p95 latency** للقراءة ≤ 300ms، للكتابة ≤ 500ms.
- **SLO Bot**: **TTFR** ≤ 2s، اكتمال المهام غير المتزامنة ≤ 60s.
- **التوسّع**: Scale‑out لـ API/Workers، Read‑replica/Shard لِـ Mongo/Qdrant عند الحاجة، Redis Cluster عند الحمل العالي.
- **الأداء**: Pagination مع Cursor، كاش L1 (ذاكرة) + L2 (Redis)، تخفيف N+1، واستخدام Pooling مضبوط للاتصالات.

## 9) الأمان والامتثال
- **المصادقة/التفويض**: JWT قصير + Refresh مُدور + Redis Blacklist، RBAC للأدوار.
- **حماية الحدود**: CORS، Helmet، Rate Limiting، حدود حجم الطلب، حماية توقيعات Webhook، Service Token Guard.
- **البيانات**: TLS، تشفير البيانات الحساسة، مبدأ الأقل صلاحية، إدارة الأسرار (Vault في الإنتاج).
- **التدقيق**: سجلات شاملة للأحداث الحساسة (تسجيل دخول، تغييرات، إعدادات المتجر).

## 10) Observability & Operations
- **المقاييس**: Prometheus (HTTP، قواعد البيانات، الكاش، قوائم الانتظار، KPIs الأعمال).
- **السجلات**: Pino → Loki مع تتبع مُرتبط.
- **التتبع**: OpenTelemetry → Tempo.
- **لوحات المراقبة**: Grafana + Alertmanager (Error Rate، Latency، Queue Backlog، Cache Hit Ratio).
- **Runbooks**: إرشادات لكل خدمة (API، Workers، قواعد البيانات، النشر، الحوادث).
- **الاختبارات**: فحوصات صحة دورية + اختبارات E2E (Playwright) للمسارات الحرجة.

## 11) التكاملات الخارجية
- **قنوات المراسلة**: Rate Limits لكل مزود، Circuit Breaker، DLQ للفشل.
- **منصات التجارة**: مزامنة الكتالوج والطلبات، Webhooks، حقل Idempotency.
- **خدمات الذكاء الاصطناعي**: Embedding/LLM مع Budget وحراسة المخرجات.

## 12) المخاطر والحدود + الحلول
- **نقطة فشل واحدة (VPS)** → High Availability عبر العقد المتعددة + نسخ احتياطي + فحوصات الصحة.
- **نمو المتجهات** → سياسات TTL، شاردنج Qdrant، مراقبة الذاكرة/التخزين.
- **قيود مزودي القنوات** → Circuit Breaker، DLQ، مسارات بديلة يدوية.
- **جودة المعرفة** → أدوات تدريب التاجر، تحليل فجوات الإجابات، اقتراحات التحسين.

## 13) المصطلحات
- **Tenant**: مستأجر (تاجر) مستقل داخل المنصة.
- **L1/L2 Cache**: التخزين المؤقت المحلي/Redis لتحسين الأداء.
- **Outbox Pattern**: تخزين الأحداث قبل النشر لضمان الموثوقية.
- **DLQ**: قائمة انتظار للرسائل الفاشلة.
- **Idempotency**: ضمان تنفيذ العملية مرة واحدة.
- **Cursor Pagination**: ترقيم صفحات مُحسن للأداء.
- **SLO/SLI/SLA**: أهداف/مؤشرات/اتفاقيات مستوى الخدمة.
- **TTFR**: زمن أول رد من البوت.

---

**الروابط المرجعية:**
- API Docs & OpenAPI (الواجهات العامة والخاصة)
- Runbooks (التشغيل، الحوادث، الاسترجاع، النسخ الاحتياطي، الترقيات)
- ERD & Data Dictionary
- Dashboards (Grafana) & Alerting Rules
- Security Playbooks & Compliance Notes

