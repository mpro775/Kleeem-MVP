# ูุฑู ููู ูุธุงู ูููู ุงูุฐูู - ูุธุงู ูููู ุงูุดุงูู

## ูุธุฑุฉ ุนุงูุฉ ุนูู ุงููุธุงู

ูุธุงู ูููู ูู ููุตุฉ ุฐูุงุก ุงุตุทูุงุนู ูุชูุงููุฉ ูุฎุฏูุฉ ุงูุนููุงุก ูุน ุฅููุงููุงุช ูุชูุฏูุฉ:

- **ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุงููุชูุฏู**: ุชูุงูู ูุน n8n ู Google Gemini
- **ุฅุฏุงุฑุฉ ุงููุญุงุฏุซุงุช**: ุฌูุณุงุช ุฐููุฉ ูุน ุชุชุจุน ุงูุณูุงู
- **ุชุญููู ุงูููุฉ**: ูุดู ููุงูุง ุงูุนููุงุก ุชููุงุฆูุงู
- **ูุธุงู Call-to-Action**: ุงูุชุฑุงุญุงุช ุฐููุฉ ููุนููุงุก
- **ูุงุนุฏุฉ ุงููุนุฑูุฉ**: ุฃุณุฆูุฉ ุดุงุฆุนุฉ ูุจูุช ูุงูู
- **ุงูุชุนูู ุงููุณุชูุฑ**: ุชุญุณูู ุงูุจูุช ูู ุฎูุงู ุงูุชุบุฐูุฉ ุงูุฑุงุฌุนุฉ ุงูุณูุจูุฉ โ (ูุทุจู ุญุงููุงู)
- **ุงูุชุนูู ูู ุงููุฌุงุญุงุช**: ููุฑุณุฉ ุงูุฑุฏูุฏ ุงูุฌูุฏุฉ ูู Qdrant ๐ง (ูุฎุทุท ูุณุชูุจูู)
- **ุงูุชูุงูู ุงููุชุนุฏุฏ**: ูููุงุช ูุชุนุฏุฏุฉ (ูุงุชุณุงุจุ ุชููุฌุฑุงูุ ููุจ ุดุงุช)

## 1. ูุฎุทุท ุงูุชุฏูู ุงูุนุงู (Flowchart)

```mermaid
graph TD
    A[ุชููู ุฑุณุงูุฉ ุงูุนููู] --> B[ุชุญููู ุงูููุฉ<br/>Intent Analysis]
    B --> C[ูุญุต ุงูุณูุงู<br/>Context Check]
    C --> D[ุงูุจุญุซ ูู ุงููุนุฑูุฉ<br/>Knowledge Base Search]

    D --> E{ูู ููุฌุฏ ุฅุฌุงุจุฉ ูู ุงูุฃุณุฆูุฉ ุงูุดุงุฆุนุฉุ}
    E -->|ูุนู| F[ุฅุฑุฌุงุน ุงูุฅุฌุงุจุฉ<br/>ูู ุงูุฃุณุฆูุฉ ุงูุดุงุฆุนุฉ]
    E -->|ูุง| G[ุชูููุถ ููุฐูุงุก ุงูุงุตุทูุงุนู<br/>n8n Workflow]

    G --> H[ูุนุงูุฌุฉ ุงูุฑุณุงูุฉ<br/>ุจุงุณุชุฎุฏุงู Gemini]
    H --> I[ุชุทุจูู ุงูุชุนูููุงุช<br/>Custom Instructions]
    I --> J[ุชูููุฏ ุงูุฑุฏ<br/>AI Response]

    J --> K[ูุญุต ุฌูุฏุฉ ุงูุฑุฏ<br/>Response Quality Check]
    K --> L{ุงูุฌูุฏุฉ ููุจููุฉุ}
    L -->|ูุนู| M[ุฅุฑุณุงู ุงูุฑุฏ<br/>ููุนููู]
    L -->|ูุง| N[ุชุญุณูู ุงูุฑุฏ<br/>Response Enhancement]

    M --> O[ุนุฑุถ ุฎูุงุฑุงุช ุงูุชูููู<br/>Rating Options]
    O --> P[ุงูุชุธุงุฑ ุชูููู ุงูุนููู<br/>Customer Feedback]

    P --> Q{ููุน ุงูุชูููู}
    Q -->|ุฅูุฌุงุจู ๐| R[ุญูุธ ุงูุชูููู ุงูุฅูุฌุงุจู<br/>ุฒูุงุฏุฉ ุงูุซูุฉ]
    Q -->|ุณูุจู ๐| S[ุญูุธ ุงูุชูููู ุงูุณูุจู<br/>ุชุญููู ุงููุดููุฉ]

    S --> T[ุฅูุดุงุก ุชุนูููุงุช ุฌุฏูุฏุฉ<br/>ูู ุงูุฑุฏ ุงูุณูุจู]
    T --> U[ุชุญุฏูุซ ุงูุจุฑููุจุช<br/>Prompt Enhancement]
    U --> V[ุฅุนุงุฏุฉ ุชุฏุฑูุจ ุงูุจูุช<br/>Model Retraining]

    R --> W[ุญุงูุฉ ุงูุชูููู ุงูุฅูุฌุงุจู<br/>ููุฎุทุท ููุชุทุจูู ูุณุชูุจูุงู]
    W --> X[ุชุฌุงูู ุงูุฑุฏ ุญุงููุงู<br/>ุณูุชู ุชุทุจูู ุงูููุฑุณุฉ ูุณุชูุจูุงู]

    BB[ุงูุชุฑุงุญ Call-to-Action] --> CC[ูุญุต ุงูููุฉ ุงูุนุงููุฉ<br/>High Intent Check]
    CC --> DD{ููุฉ ุนุงููุฉุ}
    DD -->|ูุนู| EE[ุนุฑุถ CTA ููุงุณุจ<br/>ููุนููู]
    DD -->|ูุง| FF[ูุชุงุจุนุฉ ุงููุญุงุฏุซุฉ<br/>Continue Conversation]

    EE --> GG[ุชุชุจุน ุชูุงุนู ุงูุนููู<br/>CTA Interaction Tracking]
    GG --> HH[ุชุญุณูู ุงูุชุฑุงุญุงุช CTA<br/>CTA Optimization]
```

## 2. ูุฎุทุท ุงูุชุณูุณู (Sequence Diagram)

```mermaid
sequenceDiagram
    participant C as Customer
    participant W as Website/Widget
    participant WS as WebSocket Gateway
    participant K as Kleem Chat Service
    participant IS as Intent Service
    participant VS as Vector Service
    participant N8N as n8n Workflow
    participant AI as Gemini AI
    participant DB as Database
    participant AN as Analytics

    Note over C,W: ุจุฏุก ุงููุญุงุฏุซุฉ
    C->>W: ุฅุฑุณุงู ุฑุณุงูุฉ ุฃููู
    W->>WS: WebSocket connection
    WS->>K: ุฅูุดุงุก ุฌูุณุฉ ุฌุฏูุฏุฉ

    Note over K: ุชุญููู ุงูููุฉ ูุงูุณูุงู
    K->>IS: ุชุญููู ููุฉ ุงูุฑุณุงูุฉ
    IS-->>K: ูุชูุฌุฉ ุงูุชุญููู
    K->>VS: ุงูุจุญุซ ูู ุงููุนุฑูุฉ ุงููุชุฌููุฉ
    VS-->>K: ูุชุงุฆุฌ ุงูุจุญุซ

    alt ุฅุฌุงุจุฉ ููุฌูุฏุฉ ูู ุงููุนุฑูุฉ
        K->>DB: ุงุณุชุฑุฌุงุน ุงูุฅุฌุงุจุฉ
        DB-->>K: ุงููุญุชูู ุงููุทุงุจู
        K->>W: ุฅุฑุณุงู ุงูุฅุฌุงุจุฉ ุงููุจุงุดุฑุฉ
        W-->>C: ุนุฑุถ ุงูุฅุฌุงุจุฉ
    else ูุง ุชูุฌุฏ ุฅุฌุงุจุฉ
        Note over K,N8N: ุชูููุถ ููุฐูุงุก ุงูุงุตุทูุงุนู
        K->>N8N: ุฅุฑุณุงู ุงูุฑุณุงูุฉ ูููุนุงูุฌุฉ
        N8N->>AI: ุงุณุชุฏุนุงุก Gemini AI
        AI-->>N8N: ุฑุฏ ุงูุฐูุงุก ุงูุงุตุทูุงุนู
        N8N-->>K: ุงูุฑุฏ ุงููุนุงูุฌ

        Note over K: ุชุทุจูู ุงูุชุฎุตูุตุงุช
        K->>K: ุชุทุจูู ุงูุชุนูููุงุช ุงููุฎุตุตุฉ
        K->>K: ุชูุณูู ุงูุฑุฏ ุงูููุงุฆู

        Note over K,W: ุฅุฑุณุงู ุงูุฑุฏ
        K->>W: ุฅุฑุณุงู ุงูุฑุฏ ููุนููู
        W-->>C: ุนุฑุถ ุงูุฑุฏ

        Note over K,DB: ุญูุธ ุงููุญุงุฏุซุฉ
        K->>DB: ุญูุธ ุงูุฑุณุงูุฉ ูุงูุฑุฏ
        DB-->>K: ุชุฃููุฏ ุงูุญูุธ
    end

    Note over W,C: ุชูููู ุงูุฑุฏ
    W->>C: ุนุฑุถ ุฎูุงุฑุงุช ุงูุชูููู
    C->>W: ุชูููู ุงูุฑุฏ (๐/๐ + ุชุนููู)

    Note over W,K: ุญูุธ ุงูุชูููู
    W->>K: ุฅุฑุณุงู ุงูุชูููู
    K->>DB: ุญูุธ ุงูุชูููู ูู ุงูุฑุณุงูุฉ

    alt ุชูููู ุฅูุฌุงุจู (ูุฎุทุท ูุณุชูุจูู)
        Note over K: ุญุงูุฉ ุงูุชูููู ุงูุฅูุฌุงุจู ูุน ุงูููุฑุณุฉ ุงููุชุฌููุฉ
        Note over K: ุณูุชู ุชูููุฐ ูุฐู ุงูููุฒุฉ ูุณุชูุจูุงู
    else ุชูููู ุณูุจู
        Note over K,AI: ุชุญุณูู ุงูุจูุช
        K->>AI: ุฅูุดุงุก ุชุนูููุงุช ูู ุงูุฑุฏ ุงูุณูุจู
        AI-->>K: ุชุนูููุงุช ุฌุฏูุฏุฉ
        K->>DB: ุญูุธ ุงูุชุนูููุงุช
        K->>N8N: ุชุญุฏูุซ ุงูุจุฑููุจุช
    end

    Note over AN: ุชุณุฌูู ุงูุชุญูููุงุช
    K->>AN: ุชุณุฌูู ุชูุงุนู ุงููุณุชุฎุฏู
    AN-->>K: ุชุฃููุฏ ุงูุชุณุฌูู
```

## 3. ุขูุฉ ุงูุญุงูุงุช (State Machine)

```mermaid
stateDiagram-v2
    [*] --> ุฌูุณุฉ_ุฌุฏูุฏุฉ: ุจุฏุก ูุญุงุฏุซุฉ ุฌุฏูุฏุฉ

    ุฌูุณุฉ_ุฌุฏูุฏุฉ --> ุชุญููู_ุงูููุฉ: ุชููู ุฑุณุงูุฉ ุฃููู
    ุชุญููู_ุงูููุฉ --> ูุญุต_ุงูุณูุงู: ุชุญููู ุงูุณูุงู
    ูุญุต_ุงูุณูุงู --> ุงูุจุญุซ_ูู_ุงููุนุฑูุฉ: ุงูุจุญุซ ูู Qdrant

    ุงูุจุญุซ_ูู_ุงููุนุฑูุฉ --> ุฅุฌุงุจุฉ_ููุฌูุฏุฉ: ุชู ุงูุนุซูุฑ ุนูู ุฅุฌุงุจุฉ
    ุงูุจุญุซ_ูู_ุงููุนุฑูุฉ --> ูุง_ุฅุฌุงุจุฉ: ูุง ุชูุฌุฏ ุฅุฌุงุจุฉ ูุทุงุจูุฉ

    ุฅุฌุงุจุฉ_ููุฌูุฏุฉ --> ุฅุฑุณุงู_ุงูุฅุฌุงุจุฉ: ุฅุฑุฌุงุน ุงููุชูุฌุฉ
    ูุง_ุฅุฌุงุจุฉ --> ุชูููุถ_ููุฐูุงุก: ุฅุฑุณุงู ูููุนุงูุฌุฉ

    ุชูููุถ_ููุฐูุงุก --> ูุนุงูุฌุฉ_n8n: ุงุณุชุฏุนุงุก workflow
    ูุนุงูุฌุฉ_n8n --> ุงุณุชุฏุนุงุก_Gemini: ุทูุจ ูู AI
    ุงุณุชุฏุนุงุก_Gemini --> ุชุทุจูู_ุงูุชุนูููุงุช: ุชุฎุตูุต ุงูุฑุฏ
    ุชุทุจูู_ุงูุชุนูููุงุช --> ุชูููุฏ_ุงูุฑุฏ: ุงูุฑุฏ ุงูููุงุฆู

    ุชูููุฏ_ุงูุฑุฏ --> ูุญุต_ุงูุฌูุฏุฉ: ุชูููู ุงูุฑุฏ
    ูุญุต_ุงูุฌูุฏุฉ --> ุฌูุฏุฉ_ุนุงููุฉ: ุฑุฏ ููุชุงุฒ
    ูุญุต_ุงูุฌูุฏุฉ --> ุฌูุฏุฉ_ุนุงุฏูุฉ: ุฑุฏ ููุจูู
    ูุญุต_ุงูุฌูุฏุฉ --> ุฌูุฏุฉ_ููุฎูุถุฉ: ุฑุฏ ุถุนูู

    ุฌูุฏุฉ_ุนุงููุฉ --> ุฅุฑุณุงู_ุงูุฑุฏ: ุนุฑุถ ูููุณุชุฎุฏู
    ุฌูุฏุฉ_ุนุงุฏูุฉ --> ุฅุฑุณุงู_ุงูุฑุฏ: ุนุฑุถ ูููุณุชุฎุฏู
    ุฌูุฏุฉ_ููุฎูุถุฉ --> ุชุญุณูู_ุงูุฑุฏ: ุฅุนุงุฏุฉ ุงูุตูุงุบุฉ

    ุฅุฑุณุงู_ุงูุฑุฏ --> ุนุฑุถ_ุงูุชูููู: ุฎูุงุฑุงุช ๐/๐
    ุนุฑุถ_ุงูุชูููู --> ุชููู_ุงูุชูููู: ูู ุงููุณุชุฎุฏู

    ุชููู_ุงูุชูููู --> ุชูููู_ุฅูุฌุงุจู: ๐
    ุชููู_ุงูุชูููู --> ุชูููู_ุณูุจู: ๐

    ุชูููู_ุฅูุฌุงุจู --> ุชุฌุงูู_ุญุงููุงู: ุณูุชู ุชุทุจูู ุงูููุฑุณุฉ ูุณุชูุจูุงู
    ุชูููู_ุณูุจู --> ุชุญููู_ุงููุดููุฉ: ุงุณุชุฎุฑุงุฌ ุงูุณุจุจ

    ุชุญููู_ุงููุดููุฉ --> ุฅูุดุงุก_ุชุนูููุงุช: ูู ุงูุฑุฏ ุงูุณูุจู
    ุฅูุดุงุก_ุชุนูููุงุช --> ุญูุธ_ุงูุชุนูููุงุช: ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
    ุญูุธ_ุงูุชุนูููุงุช --> ุชุญุฏูุซ_ุงูุจุฑููุจุช: ุฅุนุงุฏุฉ ุงูุจูุงุก

    ุชุฌุงูู_ุญุงููุงู --> ุชุญุณูู_ุงูุจูุช: ูุญุฏุซ
    ุชุญุฏูุซ_ุงูุจุฑููุจุช --> ุชุญุณูู_ุงูุจูุช: ูุญุฏุซ

    ุชุญุฏูุซ_ุงููุนุฑูุฉ --> ุงูุชุฑุงุญ_CTA: ูุญุต ุงูููุฉ
    ุชุญุณูู_ุงูุจูุช --> ุงูุชุฑุงุญ_CTA

    ุงูุชุฑุงุญ_CTA --> ูุญุต_ุงูููุฉ_ุงูุนุงููุฉ: high intent check
    ูุญุต_ุงูููุฉ_ุงูุนุงููุฉ --> ููุฉ_ุนุงููุฉ: ุนุฑุถ CTA
    ูุญุต_ุงูููุฉ_ุงูุนุงููุฉ --> ููุฉ_ุนุงุฏูุฉ: ูุชุงุจุนุฉ ุงููุญุงุฏุซุฉ

    ููุฉ_ุนุงููุฉ --> ุนุฑุถ_CTA: ุงูุชุฑุงุญ ุงูุนูู
    ููุฉ_ุนุงุฏูุฉ --> ุงุณุชูุฑุงุฑ_ุงููุญุงุฏุซุฉ: ูุชุงุจุนุฉ ุทุจูุนูุฉ

    ุนุฑุถ_CTA --> ุชุชุจุน_ุงูุชูุงุนู: ูุฑุงูุจุฉ ุงูุงุณุชุฌุงุจุฉ
    ุชุชุจุน_ุงูุชูุงุนู --> ุชุญุณูู_CTA: ุถุจุท ุงูุงูุชุฑุงุญุงุช

    ุชุญุณูู_CTA --> ุงุณุชูุฑุงุฑ_ุงููุญุงุฏุซุฉ
    ุงุณุชูุฑุงุฑ_ุงููุญุงุฏุซุฉ --> ุชููู_ุฑุณุงูุฉ_ุฌุฏูุฏุฉ: ุฏูุฑุฉ ุฌุฏูุฏุฉ

    ุชููู_ุฑุณุงูุฉ_ุฌุฏูุฏุฉ --> ุชุญููู_ุงูููุฉ: ุจุฏุงูุฉ ุงูุฏูุฑุฉ
```

### ุชุนุฑูู ุงูุญุงูุงุช

| ุงูุญุงูุฉ              | ุงููุตู                  | ุงูุฅุฌุฑุงุกุงุช ุงููุณููุญุฉ |
| ------------------- | ---------------------- | ------------------ |
| `ุฌูุณุฉ_ุฌุฏูุฏุฉ`        | ุจุฏุก ูุญุงุฏุซุฉ ุฌุฏูุฏุฉ       | ุฅูุดุงุก sessionId    |
| `ุชุญููู_ุงูููุฉ`       | ุชุญููู ููุฉ ุงูุฑุณุงูุฉ      | ูุดู ุงูููุงูุง        |
| `ูุญุต_ุงูุณูุงู`        | ูุญุต ุณูุงู ุงููุญุงุฏุซุฉ      | ุงุณุชุฑุฌุงุน ุงูุณูุงู     |
| `ุงูุจุญุซ_ูู_ุงููุนุฑูุฉ`  | ุงูุจุญุซ ูู ูุงุนุฏุฉ ุงููุนุฑูุฉ | ุงุณุชุนูุงู Qdrant     |
| `ุฅุฌุงุจุฉ_ููุฌูุฏุฉ`      | ุชู ุงูุนุซูุฑ ุนูู ุฅุฌุงุจุฉ    | ุฅุฑุฌุงุน ุงููุชูุฌุฉ      |
| `ูุง_ุฅุฌุงุจุฉ`          | ูุง ุชูุฌุฏ ุฅุฌุงุจุฉ ูุทุงุจูุฉ   | ุชูููุถ ููุฐูุงุก       |
| `ุชูููุถ_ููุฐูุงุก`      | ุฅุฑุณุงู ูููุนุงูุฌุฉ ุงูุฐููุฉ  | ุงุณุชุฏุนุงุก n8n        |
| `ูุนุงูุฌุฉ_n8n`        | ูุนุงูุฌุฉ ูู n8n          | ุงุณุชุฏุนุงุก Gemini     |
| `ุงุณุชุฏุนุงุก_Gemini`    | ุทูุจ ูู Gemini AI       | ุชูููุฏ ุงูุฑุฏ         |
| `ุชุทุจูู_ุงูุชุนูููุงุช`   | ุชุทุจูู ุงูุชุฎุตูุตุงุช        | ุชุฎุตูุต ุงูุฑุฏ         |
| `ุชูููุฏ_ุงูุฑุฏ`        | ุงูุฑุฏ ุงูููุงุฆู           | ุงูุฅุฌุงุจุฉ ุงูููุชููุฉ   |
| `ูุญุต_ุงูุฌูุฏุฉ`        | ุชูููู ุฌูุฏุฉ ุงูุฑุฏ        | ุชุตููู ุงูุฌูุฏุฉ       |
| `ุฌูุฏุฉ_ุนุงููุฉ`        | ุฑุฏ ููุชุงุฒ ุงูุฌูุฏุฉ        | ุฅุถุงูุฉ ูููุนุฑูุฉ      |
| `ุฌูุฏุฉ_ุนุงุฏูุฉ`        | ุฑุฏ ููุจูู               | ุนุฑุถ ูููุณุชุฎุฏู       |
| `ุฌูุฏุฉ_ููุฎูุถุฉ`       | ุฑุฏ ุถุนูู                | ุชุญุณูู ุงูุฑุฏ         |
| `ุฅุฑุณุงู_ุงูุฑุฏ`        | ุนุฑุถ ุงูุฑุฏ ูููุณุชุฎุฏู      | ุนุฑุถ ุงูุฅุฌุงุจุฉ        |
| `ุนุฑุถ_ุงูุชูููู`       | ุนุฑุถ ุฎูุงุฑุงุช ุงูุชูููู     | ๐/๐ options      |
| `ุชููู_ุงูุชูููู`      | ุชููู ุชูููู ุงููุณุชุฎุฏู    | ุญูุธ ุงูุชูููู        |
| `ุชูููู_ุฅูุฌุงุจู`      | ุชูููู ุฅูุฌุงุจู           | ุชุฌุงูู ุญุงููุงู       |
| `ุชูููู_ุณูุจู`        | ุชูููู ุณูุจู             | ุชุญููู ุงููุดููุฉ      |
| `ุชุฌุงูู_ุญุงููุงู`       | ุนุฏู ุชุทุจูู ุงูููุฑุณุฉ ุญุงููุงู | ุงูุชุธุงุฑ ุงูุชุทููุฑ ุงููุณุชูุจูู |
| `ุชุญููู_ุงููุดููุฉ`     | ุชุญููู ุณุจุจ ุงููุดููุฉ      | ุงุณุชุฎุฑุงุฌ ุงูุฃุฎุทุงุก    |
| `ุฅูุดุงุก_ุชุนูููุงุช`     | ุฅูุดุงุก ุชุนูููุงุช ุฌุฏูุฏุฉ    | ูู ุงูุชููููุงุช ุงูุณูุจูุฉ |
| `ุญูุธ_ุงูุชุนูููุงุช`     | ุญูุธ ุงูุชุนูููุงุช          | ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช  |
| `ุชุญุฏูุซ_ุงูุจุฑููุจุช`    | ุชุญุฏูุซ prompt ุงูุจูุช     | ุฅุนุงุฏุฉ ุงูุจูุงุก       |
| `ุงูุชุฑุงุญ_CTA`        | ุงูุชุฑุงุญ Call-to-Action  | ูุญุต ุงูููุฉ          |
| `ูุญุต_ุงูููุฉ_ุงูุนุงููุฉ` | ูุญุต ุงูููุฉ ุงูุนุงููุฉ      | ุชุญููู ุงูุงุณุชุนุฏุงุฏ    |
| `ููุฉ_ุนุงููุฉ`         | ููุฉ ุนุงููุฉ ููุนูู        | ุนุฑุถ CTA            |
| `ููุฉ_ุนุงุฏูุฉ`         | ููุฉ ุนุงุฏูุฉ              | ูุชุงุจุนุฉ ุงููุญุงุฏุซุฉ    |
| `ุนุฑุถ_CTA`           | ุนุฑุถ CTA ูููุณุชุฎุฏู       | ุงูุชุฑุงุญ ุงูุนูู       |
| `ุชุชุจุน_ุงูุชูุงุนู`      | ุชุชุจุน ุชูุงุนู ุงููุณุชุฎุฏู    | ูุฑุงูุจุฉ ุงูุงุณุชุฌุงุจุฉ   |
| `ุชุญุณูู_CTA`         | ุชุญุณูู ุงูุชุฑุงุญุงุช CTA     | ุถุจุท ุงูุฎูุงุฑุฒููุฉ     |
| `ุงุณุชูุฑุงุฑ_ุงููุญุงุฏุซุฉ`  | ูุชุงุจุนุฉ ุงููุญุงุฏุซุฉ        | ุงูุฏูุฑุฉ ุงูุชุงููุฉ     |
| `ุชููู_ุฑุณุงูุฉ_ุฌุฏูุฏุฉ`  | ุชููู ุฑุณุงูุฉ ุฌุฏูุฏุฉ       | ุจุฏุก ุฏูุฑุฉ ุฌุฏูุฏุฉ     |

## 4. ูุฎุทุท ุณูุฑ ุงูุนูู ุงูุชุฌุงุฑู (BPMN)

```mermaid
graph TB
    Start([ุจุฏุก]) --> NewSession[ุฌูุณุฉ ุฌุฏูุฏุฉ]
    NewSession --> IntentAnalysis[ุชุญููู ุงูููุฉ]

    IntentAnalysis --> ContextCheck[ูุญุต ุงูุณูุงู]
    ContextCheck --> KnowledgeSearch[ุงูุจุญุซ ูู ุงููุนุฑูุฉ]

    KnowledgeSearch --> AnswerFound{ุฅุฌุงุจุฉ ููุฌูุฏุฉุ}
    AnswerFound -->|ูุนู| DirectResponse[ุฅุฑุฌุงุน ุงูุฅุฌุงุจุฉ]
    AnswerFound -->|ูุง| AIServiceDelegation[ุชูููุถ ููุฐูุงุก]

    AIServiceDelegation --> N8NProcessing[ูุนุงูุฌุฉ n8n]
    N8NProcessing --> GeminiInvocation[ุงุณุชุฏุนุงุก Gemini]
    GeminiInvocation --> InstructionsApplication[ุชุทุจูู ุงูุชุนูููุงุช]
    InstructionsApplication --> ResponseGeneration[ุชูููุฏ ุงูุฑุฏ]

    ResponseGeneration --> QualityCheck[ูุญุต ุงูุฌูุฏุฉ]
    QualityCheck --> QualityResult{ุงูุฌูุฏุฉุ}

    QualityResult -->|ุนุงููุฉ| HighQuality[ุฌูุฏุฉ ุนุงููุฉ]
    QualityResult -->|ุนุงุฏูุฉ| NormalQuality[ุฌูุฏุฉ ุนุงุฏูุฉ]
    QualityResult -->|ููุฎูุถุฉ| LowQuality[ุฌูุฏุฉ ููุฎูุถุฉ]

    HighQuality --> SendResponse[ุฅุฑุณุงู ุงูุฑุฏ]
    NormalQuality --> SendResponse
    LowQuality --> ResponseEnhancement[ุชุญุณูู ุงูุฑุฏ]

    ResponseEnhancement --> SendResponse
    SendResponse --> ShowRating[ุนุฑุถ ุงูุชูููู]

    ShowRating --> ReceiveRating[ุชููู ุงูุชูููู]
    ReceiveRating --> RatingType{ููุน ุงูุชูููู}

    RatingType -->|ุฅูุฌุงุจู| PositiveFeedback[ุชูููู ุฅูุฌุงุจู]
    RatingType -->|ุณูุจู| NegativeFeedback[ุชูููู ุณูุจู]

    PositiveFeedback --> BotImproved[ุงูุจูุช ูุญุฏุซ]

    NegativeFeedback --> ProblemAnalysis[ุชุญููู ุงููุดููุฉ]
    ProblemAnalysis --> InstructionGeneration[ุฅูุดุงุก ุชุนูููุงุช]
    InstructionGeneration --> SaveInstructions[ุญูุธ ุงูุชุนูููุงุช]
    SaveInstructions --> UpdatePrompt[ุชุญุฏูุซ ุงูุจุฑููุจุช]

    UpdatePrompt --> BotImproved

    KnowledgeUpdated --> CTASuggestion[ุงูุชุฑุงุญ CTA]
    BotImproved --> CTASuggestion

    CTASuggestion --> IntentCheck[ูุญุต ุงูููุฉ ุงูุนุงููุฉ]
    IntentCheck --> HighIntent{ููุฉ ุนุงููุฉุ}
    HighIntent -->|ูุนู| ShowCTA[ุนุฑุถ CTA]
    HighIntent -->|ูุง| ContinueConversation[ูุชุงุจุนุฉ ุงููุญุงุฏุซุฉ]

    ShowCTA --> TrackInteraction[ุชุชุจุน ุงูุชูุงุนู]
    TrackInteraction --> OptimizeCTA[ุชุญุณูู CTA]

    ContinueConversation --> NewMessage[ุฑุณุงูุฉ ุฌุฏูุฏุฉ]
    OptimizeCTA --> ContinueConversation
    NewMessage --> IntentAnalysis

    subgraph "ุงูุชุนูู ุงููุณุชูุฑ"
        MonitorPerformance[ูุฑุงูุจุฉ ุงูุฃุฏุงุก] --> AnalyzeMetrics[ุชุญููู ุงูููุงููุณ]
        AnalyzeMetrics --> OptimizeAlgorithm[ุชุญุณูู ุงูุฎูุงุฑุฒููุฉ]
        OptimizeAlgorithm --> UpdateModel[ุชุญุฏูุซ ุงููููุฐุฌ]
    end

    ContinueConversation --> End([ููุงูุฉ])
    NewMessage --> End
```

## 5. ุชูุงุตูู ุชูููุฉ ููู ูุฑุญูุฉ

### 5.1 ูุฑุญูุฉ ุชุญููู ุงูููุฉ ูุงูุณูุงู

#### 5.1.1 ุชุญููู ุงูููุฉ (Intent Analysis)

```typescript
async function analyzeIntent(text: string): Promise<IntentResult> {
  // ุชุญููู ูุตู ุจุณูุท
  const simpleIntent = detectSimpleIntent(text);

  // ุชุญููู ูุชูุฏู ุจุงุณุชุฎุฏุงู ูููุงุช ููุชุงุญูุฉ
  const advancedIntent = detectAdvancedIntent(text);

  // ุชุญููู ุงูุณูุงู ูู ุงููุญุงุฏุซุฉ ุงูุณุงุจูุฉ
  const contextIntent = detectContextIntent(text, conversationHistory);

  return {
    primary: advancedIntent || simpleIntent,
    confidence: calculateConfidence(text, conversationHistory),
    context: contextIntent,
  };
}
```

#### 5.1.2 ูุดู ุงูููุฉ ุงูุจุณูุทุฉ

```typescript
function detectSimpleIntent(text: string): IntentType {
  const textLower = text.toLowerCase();

  if (textLower.includes('ุณุนุฑ') || textLower.includes('ุชูููุฉ')) {
    return 'price_inquiry';
  }

  if (textLower.includes('ูุชููุฑ') || textLower.includes('ูุฎุฒูู')) {
    return 'availability_inquiry';
  }

  if (textLower.includes('ุทูุจ') || textLower.includes('ุดุฑุงุก')) {
    return 'order_intent';
  }

  return 'general_inquiry';
}
```

#### 5.1.3 ูุญุต ุงูุณูุงู

```typescript
async function checkContext(sessionId: string, currentMessage: string) {
  const conversationHistory = await getConversationHistory(sessionId);
  const context = buildContext(conversationHistory);

  return {
    previousTopics: extractTopics(context),
    userIntent: detectUserIntent(context),
    botState: getBotState(context),
    conversationFlow: analyzeFlow(context),
  };
}
```

### 5.2 ูุฑุญูุฉ ุงูุจุญุซ ูู ุงููุนุฑูุฉ

#### 5.2.1 ุงูุจุญุซ ูู ุงูุฃุณุฆูุฉ ุงูุดุงุฆุนุฉ (ุงููุทุจู ูุนููุงู)

```typescript
async function searchFAQs(query: string, merchantId: string) {
  // ุงูุจุญุซ ูู ุงูุฃุณุฆูุฉ ุงูุดุงุฆุนุฉ ุงููููุฑุณุฉ ูู Qdrant
  const faqResults = await vectorService.searchBotFaqs(query, 5);

  return faqResults.map((faq) => ({
    question: faq.question,
    answer: faq.answer,
    similarity: faq.score,
    source: 'faq',
  }));
}
```

#### 5.2.2 ุงูุจุญุซ ูู ุงููุนุฑูุฉ ุงูุนุงูุฉ (ูุฎุทุท ูุณุชูุจูู)

```typescript
// TODO: ุชูููุฐ ุงูุจุญุซ ูู ุฑุฏูุฏ ุงูุจูุช ุงููููุฑุณุฉ
async function searchKnowledge(query: string, sessionId: string) {
  // 1. ุชุญููู ุงูุงุณุชุนูุงู ููุชุฌู
  const queryEmbedding = await embedText(query);

  // 2. ุงูุจุญุซ ูู ุฑุฏูุฏ ุงูุจูุช ุงููููุฑุณุฉ ูู Qdrant
  const results = await vectorService.search({
    collection: 'bot_responses',
    vector: queryEmbedding,
    filter: { sessionId },
    limit: 5,
    score_threshold: 0.7,
  });

  // 3. ุชุตููุฉ ูุชุฑุชูุจ ุงููุชุงุฆุฌ
  return results
    .filter((result) => result.score > 0.8)
    .sort((a, b) => b.score - a.score)
    .map((result) => ({
      content: result.payload.text,
      similarity: result.score,
      source: result.payload.source,
      type: 'bot_response',
    }));
}
```

### 5.3 ูุฑุญูุฉ ูุนุงูุฌุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู

#### 5.3.1 ุจูุงุก ุงูุจุฑููุจุช ุงููุชูุงูู

```typescript
async function buildSystemPrompt(
  userMessage: string,
  conversationHistory: Message[],
  merchantSettings: MerchantSettings,
) {
  // 1. ุฌูุจ ุงูุชุนูููุงุช ุงููุดุทุฉ
  const instructions =
    await instructionsService.getActiveInstructions(merchantId);

  // 2. ุจูุงุก ุงูุณูุงู ูู ุงููุญุงุฏุซุฉ
  const context = buildConversationContext(conversationHistory);

  // 3. ุฅุถุงูุฉ ุงููุนุฑูุฉ ูู ุงูุฃุณุฆูุฉ ุงูุดุงุฆุนุฉ
  const knowledge = await searchFAQs(userMessage, merchantId);

  // 4. ุชุฌููุน ุงูุจุฑููุจุช ุงูููุงุฆู
  const systemPrompt = `
    ุฃูุช ูุณุงุนุฏ ุฐูู ููุชุฌุฑ ${merchantSettings.name}.

    ${instructions.map((i) => i.instruction).join('\n')}

    ุงูุณูุงู ุงูุญุงูู:
    ${context}

    ุงููุนุฑูุฉ ุงููุชุงุญุฉ:
    ${knowledge.map((k) => `- ${k.content}`).join('\n')}

    ููุงุนุฏ ุงูุฑุฏ:
    - ูู ููุฐุจุงู ููุณุงุนุฏุงู
    - ุงุณุชุฎุฏู ููุณ ูุบุฉ ุงูุนููู
    - ูุง ุชูุชุฑุถ ูุนูููุงุช ุบูุฑ ูุคูุฏุฉ
    - ุฑูุฒ ุนูู ุญู ูุดููุฉ ุงูุนููู

    ุงูุฑุณุงูุฉ ุงูุญุงููุฉ: ${userMessage}
  `;

  return systemPrompt;
}
```

#### 5.3.2 ุงุณุชุฏุนุงุก n8n workflow

```typescript
async function forwardToN8N(
  sessionId: string,
  message: string,
  context: ConversationContext,
) {
  const payload = {
    sessionId,
    message,
    context,
    metadata: {
      timestamp: Date.now(),
      source: 'kleem_chat',
    },
  };

  const response = await axios.post(
    `${N8N_BASE_URL}/webhook/kleem-chat`,
    payload,
  );

  return response.data;
}
```

### 5.4 ูุฑุญูุฉ ุชูููู ุงูุฑุฏูุฏ ูุชุญุณูู ุงูุจูุช

#### 5.4.1 ูุธุงู ุงูุชูููู

```typescript
async function rateMessage(
  sessionId: string,
  messageIndex: number,
  rating: 0 | 1,
  feedback?: string,
) {
  // 1. ุงูุนุซูุฑ ุนูู ุงูุฑุณุงูุฉ
  const message = await messagesRepo.findBySessionAndIndex(
    sessionId,
    messageIndex,
  );

  // 2. ุญูุธ ุงูุชูููู
  message.rating = rating;
  message.feedback = feedback;
  await message.save();

  // 3. ุฅุฐุง ูุงู ุงูุชูููู ุณูุจูุงูุ ุฅูุดุงุก ุชุนูููุงุช ูู ุงูุฑุฏ ุงูุณูุจู
  if (rating === 0) {
    await createInstructionFromBadReply(message.text, message.merchantId);
  }

  // ุญุงูุฉ ุงูุชูููู ุงูุฅูุฌุงุจู ูุน ุฅุถุงูุฉ ุงูููุฑุณุฉ (ูุฎุทุท ูุณุชูุจูู)
  // TODO: ุชูููุฐ ุญุงูุฉ ุงูุชูููู ุงูุฅูุฌุงุจู ูุฅุถุงูุฉ ุงูููุฑุณุฉ ูููุนุฑูุฉ ุงููุชุฌููุฉ
  // if (rating === 1 && isHighQuality(message)) {
  //   await addToKnowledgeBase(message);
  // }
}
```

#### 5.4.2 ุฅูุดุงุก ุชุนูููุงุช ูู ุงูุฑุฏูุฏ ุงูุณูุจูุฉ

```typescript
async function createInstructionFromBadReply(
  badReply: string,
  merchantId: string,
) {
  const prompt = `
    ุงูุฑุฏ ุงูุชุงูู ุชู ุชููููู ุณูุจููุง: "${badReply}"
    ุตูุบ ุชุนูููุฉ ูุฎุชุตุฑุฉ (ุณุทุฑ ูุงุญุฏุ 15 ูููุฉ ุฃู ุฃูู) ูุชุฌูุจ ูุฐุง ุงูุฎุทุฃ.
  `;

  const instruction = await geminiService.generateContent(prompt);

  await instructionsService.create({
    merchantId,
    instruction: instruction.trim(),
    relatedReplies: [badReply],
    type: 'auto',
  });
}
```

#### 5.4.3 ุฅุถุงูุฉ ุงูุฑุฏูุฏ ุงูุฌูุฏุฉ ูููุนุฑูุฉ (ูุฎุทุท ูุณุชูุจูู)

```typescript
// TODO: ุชูููุฐ ุฏุงูุฉ ุฅุถุงูุฉ ุงูุฑุฏูุฏ ุงูุฌูุฏุฉ ูููุนุฑูุฉ ุงููุชุฌููุฉ
async function addToKnowledgeBase(message: Message) {
  const embedding = await embedText(message.text);

  await vectorService.upsertKnowledge([
    {
      id: generateId(),
      vector: embedding,
      payload: {
        text: message.text,
        type: 'bot_response',
        rating: 1,
        merchantId: message.merchantId,
        sessionId: message.sessionId,
        timestamp: message.timestamp,
      },
    },
  ]);
}
```

### 5.5 ูุฑุญูุฉ ุงูุชุฑุงุญ Call-to-Action

#### 5.5.1 ูุญุต ุงูููุฉ ุงูุนุงููุฉ

```typescript
function checkHighIntent(
  message: string,
  conversationHistory: Message[],
): boolean {
  const intentService = new IntentService();

  // ูุญุต ุงูููุฉ ุงูุนุงููุฉ
  const highIntent = intentService.highIntent(message);

  // ูุญุต ุงูุณูุงู
  const contextIntent = analyzeConversationIntent(conversationHistory);

  // ูุญุต ุงููููุงุช ุงูููุชุงุญูุฉ
  const keywordMatch = checkHighIntentKeywords(message);

  return highIntent || contextIntent || keywordMatch;
}
```

#### 5.5.2 ุงูุชุญูู ูู ุนุฑุถ CTA

```typescript
async function checkCTA(sessionId: string, highIntent: boolean) {
  const ctaService = new CtaService();

  // ูุญุต ูุง ุฅุฐุง ูุงู ููุณูุญ ุจุนุฑุถ CTA
  if (!ctaService.allow(sessionId, highIntent)) {
    return null;
  }

  // ุฅุฑุฌุงุน ูุนูููุงุช ุงูุณูุงุญ ุจุนุฑุถ CTA
  return {
    allowed: true,
    type: highIntent ? 'high_intent' : 'general',
    metadata: {
      sessionId,
      timestamp: Date.now(),
      intentLevel: highIntent ? 'high' : 'normal',
    },
  };
}
```

## 6. ูุนุงููุฑ ุงูุฃูุงู ูุงูุญูุงูุฉ

### 6.1 ุงูุชุญูู ูู ุงููููุฉ ูุงูุฌูุณุงุช

```typescript
// ุงูุชุญูู ูู ุตุญุฉ ุงูุฌูุณุฉ
const session = await sessionsRepo.findById(sessionId);
if (!session || session.status !== 'active') {
  throw new UnauthorizedException('Invalid session');
}

// ุงูุชุญูู ูู ุงููุณุชุฎุฏู
const user = await getCurrentUser();
if (session.userId !== user.userId) {
  throw new ForbiddenException('Session mismatch');
}
```

### 6.2 Rate Limiting

- **ุฑุณุงุฆู ุงููุณุชุฎุฏู**: 30 ุฑุณุงูุฉ/ุฏูููุฉ
- **ุชูููู ุงูุฑุฏูุฏ**: 10 ุชููููุงุช/ุฏูููุฉ
- **ุทูุจุงุช ุงูุจุญุซ**: 100 ุทูุจ/ุฏูููุฉ

### 6.3 ููุน ุงูุฅุณุงุกุฉ

```typescript
// ูุญุต ุงูุฑุณุงุฆู ุงููุณูุฆุฉ
function isAbusiveMessage(text: string): boolean {
  const abusivePatterns = ['ุณุจ', 'ุดุชู', 'ูููุงุช ูุณูุฆุฉ'];
  return abusivePatterns.some((pattern) =>
    text.toLowerCase().includes(pattern),
  );
}
```

## 7. ูุณุงุฑุงุช ุงูุฎุทุฃ ูุงูุชุนุงูู ูุนูุง

### 7.1 ุฃุฎุทุงุก ุงููุนุงูุฌุฉ

```javascript
AI_SERVICE_UNAVAILABLE; // ุฎุฏูุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุบูุฑ ูุชุงุญุฉ
VECTOR_SEARCH_FAILED; // ูุดู ูู ุงูุจุญุซ ุงููุชุฌูู
KNOWLEDGE_NOT_FOUND; // ูุง ุชูุฌุฏ ูุนุฑูุฉ ูุทุงุจูุฉ
PROMPT_BUILDING_FAILED; // ูุดู ูู ุจูุงุก ุงูุจุฑููุจุช
```

### 7.2 ุฃุฎุทุงุก ุงูุชูููู

```javascript
INVALID_RATING_VALUE; // ูููุฉ ุชูููู ุบูุฑ ุตุญูุญุฉ
RATING_NOT_AUTHORIZED; // ุบูุฑ ูุฎูู ููุชูููู
SESSION_NOT_FOUND; // ุงูุฌูุณุฉ ุบูุฑ ููุฌูุฏุฉ
MESSAGE_NOT_FOUND; // ุงูุฑุณุงูุฉ ุบูุฑ ููุฌูุฏุฉ
```

### 7.3 ุฃุฎุทุงุก CTA

```javascript
CTA_GENERATION_FAILED; // ูุดู ูู ุชูููุฏ CTA
INTENT_DETECTION_FAILED; // ูุดู ูู ูุดู ุงูููุฉ
INTERACTION_TRACKING_FAILED; // ูุดู ูู ุชุชุจุน ุงูุชูุงุนู
```

## 8. ุฎุทุฉ ุงูุงุฎุชุจุงุฑ ูุงูุชุญูู

### 8.1 ุงุฎุชุจุงุฑุงุช ุงููุญุฏุฉ

- ุงุฎุชุจุงุฑ ุชุญููู ุงูููุฉ ููุฑุณุงุฆู ุงููุฎุชููุฉ โ (ูุทุจู ุญุงููุงู)
- ุงุฎุชุจุงุฑ ุงูุจุญุซ ูู ุงููุนุฑูุฉ ุงูููุฌูุฏุฉ โ (ูุทุจู ุญุงููุงู)
- ุงุฎุชุจุงุฑ ุชูููู ุงูุฑุฏูุฏ ุงูุณูุจูุฉ ูุฅูุดุงุก ุงูุชุนูููุงุช โ (ูุทุจู ุญุงููุงู)
- ุงุฎุชุจุงุฑ ุงูุชุฑุงุญ CTA ููููุงูุง ุงููุฎุชููุฉ โ (ูุทุจู ุญุงููุงู)

### 8.2 ุงุฎุชุจุงุฑุงุช ุงูุชูุงูู

- ุงุฎุชุจุงุฑ ุงูุชูุงูู ูุน n8n workflow โ (ูุทุจู ุญุงููุงู)
- ุงุฎุชุจุงุฑ ุงูุชูุงูู ูุน Gemini AI โ (ูุทุจู ุญุงููุงู)
- ุงุฎุชุจุงุฑ ุงูุจุญุซ ูู ุงูุฃุณุฆูุฉ ุงูุดุงุฆุนุฉ ุงููุชุฌููุฉ โ (ูุทุจู ุญุงููุงู)
- ุงุฎุชุจุงุฑ ูุธุงู ุงูุชุญูู ูู ุนุฑุถ CTA โ (ูุทุจู ุญุงููุงู)
- ุงุฎุชุจุงุฑ ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก โ (ูุทุจู ุญุงููุงู)

### 8.3 ุงุฎุชุจุงุฑุงุช ุงูุฃุฏุงุก

- ุงุฎุชุจุงุฑ ุฒูู ุงูุงุณุชุฌุงุจุฉ ููุฑุณุงุฆู โ (ูุทุจู ุญุงููุงู)
- ุงุฎุชุจุงุฑ ุงูุจุญุซ ูู ููุงุนุฏ ุงูุจูุงูุงุช ุงููุจูุฑุฉ โ (ูุทุจู ุญุงููุงู)
- ุงุฎุชุจุงุฑ ุงูุจุญุซ ุงููุชุฌูู ูู ุงูุฃุณุฆูุฉ ุงูุดุงุฆุนุฉ โ (ูุทุจู ุญุงููุงู)
- ุงุฎุชุจุงุฑ ุงุณุชููุงู ุงูุฐุงูุฑุฉ ูุงููุนุงูุฌ โ (ูุทุจู ุญุงููุงู)

### 8.4 ุงุฎุชุจุงุฑุงุช ูุณุชูุจููุฉ (ููููุฑุณุฉ ุงููุชุฌููุฉ)

- ุงุฎุชุจุงุฑ ุชูููุฏ ุงูุชุถูููุงุช ุจุงูุฌููุฉ ๐ง (ูุฎุทุท ูุณุชูุจูู)
- ุงุฎุชุจุงุฑ ููุฑุณุฉ ูููุงุช ูุจูุฑุฉ ูู ุงููุญุชูู ๐ง (ูุฎุทุท ูุณุชูุจูู)
- ุงุฎุชุจุงุฑ ุงูุจุญุซ ุงููุชุฌูู ูู ุฑุฏูุฏ ุงูุจูุช ๐ง (ูุฎุทุท ูุณุชูุจูู)

---

_ุชู ุฅูุดุงุก ูุฐุง ุงูุชูุซูู ุจูุงุณุทุฉ ูุธุงู ูููู ูุฅุฏุงุฑุฉ ุงููุชุงุฌุฑ ุงูุฐููุฉ_
