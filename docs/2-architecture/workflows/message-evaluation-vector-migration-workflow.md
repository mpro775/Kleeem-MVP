# ูุฑู ููู ุชูููู ุงูุฑุณุงุฆู - ูุธุงู ูููู ุงูุดุงูู

## ูุธุฑุฉ ุนุงูุฉ ุนูู ุงููุธุงู

ูุธุงู ูููู ูุฏุนู ุชููููุงู ุฃุณุงุณูุงู ูุฑุณุงุฆู ุงูุจูุช ูุน ุงูุชุฑููุฒ ุนูู ุชุญุณูู ุงูุงุณุชุฌุงุจุงุช ูู ุฎูุงู ุงูุชุบุฐูุฉ ุงูุฑุงุฌุนุฉ ุงูุณูุจูุฉ:

- **ุชูููู ุงูุฑุณุงุฆู**: ูุธุงู ุชุตููู ุงูุฑุฏูุฏ ูู ูุจู ุงูุนููุงุก ุงููุตุงุฏู ุนูููู (ุฌูุฏ/ุณูุก) ูุน ุชุนูููุงุช
- **ุชุญุณูู ุงูุฐูุงุก ุงูุงุตุทูุงุนู**: ุฅูุดุงุก ุชุนูููุงุช ูู ุงูุฑุฏูุฏ ุงูุณูุฆุฉ โ (ูุทุจู ุญุงููุงู)
- **ุงูุชุนูู ูู ุงูุฃุฎุทุงุก**: ุชุญุณูู ุงูุจูุช ุจูุงุกู ุนูู ุงูุชุบุฐูุฉ ุงูุฑุงุฌุนุฉ ุงูุณูุจูุฉ
- **ุงูุงูุชูุงู ูููุชุฌูุงุช**: ููุฑุณุฉ ุงูุฑุฏูุฏ ุงูุฌูุฏุฉ ูู Qdrant ๐ง (ูุฎุทุท ูุณุชูุจูู)
- **ุงูุจุญุซ ุงูุฐูู**: ุงุณุชุฑุฌุงุน ุงูุฑุฏูุฏ ุงููุดุงุจูุฉ ูู ุงููุนุฑูุฉ ุงููููุฑุณุฉ

## 1. ูุฎุทุท ุงูุชุฏูู ุงูุนุงู (Flowchart)

```mermaid
graph TD
    A[ุชููู ุฑุฏ ุงูุจูุช] --> B[ุนุฑุถ ุงูุฑุฏ ููุนููู<br/>ูุน ุฎูุงุฑุงุช ุงูุชูููู]
    B --> C[ุงูุชุธุงุฑ ุชูููู ุงูุนููู<br/>thumbs up/down + ุชุนููู]

    C --> D{ููุน ุงูุชูููู}
    D -->|ุฅูุฌุงุจู ๐| E[ุญูุธ ุงูุชูููู ุงูุฅูุฌุงุจู<br/>ุฒูุงุฏุฉ ุฏุฑุฌุฉ ุงูุซูุฉ]
    D -->|ุณูุจู ๐| F[ุญูุธ ุงูุชูููู ุงูุณูุจู<br/>ุทูุจ ุชุนููู ุฅุถุงูู]

    F --> G[ุชุญููู ุงูุฑุฏ ุงูุณูุจู<br/>ุงุณุชุฎุฑุงุฌ ุงููุดููุฉ]
    G --> H[ุฅูุดุงุก ุชุนูููุงุช ุฌุฏูุฏุฉ<br/>ุจุงุณุชุฎุฏุงู Gemini AI]

    H --> I[ุญูุธ ุงูุชุนูููุงุช<br/>ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช]
    I --> J[ุชุญุฏูุซ prompt ุงูุจูุช<br/>ุฅุถุงูุฉ ุงูุชุนูููุงุช ุงูุฌุฏูุฏุฉ]

    E --> K[ุญุงูุฉ ุงูุชูููู ุงูุฅูุฌุงุจู<br/>ููุฎุทุท ููุชุทุจูู ูุณุชูุจูุงู]
    K --> L[ุชุฌุงูู ุงูุฑุฏ ุญุงููุงู<br/>ุณูุชู ุชุทุจูู ุงูููุฑุณุฉ ูุณุชูุจูุงู]

    M[ูุงุนุฏุฉ ุงููุนุฑูุฉ ุงูุญุงููุฉ] --> N[ุงูุจุญุซ ูู ุงููุนุฑูุฉ ุงููููุฑุณุฉ<br/>ูู ูุตุงุฏุฑ ุฃุฎุฑู]
    N --> O[ุฅุฑุฌุงุน ุงููุชุงุฆุฌ<br/>ูุน ุงููุตุงุฏุฑ ูุงูุซูุฉ]

    P[ุงูุชุนูู ุงููุณุชูุฑ] --> Q[ูุฑุงูุจุฉ ุงูุฃุฏุงุก<br/>ูุนุฏู ุงูุชููููุงุช ุงูุณูุจูุฉ]
    Q --> R[ุชุญุณูู ุงูุฎูุงุฑุฒููุฉ<br/>ุถุจุท ุงููุนููุงุช]
    R --> S[ุชุญุฏูุซ ุงููููุฐุฌ<br/>ุชุญุณูู ุงูุงุณุชุฌุงุจุงุช]
```

## 2. ูุฎุทุท ุงูุชุณูุณู (Sequence Diagram)

```mermaid
sequenceDiagram
    participant C as Customer
    participant W as Website/Widget
    participant B as Bot Service
    participant DB as Database
    participant AI as Gemini AI
    participant AN as Analytics
    participant INS as Instructions Service

    Note over W,C: ุชููู ุฑุฏ ุงูุจูุช ูู ุงูุนููู
    C->>W: ุชูููู ุงูุฑุฏ ูู ุงูุนููู (๐/๐ + ุชุนููู)
    W->>W: ูุตุงุฏูุฉ JWT ูุงูุญุตูู ุนูู merchantId ูู ุงููุณุชุฎุฏู

    Note over W,B: ุญูุธ ุงูุชูููู
    W->>B: POST /rate-message/{sessionId}/{messageId}
    B->>DB: ุญูุธ ุงูุชูููู ูู ุงูุฑุณุงูุฉ

    alt ุชูููู ุณูุจู
        Note over B,AI: ุฅูุดุงุก ุชุนูููุงุช ูู ุงูุฑุฏ ุงูุณูุจู
        B->>AI: ุทูุจ ุฅูุดุงุก ุชุนูููุงุช ูู ุงูุฑุฏ ุงูุณูุจู
        AI-->>B: ุชุนูููุงุช ุฌุฏูุฏุฉ

        Note over B,INS: ุญูุธ ุงูุชุนูููุงุช
        B->>INS: ุญูุธ ุงูุชุนูููุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
        INS->>DB: ุฅุฏุฑุงุฌ ุงูุชุนูููุงุช ุงูุฌุฏูุฏุฉ

        Note over B: ุชุญุฏูุซ prompt ุงูุจูุช
        B->>B: ุฅุถุงูุฉ ุงูุชุนูููุงุช ููู system prompt
    else ุชูููู ุฅูุฌุงุจู (ูุฎุทุท ูุณุชูุจูู)
        Note over B: ุญุงูุฉ ุงูุชูููู ุงูุฅูุฌุงุจู ูุน ุงูููุฑุณุฉ ุงููุชุฌููุฉ
        Note over B: ุณูุชู ุชูููุฐ ูุฐู ุงูููุฒุฉ ูุณุชูุจูุงู
    end

    Note over AN: ุชุณุฌูู ุงูููุงููุณ
    B->>AN: ุชุณุฌูู ุงูุชูููู ูุงูุชุญุณูู
    AN-->>B: ุชุฃููุฏ ุงูุชุณุฌูู

    Note over C,W: ุจุญุซ ุฌุฏูุฏ (ูู ูุตุงุฏุฑ ุฃุฎุฑู)
    C->>W: ุฅุฑุณุงู ุงุณุชุนูุงู ุฌุฏูุฏ
    W->>B: ุทูุจ ุงูุจุญุซ ูู ุงููุนุฑูุฉ ุงููููุฑุณุฉ
    B->>DB: ุงูุจุญุซ ูู ุงููุนุฑูุฉ ุงูููุฌูุฏุฉ
    DB-->>B: ูุชุงุฆุฌ ุงูุจุญุซ

    Note over B: ูุนุงูุฌุฉ ุงููุชุงุฆุฌ
    B->>B: ุฏูุฌ ูุน ุงูุฑุฏูุฏ ุงูุฌุฏูุฏุฉ
    B->>W: ุฅุฑุฌุงุน ุงููุชุงุฆุฌ ุงููุญุณูุฉ
    W-->>C: ุนุฑุถ ุงููุชุงุฆุฌ ููุนููู
```

## 3. ุขูุฉ ุงูุญุงูุงุช (State Machine)

```mermaid
stateDiagram-v2
    [*] --> ุนุฑุถ_ุงูุฑุฏ: ุงูุจูุช ูุฑุฏ ุนูู ุงูุนููู

    ุนุฑุถ_ุงูุฑุฏ --> ุงูุชุธุงุฑ_ุงูุชูููู: ุนุฑุถ ุฎูุงุฑุงุช ุงูุชูููู ููุนููู
    ุงูุชุธุงุฑ_ุงูุชูููู --> ุชูููู_ุงูุนููู: ุงูุนููู ูููู ุงูุฑุฏ

    ุชูููู_ุงูุนููู --> ุญูุธ_ุงูุชูููู: ุญูุธ ุงูุชูููู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
    ุญูุธ_ุงูุชูููู --> ูุญุต_ููุน_ุงูุชูููู: ุฅูุฌุงุจู ุฃู ุณูุจู

    ูุญุต_ููุน_ุงูุชูููู --> ุชูููู_ุฅูุฌุงุจู: ๐
    ูุญุต_ููุน_ุงูุชูููู --> ุชูููู_ุณูุจู: ๐

    ุชูููู_ุฅูุฌุงุจู --> ุชุฌุงูู_ุงูุฑุฏ_ุญุงููุงู: ุณูุชู ุชุทุจูู ุงูููุฑุณุฉ ูุณุชูุจูุงู
    ุชูููู_ุณูุจู --> ุชุญููู_ุงููุดููุฉ: ุงุณุชุฎุฑุงุฌ ุณุจุจ ุงูุณูุจูุฉ

    ุชุญููู_ุงููุดููุฉ --> ุฅูุดุงุก_ุชุนูููุงุช: ุจุงุณุชุฎุฏุงู Gemini AI
    ุฅูุดุงุก_ุชุนูููุงุช --> ุญูุธ_ุงูุชุนูููุงุช: ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
    ุญูุธ_ุงูุชุนูููุงุช --> ุชุญุฏูุซ_ุงูุจุฑููุจุช: ุฅุถุงูุฉ ุงูุชุนูููุงุช ุงูุฌุฏูุฏุฉ
    ุชุญุฏูุซ_ุงูุจุฑููุจุช --> ุชุญุณูู_ุงูุจูุช: ุงูุจูุช ูุญุฏุซ

    ุชุฌุงูู_ุงูุฑุฏ_ุญุงููุงู --> ุงูุจุญุซ_ุงูุฌุฏูุฏ: ุทูุจ ุจุญุซ ูู ุงููุนุฑูุฉ ุงูููุฌูุฏุฉ
    ุชุญุณูู_ุงูุจูุช --> ุงูุจุญุซ_ุงูุฌุฏูุฏ

    ุงูุจุญุซ_ุงูุฌุฏูุฏ --> ุงูุจุญุซ_ูู_ุงููุนุฑูุฉ: ูู ุงููุตุงุฏุฑ ุงููููุฑุณุฉ ุงูููุฌูุฏุฉ
    ุงูุจุญุซ_ูู_ุงููุนุฑูุฉ --> ุชุฑุชูุจ_ุงููุชุงุฆุฌ: ุญุณุจ ุงูุตูุฉ ูุงูุชูููู
    ุชุฑุชูุจ_ุงููุชุงุฆุฌ --> ุฅุฑุฌุงุน_ุงููุชุงุฆุฌ: ููุนููู

    ุฅุฑุฌุงุน_ุงููุชุงุฆุฌ --> ุชุณุฌูู_ุงูุชุญูููุงุช: ูุฑุงูุจุฉ ุงูุฃุฏุงุก
    ุชุณุฌูู_ุงูุชุญูููุงุช --> ุงุณุชูุฑุงุฑ_ุงูุนูู: ุงููุธุงู ูุนูู

    ุฎุทุฃ_ุงูุชูููู --> ุฅุนุงุฏุฉ_ุงููุญุงููุฉ: ูุญุงููุฉ ุฃุฎุฑู
    ุฅุนุงุฏุฉ_ุงููุญุงููุฉ --> ุญูุธ_ุงูุชูููู
```

### ุชุนุฑูู ุงูุญุงูุงุช

| ุงูุญุงูุฉ                | ุงููุตู                              | ุงูุฅุฌุฑุงุกุงุช ุงููุณููุญุฉ          |
| --------------------- | ---------------------------------- | ----------------------------- |
| `ุนุฑุถ_ุงูุฑุฏ`           | ุนุฑุถ ุฑุฏ ุงูุจูุช ููุนููู               | ุนุฑุถ ุฎูุงุฑุงุช ุงูุชูููู          |
| `ุงูุชุธุงุฑ_ุงูุชูููู`     | ุงูุชุธุงุฑ ุชูููู ุงูุนููู               | ุนุฑุถ ุฎูุงุฑุงุช ๐/๐            |
| `ุชูููู_ุงูุนููู`       | ุงูุนููู ูููู ุงูุฑุฏ                  | ุญูุธ ุงูุชูููู                 |
| `ุญูุธ_ุงูุชูููู`        | ุญูุธ ุงูุชูููู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช     | ุชุญุฏูุซ ุณุฌู ุงูุฑุณุงูุฉ           |
| `ูุญุต_ููุน_ุงูุชูููู`    | ุชุญุฏูุฏ ููุน ุงูุชูููู                 | ุชุตููู ุงูุชูููู               |
| `ุชูููู_ุฅูุฌุงุจู`       | ุชูููู ุฅูุฌุงุจู ูู ุงูุนููู           | ุชุฌุงูู ุญุงููุงู                |
| `ุชูููู_ุณูุจู`         | ุชูููู ุณูุจู ูู ุงูุนููู             | ุชุญููู ุงููุดููุฉ               |
| `ุชุฌุงูู_ุงูุฑุฏ_ุญุงููุงู`   | ุนุฏู ุชุทุจูู ุงูููุฑุณุฉ ุญุงููุงู         | ุงูุชุธุงุฑ ุงูุชุทููุฑ ุงููุณุชูุจูู    |
| `ุชุญููู_ุงููุดููุฉ`      | ุชุญููู ุณุจุจ ุงูุชูููู ุงูุณูุจู          | ุงุณุชุฎุฑุงุฌ ุงููุดููุฉ             |
| `ุฅูุดุงุก_ุชุนูููุงุช`      | ุฅูุดุงุก ุชุนูููุงุช ุฌุฏูุฏุฉ               | ุงุณุชุฏุนุงุก Gemini AI           |
| `ุญูุธ_ุงูุชุนูููุงุช`      | ุญูุธ ุงูุชุนูููุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช   | ุฅุฏุฑุงุฌ ุงูุชุนูููุงุช             |
| `ุชุญุฏูุซ_ุงูุจุฑููุจุช`     | ุชุญุฏูุซ prompt ุงูุจูุช                | ุฅุถุงูุฉ ุงูุชุนูููุงุช ุงูุฌุฏูุฏุฉ     |
| `ุชุญุณูู_ุงูุจูุช`        | ุงูุจูุช ูุญุฏุซ ุจุงูุชุนูููุงุช ุงูุฌุฏูุฏุฉ     | ุชุญุณูู ุงูุงุณุชุฌุงุจุงุช            |
| `ุงูุจุญุซ_ุงูุฌุฏูุฏ`       | ุทูุจ ุจุญุซ ุฌุฏูุฏ                      | ุงูุจุญุซ ูู ุงููุนุฑูุฉ ุงูููุฌูุฏุฉ   |
| `ุงูุจุญุซ_ูู_ุงููุนุฑูุฉ`   | ุงูุจุญุซ ูู ุงููุนุฑูุฉ ุงููููุฑุณุฉ ุงูููุฌูุฏุฉ | ุงุณุชุฑุฌุงุน ุงููุชุงุฆุฌ             |
| `ุชุฑุชูุจ_ุงููุชุงุฆุฌ`      | ุชุฑุชูุจ ุญุณุจ ุงูุตูุฉ ูุงูุชูููู          | ุฅุนุฏุงุฏ ุงููุชุงุฆุฌ               |
| `ุฅุฑุฌุงุน_ุงููุชุงุฆุฌ`      | ุฅุฑุฌุงุน ุงููุชุงุฆุฌ ููุนููู              | ุนุฑุถ ุงููุญุชูู                 |
| `ุชุณุฌูู_ุงูุชุญูููุงุช`    | ุชุณุฌูู ุงูููุงููุณ ูุงูุฅุญุตุงุฆูุงุช        | ูุฑุงูุจุฉ ุงูุฃุฏุงุก               |

## 4. ูุฎุทุท ุณูุฑ ุงูุนูู ุงูุชุฌุงุฑู (BPMN)

```mermaid
graph TB
    Start([ุจุฏุก]) --> BotResponse[ุฑุฏ ุงูุจูุช]
    BotResponse --> ClientEvaluation[ุชูููู ุงูุนููู]

    ClientEvaluation --> EvaluationType{ููุน ุงูุชูููู}
    EvaluationType -->|ุฅูุฌุงุจู| IgnorePositive[ุชุฌุงูู ุญุงููุงู]
    EvaluationType -->|ุณูุจู| ProblemAnalysis[ุชุญููู ุงููุดููุฉ]

    ProblemAnalysis --> GenerateInstructions[ุฅูุดุงุก ุชุนูููุงุช]
    GenerateInstructions --> SaveInstructions[ุญูุธ ุงูุชุนูููุงุช]
    SaveInstructions --> UpdatePrompt[ุชุญุฏูุซ ุงูุจุฑููุจุช]

    IgnorePositive --> BotImproved[ุงูุจูุช ูุญุฏุซ]
    UpdatePrompt --> BotImproved

    BotImproved --> NewSearch[ุจุญุซ ุฌุฏูุฏ]
    NewSearch --> SearchKnowledge[ุงูุจุญุซ ูู ุงููุนุฑูุฉ ุงูููุฌูุฏุฉ]
    SearchKnowledge --> SortResults[ุชุฑุชูุจ ุงููุชุงุฆุฌ]
    SortResults --> ReturnResults[ุฅุฑุฌุงุน ุงููุชุงุฆุฌ]

    ReturnResults --> LogAnalytics[ุชุณุฌูู ุงูุชุญูููุงุช]
    LogAnalytics --> ContinueOperation[ุงุณุชูุฑุงุฑ ุงูุนูู]

    subgraph "ุงูุชุนูู ุงููุณุชูุฑ (ูู ุงูุฃุฎุทุงุก ููุท)"
        MonitorPerformance[ูุฑุงูุจุฉ ุงูุฃุฏุงุก] --> AnalyzeNegativeFeedback[ุชุญููู ุงูุชุบุฐูุฉ ุงูุณูุจูุฉ]
        AnalyzeNegativeFeedback --> GenerateBetterInstructions[ุฅูุดุงุก ุชุนูููุงุช ูุญุณูุฉ]
        GenerateBetterInstructions --> UpdateBotModel[ุชุญุฏูุซ ูููุฐุฌ ุงูุจูุช]
    end

    subgraph "ุงูููุฑุณุฉ ุงููุชุฌููุฉ (ูุฎุทุท ูุณุชูุจูู)"
        FutureVectorIndexing[ููุฑุณุฉ ุงูุฑุฏูุฏ ุงูุฅูุฌุงุจูุฉ] --> FutureVectorSearch[ุงูุจุญุซ ุงููุชุฌูู ุงููุญุณู]
    end
```

## 5. ุชูุงุตูู ุชูููุฉ ููู ูุฑุญูุฉ

### 5.1 ูุฑุญูุฉ ุชูููู ุงูุฑุณุงุฆู

#### 5.1.1 ูุธุงู ุงูุชูููู

**Endpoint**: `POST /rate-message/{sessionId}/{messageId}`

**ุงููุชุทูุจุงุช**: ูุตุงุฏูุฉ JWT ูุทููุจุฉ

**ููููุฉ ุงูุญุตูู ุนูู merchantId**: ูุชู ุงุณุชุฎุฑุงุฌู ูู `req.user.merchantId` ูููุณุชุฎุฏู ุงููุตุงุฏู ุนููู

**ุงูุจูุงูุงุช ุงููุทููุจุฉ**:

```typescript
interface RateMessageDto {
  rating: 0 | 1; // 0 = ุณูุจูุ 1 = ุฅูุฌุงุจู
  feedback?: string; // ุชุนููู ุฅุถุงูู (ุงุฎุชูุงุฑู)
}
```

**ุนูููุฉ ุงููุนุงูุฌุฉ**:

```typescript
async function rateMessage(
  sessionId: string,
  messageId: string,
  userId: string,
  rating: 0 | 1,
  feedback?: string,
  merchantId?: string,
) {
  // 1. ุงูุจุญุซ ุนู ุงูุฑุณุงูุฉ ูุชุญุฏูุซ ุงูุชูููู
  const ok = await this.messagesRepo.updateMessageRating({
    sessionId,
    messageId,
    userId,
    rating,
    feedback,
    merchantId,
  });

  if (!ok) {
    throw new BadRequestException('ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุฑุณุงูุฉ ููุชูููู');
  }

  // 2. ุฅุฐุง ูุงู ุงูุชูููู ุณูุจูุงูุ ุฅูุดุงุก ุชุนูููุงุช ูู ุงูุฑุฏ ุงูุณูุจู
  if (rating === 0) {
    const text = await this.messagesRepo.getMessageTextById(sessionId, messageId);
    if (text) {
      await this.geminiService.generateAndSaveInstructionFromBadReply(text, merchantId);
    }
  }

  // ุญุงูุฉ ุงูุชูููู ุงูุฅูุฌุงุจู ูุน ุฅุถุงูุฉ ุงูููุฑุณุฉ (ูุฎุทุท ูุณุชูุจูู)
  // TODO: ุชูููุฐ ุญุงูุฉ ุงูุชูููู ุงูุฅูุฌุงุจู ูุฅุถุงูุฉ ุงูููุฑุณุฉ ูููุนุฑูุฉ ุงููุชุฌููุฉ
  // if (rating === 1 && isHighQuality(message)) {
  //   await vectorService.upsertKnowledge([...]);
  // }

  return { status: 'ok' };
}
```

#### 5.1.2 ุฅูุดุงุก ุชุนูููุงุช ูู ุงูุฑุฏูุฏ ุงูุณูุจูุฉ

**ุงุณุชุฏุนุงุก Gemini AI**:

```typescript
async function generateInstructionFromBadReply(
  badReply: string,
): Promise<string> {
  const prompt = `
    ุงูุฑุฏ ุงูุชุงูู ุชู ุชููููู ุณูุจููุง ูู ูุจู ุงูุนููู: "${badReply}".
    ุตูุบ ุชูุฌูููุง ูุฎุชุตุฑูุง ุฌุฏูุง (ุณุทุฑ ูุงุญุฏ ููุทุ 15 ูููุฉ ุฃู ุฃููุ ูุง ุชุดุฑุญ ุงูุณุจุจ)
    ูููุน ูุณุงุนุฏ ุงูุฐูุงุก ุงูุงุตุทูุงุนู ูู ุชูุฑุงุฑ ูุฐุง ุงูุฎุทุฃ.
  `;

  const result = await model.generateContent(prompt);
  return result.response.text().trim();
}
```

**ุฃูุซูุฉ ููุชุนูููุงุช ุงููููุดุฃุฉ**:

- "ูุง ุชูุฏู ูุนูููุงุช ุฎุงุทุฆุฉ ุนู ุงูุฃุณุนุงุฑ"
- "ุชุฃูุฏ ูู ููู ุงูุณุคุงู ูุจู ุงูุฅุฌุงุจุฉ"
- "ูุง ุชูุชุฑุถ ุงููุนูููุงุชุ ุงุทูุจ ุงูุชูุถูุญ"
- "ุฑูุฒ ุนูู ุญู ูุดููุฉ ุงูุนููู"

### 5.2 ูุฑุญูุฉ ุงูุจุญุซ ูู ุงููุนุฑูุฉ ุงูุญุงููุฉ

#### 5.2.1 ุงูุจุญุซ ูู ุงููุนุฑูุฉ ุงููููุฑุณุฉ ุงูููุฌูุฏุฉ

```typescript
async function searchExistingKnowledge(query: string, merchantId: string) {
  // ุงูุจุญุซ ูู ุงููุนุฑูุฉ ุงููููุฑุณุฉ ูู ูุตุงุฏุฑ ุฃุฎุฑู (ุงูุฃุณุฆูุฉ ุงูุดุงุฆุนุฉุ ุงูููุชุฌุงุชุ ุฅูุฎ)
  const results = await searchService.search(query, merchantId);

  return results.map((result) => ({
    text: result.content,
    similarity: result.score,
    source: result.source,
  }));
}
```

## 6. ูุนุงููุฑ ุงูุฃูุงู ูุงูุญูุงูุฉ

### 6.1 ุงูุชุญูู ูู ุงูุตูุงุญูุฉ

```typescript
// ุงูุชุญูู ูู ุงูุตูุงุญูุฉ ูุชู ูู ุฎูุงู JWT Auth Guard
// ูุงูุชุญูู ูู merchantId ูุชู ูู ุฎูุงู req.user.merchantId
// ุงูุฐู ูุชู ุชูุฑูุฑู ุชููุงุฆูุงู ูู ุฎูุงู AuthenticatedRequest interface
```

### 6.2 Rate Limiting

- **ุชูููู ุงูุฑุณุงุฆู**: ูุฎุถุน ููู Rate Limiting ุงูุนุงู ููู API
- **ุฅูุดุงุก ุงูุชุนูููุงุช**: ูุฎุถุน ููู Rate Limiting ุงูุนุงู ููู API
- **ุงูุจุญุซ ูู ุงููุนุฑูุฉ**: ูุฎุถุน ููู Rate Limiting ุงูุนุงู ููู API

### 6.3 ููุน ุงูุฅุณุงุกุฉ

```typescript
// ูุญุต ุงูุชุนูููุงุช ุงููุณูุฆุฉ
function isAbusiveFeedback(feedback: string): boolean {
  const abusivePatterns = ['ูููุฉ ูุณูุฆุฉ', 'ุณุจ', 'ุดุชู'];
  return abusivePatterns.some((pattern) =>
    feedback.toLowerCase().includes(pattern),
  );
}
```

## 7. ูุณุงุฑุงุช ุงูุฎุทุฃ ูุงูุชุนุงูู ูุนูุง

### 7.1 ุฃุฎุทุงุก ุงูุชูููู

```javascript
INVALID_RATING; // ูููุฉ ุชูููู ุบูุฑ ุตุญูุญุฉ
MESSAGE_NOT_FOUND; // ุงูุฑุณุงูุฉ ุบูุฑ ููุฌูุฏุฉ
UNAUTHORIZED_ACCESS; // ุบูุฑ ูุฎูู ููุชูููู
SESSION_EXPIRED; // ุงูุชูุช ุตูุงุญูุฉ ุงูุฌูุณุฉ
```

### 7.2 ุฃุฎุทุงุก ุฅูุดุงุก ุงูุชุนูููุงุช

```javascript
AI_GENERATION_FAILED; // ูุดู ูู ุฅูุดุงุก ุงูุชุนูููุงุช
INSTRUCTION_TOO_LONG; // ุงูุชุนูููุงุช ุทูููุฉ ุฌุฏุงู
INVALID_INSTRUCTION; // ุงูุชุนูููุงุช ุบูุฑ ุตุญูุญุฉ
GEMINI_API_ERROR; // ุฎุทุฃ ูู ุงุณุชุฏุนุงุก Gemini API
```

## 8. ุฎุทุฉ ุงูุงุฎุชุจุงุฑ ูุงูุชุญูู

### 8.1 ุงุฎุชุจุงุฑุงุช ุงููุญุฏุฉ

- ุงุฎุชุจุงุฑ ูุธุงู ุงูุชูููู (ุฅูุฌุงุจู/ุณูุจู) โ (ูุทุจู ุญุงููุงู)
- ุงุฎุชุจุงุฑ ุฅูุดุงุก ุงูุชุนูููุงุช ูู ุงูุฑุฏูุฏ ุงูุณูุจูุฉ โ (ูุทุจู ุญุงููุงู)
- ุงุฎุชุจุงุฑ ุญูุธ ุงูุชูููู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช โ (ูุทุจู ุญุงููุงู)
- ุงุฎุชุจุงุฑ ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ูู ุงูุชูููู โ (ูุทุจู ุญุงููุงู)

### 8.2 ุงุฎุชุจุงุฑุงุช ุงูุชูุงูู

- ุงุฎุชุจุงุฑ ุงูุชูุงูู ูุน Gemini AI โ (ูุทุจู ุญุงููุงู)
- ุงุฎุชุจุงุฑ ุชุญุฏูุซ prompt ุงูุจูุช โ (ูุทุจู ุญุงููุงู)
- ุงุฎุชุจุงุฑ ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ูู API โ (ูุทุจู ุญุงููุงู)
- ุงุฎุชุจุงุฑ ุงููุตุงุฏูุฉ JWT โ (ูุทุจู ุญุงููุงู)

### 8.3 ุงุฎุชุจุงุฑุงุช ุงูุฃุฏุงุก

- ุงุฎุชุจุงุฑ ุฃุฏุงุก ูุธุงู ุงูุชูููู โ (ูุทุจู ุญุงููุงู)
- ุงุฎุชุจุงุฑ ุฃุฏุงุก ุฅูุดุงุก ุงูุชุนูููุงุช โ (ูุทุจู ุญุงููุงู)
- ุงุฎุชุจุงุฑ ุงุณุชููุงู ุงูุฐุงูุฑุฉ ูุงููุนุงูุฌ โ (ูุทุจู ุญุงููุงู)
- ุงุฎุชุจุงุฑ ูุนุฏู ุงูุงุณุชุฌุงุจุฉ ููู API โ (ูุทุจู ุญุงููุงู)

### 8.4 ุงุฎุชุจุงุฑุงุช ูุณุชูุจููุฉ (ููููุฑุณุฉ ุงููุชุฌููุฉ)

- ุงุฎุชุจุงุฑ ููุฑุณุฉ ุงูุฑุฏูุฏ ุงูุฌูุฏุฉ ๐ง (ูุฎุทุท ูุณุชูุจูู)
- ุงุฎุชุจุงุฑ ุงูุจุญุซ ุงููุชุฌูู ๐ง (ูุฎุทุท ูุณุชูุจูู)
- ุงุฎุชุจุงุฑ ุชูููุฏ ุงูุชุถูููุงุช ุจุงูุฌููุฉ ๐ง (ูุฎุทุท ูุณุชูุจูู)
- ุงุฎุชุจุงุฑ ููุฑุณุฉ ูููุงุช ูุจูุฑุฉ ูู ุงููุญุชูู ๐ง (ูุฎุทุท ูุณุชูุจูู)

---

_ุชู ุฅูุดุงุก ูุฐุง ุงูุชูุซูู ุจูุงุณุทุฉ ูุธุงู ูููู ูุฅุฏุงุฑุฉ ุงููุชุงุฌุฑ ุงูุฐููุฉ_
