# 6.1 إستراتيجية الاختبارات

## نظرة عامة على استراتيجية الاختبارات

نظام كليم AI يطبق استراتيجية اختبارات شاملة ومتدرجة تغطي جميع مستويات التطبيق من الوحدات الفردية إلى الاختبارات الشاملة للمستخدم النهائي.

## 1. هرم الاختبارات (Testing Pyramid)

### 1.1 هيكل الهرم

```yaml
Testing Pyramid:
  Level 1 - Unit Tests (70%):
    - Fast execution
    - High coverage
    - Isolated components
    - Mocked dependencies

  Level 2 - Integration Tests (20%):
    - API endpoints
    - Database interactions
    - Service integrations
    - Real dependencies

  Level 3 - E2E Tests (10%):
    - User workflows
    - Cross-browser testing
    - Performance testing
    - Accessibility testing
```

### 1.2 توزيع الاختبارات

```yaml
Test Distribution:
  Frontend (React/TypeScript):
    - Unit Tests: 150+ tests
    - Integration Tests: 50+ tests
    - E2E Tests: 30+ tests

  Backend (NestJS/TypeScript):
    - Unit Tests: 200+ tests
    - Integration Tests: 80+ tests
    - API Tests: 60+ tests
```

## 2. اختبارات الوحدات (Unit Tests)

### 2.1 إعدادات Frontend

```typescript
// vitest.config.fast.ts
export default defineConfig({
  test: {
    globals: true,
    environment: "jsdom",
    setupFiles: ["./src/test/setup.ts"],

    // تحسينات الأداء
    pool: "forks",
    poolOptions: {
      forks: {
        singleFork: true,
        maxForks: 1,
        minForks: 1,
      },
    },

    // إعدادات التوقيت
    testTimeout: 10000,
    hookTimeout: 5000,
    teardownTimeout: 5000,

    // إعدادات التغطية
    coverage: {
      provider: "v8",
      reporter: ["text", "json", "html"],
      thresholds: {
        global: {
          branches: 70,
          functions: 70,
          lines: 70,
          statements: 70,
        },
      },
    },
  },
});
```

### 2.2 إعدادات Backend

```javascript
// jest.config.js
module.exports = {
  displayName: "Unit Tests",
  preset: "ts-jest",
  testEnvironment: "node",
  rootDir: "src",
  testRegex: ".*\\.spec\\.ts$",

  collectCoverageFrom: [
    "**/*.(t|j)s",
    "!**/*.spec.ts",
    "!**/*.interface.ts",
    "!**/*.dto.ts",
    "!**/*.entity.ts",
    "!**/*.enum.ts",
    "!**/node_modules/**",
    "!**/dist/**",
    "!main.ts",
  ],

  coverageThreshold: {
    global: {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80,
    },
  },

  setupFilesAfterEnv: ["<rootDir>/../test/setup.ts"],
  testTimeout: 10000,
  verbose: true,
  maxWorkers: "50%",
  clearMocks: true,
  restoreMocks: true,
  resetMocks: true,
};
```

### 2.3 أمثلة على اختبارات الوحدات

#### Frontend Component Test

```typescript
// UserProfile.test.tsx
import { render, screen, fireEvent } from "@testing-library/react";
import { UserProfile } from "./UserProfile";

describe("UserProfile Component", () => {
  test("renders user information correctly", () => {
    const mockUser = {
      id: "1",
      name: "أحمد محمد",
      email: "ahmed@example.com",
      role: "MERCHANT",
    };

    render(<UserProfile user={mockUser} />);

    expect(screen.getByText("أحمد محمد")).toBeInTheDocument();
    expect(screen.getByText("ahmed@example.com")).toBeInTheDocument();
    expect(screen.getByText("تاجر")).toBeInTheDocument();
  });

  test("handles edit mode toggle", () => {
    const mockUser = { id: "1", name: "أحمد محمد", email: "ahmed@example.com" };

    render(<UserProfile user={mockUser} />);

    const editButton = screen.getByRole("button", { name: /تعديل/i });
    fireEvent.click(editButton);

    expect(screen.getByDisplayValue("أحمد محمد")).toBeInTheDocument();
  });
});
```

#### Backend Service Test

```typescript
// auth.service.spec.ts
describe("AuthService", () => {
  let service: AuthService;
  let userModel: Model<User>;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      providers: [
        AuthService,
        {
          provide: getModelToken(User.name),
          useValue: {
            findOne: jest.fn(),
            create: jest.fn(),
            findByIdAndUpdate: jest.fn(),
          },
        },
      ],
    }).compile();

    service = module.get<AuthService>(AuthService);
    userModel = module.get<Model<User>>(getModelToken(User.name));
  });

  describe("login", () => {
    it("should return user data when credentials are valid", async () => {
      const loginDto = { email: "test@example.com", password: "password123" };
      const mockUser = {
        _id: "1",
        email: "test@example.com",
        password: "hashedPassword",
        active: true,
        emailVerified: true,
        role: "MERCHANT",
      };

      jest.spyOn(userModel, "findOne").mockReturnValue({
        select: jest.fn().mockResolvedValue(mockUser),
      } as any);

      jest.spyOn(bcrypt, "compare").mockResolvedValue(true);

      const result = await service.login(loginDto);

      expect(result).toHaveProperty("accessToken");
      expect(result.user.email).toBe("test@example.com");
    });
  });
});
```

## 3. اختبارات التكامل (Integration Tests)

### 3.1 إعدادات التكامل

```typescript
// vitest.config.comprehensive.ts
export default defineConfig({
  test: {
    globals: true,
    environment: "jsdom",
    setupFiles: ["./src/test/setup.ts"],

    // إعدادات التكامل
    pool: "forks",
    poolOptions: {
      forks: {
        singleFork: false,
        maxForks: 4,
        minForks: 2,
        isolate: true,
        memoryLimit: "2GB",
      },
    },

    // إعدادات التوقيت المطولة
    testTimeout: 30000,
    hookTimeout: 15000,
    teardownTimeout: 10000,

    // إعدادات التغطية المتقدمة
    coverage: {
      provider: "v8",
      reporter: ["text", "json", "html"],
      thresholds: {
        global: {
          branches: 80,
          functions: 80,
          lines: 80,
          statements: 80,
        },
      },
    },
  },
});
```

### 3.2 أمثلة على اختبارات التكامل

#### API Integration Test

```typescript
// orders.integration.spec.ts
describe("Orders API Integration", () => {
  let app: INestApplication;
  let ordersService: OrdersService;
  let leadsService: LeadsService;

  beforeEach(async () => {
    const moduleFixture: TestingModule = await Test.createTestingModule({
      imports: [AppModule],
    }).compile();

    app = moduleFixture.createNestApplication();
    await app.init();

    ordersService = moduleFixture.get<OrdersService>(OrdersService);
    leadsService = moduleFixture.get<LeadsService>(LeadsService);
  });

  describe("POST /orders", () => {
    it("should create order and save lead", async () => {
      const createOrderDto = {
        customerName: "أحمد محمد",
        customerPhone: "+966501234567",
        customerEmail: "ahmed@example.com",
        products: [{ id: "1", name: "منتج 1", price: 100, quantity: 2 }],
        totalAmount: 200,
        merchantId: "merchant123",
      };

      const response = await request(app.getHttpServer())
        .post("/orders")
        .send(createOrderDto)
        .expect(201);

      expect(response.body).toHaveProperty("id");
      expect(response.body.customerName).toBe("أحمد محمد");

      // التحقق من حفظ Lead
      const savedLead = await leadsService.findByPhone("+966501234567");
      expect(savedLead).toBeDefined();
      expect(savedLead.name).toBe("أحمد محمد");
    });
  });
});
```

## 4. اختبارات API

### 4.1 إعدادات API Testing

```typescript
// api.test.ts
import { Test, TestingModule } from "@nestjs/testing";
import { INestApplication } from "@nestjs/common";
import * as request from "supertest";
import { AppModule } from "../src/app.module";

describe("API Endpoints", () => {
  let app: INestApplication;

  beforeAll(async () => {
    const moduleFixture: TestingModule = await Test.createTestingModule({
      imports: [AppModule],
    }).compile();

    app = moduleFixture.createNestApplication();
    await app.init();
  });

  afterAll(async () => {
    await app.close();
  });

  describe("Authentication", () => {
    it("POST /auth/login should return access token", async () => {
      const loginDto = {
        email: "test@example.com",
        password: "password123",
      };

      const response = await request(app.getHttpServer())
        .post("/auth/login")
        .send(loginDto)
        .expect(200);

      expect(response.body).toHaveProperty("accessToken");
      expect(response.body).toHaveProperty("user");
    });
  });

  describe("Products", () => {
    it("GET /products should return products list", async () => {
      const response = await request(app.getHttpServer())
        .get("/products")
        .expect(200);

      expect(Array.isArray(response.body)).toBe(true);
    });
  });
});
```

## 5. اختبارات End-to-End (E2E)

### 5.1 إعدادات Playwright

```typescript
// playwright.config.ts
export default defineConfig({
  testDir: "./tests/e2e",
  testMatch: ["**/*.e2e.spec.ts"],
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,

  reporter: [
    ["list"],
    ["html", { outputFolder: "playwright-report" }],
    ["junit", { outputFile: "test-results/e2e-results.xml" }],
    ["json", { outputFile: "test-results/e2e-results.json" }],
  ],

  use: {
    baseURL: "http://localhost:5173",
    actionTimeout: 10_000,
    navigationTimeout: 30_000,
    trace: "on-first-retry",
    screenshot: "only-on-failure",
    video: "retain-on-failure",
    viewport: { width: 1280, height: 720 },
    colorScheme: "light",
    locale: "ar-SA",
    timezoneId: "Asia/Riyadh",
    ignoreHTTPSErrors: true,
    bypassCSP: true,
    extraHTTPHeaders: {
      "Accept-Language": "ar-SA,ar;q=0.9,en;q=0.8",
      "X-Test-Mode": "true",
      "X-Playwright": "true",
    },
  },

  projects: [
    {
      name: "chromium",
      use: { ...devices["Desktop Chrome"] },
    },
    {
      name: "firefox",
      use: { ...devices["Desktop Firefox"] },
    },
    {
      name: "webkit",
      use: { ...devices["Desktop Safari"] },
    },
    {
      name: "Mobile Chrome",
      use: { ...devices["Pixel 5"] },
    },
    {
      name: "Mobile Safari",
      use: { ...devices["iPhone 12"] },
    },
  ],
});
```

### 5.2 أمثلة على اختبارات E2E

```typescript
// auth.e2e.spec.ts
import { test, expect } from "@playwright/test";

test.describe("Authentication Flow", () => {
  test("user can login successfully", async ({ page }) => {
    await page.goto("/login");

    await page.fill('[data-testid="email-input"]', "test@example.com");
    await page.fill('[data-testid="password-input"]', "password123");
    await page.click('[data-testid="login-button"]');

    await expect(page).toHaveURL("/dashboard");
    await expect(page.locator('[data-testid="user-menu"]')).toBeVisible();
  });

  test("user can register new account", async ({ page }) => {
    await page.goto("/signup");

    await page.fill('[data-testid="name-input"]', "أحمد محمد");
    await page.fill('[data-testid="email-input"]', "ahmed@example.com");
    await page.fill('[data-testid="password-input"]', "password123");
    await page.click('[data-testid="signup-button"]');

    await expect(
      page.locator('[data-testid="verification-message"]')
    ).toBeVisible();
  });
});
```

## 6. اختبارات الأداء (Performance Tests)

### 6.1 إعدادات الأداء

```typescript
// performance.test.ts
import { test, expect } from "@playwright/test";

test.describe("Performance Tests", () => {
  test("page load time should be under 3 seconds", async ({ page }) => {
    const startTime = Date.now();
    await page.goto("/");
    await page.waitForLoadState("networkidle");
    const loadTime = Date.now() - startTime;

    expect(loadTime).toBeLessThan(3000);
  });

  test("API response time should be under 500ms", async ({ page }) => {
    const response = await page.request.get("/api/products");
    expect(response.status()).toBe(200);

    const responseTime =
      response.timing().responseEnd - response.timing().requestStart;
    expect(responseTime).toBeLessThan(500);
  });
});
```

### 6.2 مراقبة الأداء

```javascript
// scripts/performance-monitor.js
const { chromium } = require("playwright");

async function measurePerformance() {
  const browser = await chromium.launch();
  const page = await browser.newPage();

  // قياس وقت التحميل
  const startTime = Date.now();
  await page.goto("http://localhost:3000");
  await page.waitForLoadState("networkidle");
  const loadTime = Date.now() - startTime;

  // قياس Core Web Vitals
  const metrics = await page.evaluate(() => {
    return new Promise((resolve) => {
      new PerformanceObserver((list) => {
        const entries = list.getEntries();
        const vitals = {};

        entries.forEach((entry) => {
          if (entry.name === "LCP") vitals.lcp = entry.value;
          if (entry.name === "FID") vitals.fid = entry.value;
          if (entry.name === "CLS") vitals.cls = entry.value;
        });

        resolve(vitals);
      }).observe({
        entryTypes: ["largest-contentful-paint", "first-input", "layout-shift"],
      });
    });
  });

  console.log("Performance Metrics:", {
    loadTime: `${loadTime}ms`,
    ...metrics,
  });

  await browser.close();
}

measurePerformance();
```

## 7. اختبارات الأمان (Security Tests)

### 7.1 اختبارات الأمان الأساسية

```typescript
// security.test.ts
import { test, expect } from "@playwright/test";

test.describe("Security Tests", () => {
  test("should prevent SQL injection in search", async ({ page }) => {
    await page.goto("/products");

    await page.fill('[data-testid="search-input"]', "'; DROP TABLE users; --");
    await page.click('[data-testid="search-button"]');

    // التحقق من عدم حدوث خطأ في قاعدة البيانات
    await expect(
      page.locator('[data-testid="error-message"]')
    ).not.toBeVisible();
  });

  test("should prevent XSS attacks", async ({ page }) => {
    await page.goto("/products");

    await page.fill(
      '[data-testid="search-input"]',
      '<script>alert("XSS")</script>'
    );
    await page.click('[data-testid="search-button"]');

    // التحقق من عدم تنفيذ السكريبت
    const alertHandled = await page.evaluate(() => {
      return (
        window.alert === undefined || !window.alert.toString().includes("XSS")
      );
    });

    expect(alertHandled).toBe(true);
  });

  test("should require authentication for protected routes", async ({
    page,
  }) => {
    await page.goto("/dashboard");

    // يجب إعادة التوجيه إلى صفحة تسجيل الدخول
    await expect(page).toHaveURL("/login");
  });
});
```

## 8. اختبارات إمكانية الوصول (Accessibility Tests)

### 8.1 إعدادات A11y Testing

```typescript
// accessibility.test.ts
import { test, expect } from "@playwright/test";
import AxeBuilder from "@axe-core/playwright";

test.describe("Accessibility Tests", () => {
  test("should not have accessibility violations", async ({ page }) => {
    await page.goto("/");

    const accessibilityScanResults = await new AxeBuilder({ page }).analyze();

    expect(accessibilityScanResults.violations).toEqual([]);
  });

  test("should have proper ARIA labels", async ({ page }) => {
    await page.goto("/products");

    const searchInput = page.locator('[data-testid="search-input"]');
    await expect(searchInput).toHaveAttribute("aria-label");

    const searchButton = page.locator('[data-testid="search-button"]');
    await expect(searchButton).toHaveAttribute("aria-label");
  });

  test("should support keyboard navigation", async ({ page }) => {
    await page.goto("/");

    // التنقل باستخدام Tab
    await page.keyboard.press("Tab");
    await page.keyboard.press("Tab");
    await page.keyboard.press("Tab");

    // التحقق من أن العنصر النشط مرئي
    const focusedElement = page.locator(":focus");
    await expect(focusedElement).toBeVisible();
  });
});
```

## 9. اختبارات RTL (Right-to-Left)

### 9.1 اختبارات دعم اللغة العربية

```typescript
// rtl.test.ts
import { test, expect } from "@playwright/test";

test.describe("RTL Support Tests", () => {
  test("should display Arabic text correctly", async ({ page }) => {
    await page.goto("/");

    const arabicText = page.locator("text=مرحباً بك في كليم");
    await expect(arabicText).toBeVisible();
  });

  test("should have correct text direction", async ({ page }) => {
    await page.goto("/");

    const body = page.locator("body");
    await expect(body).toHaveAttribute("dir", "rtl");
  });

  test("should align elements correctly in RTL", async ({ page }) => {
    await page.goto("/");

    const navigation = page.locator('[data-testid="navigation"]');
    const computedStyle = await navigation.evaluate((el) => {
      return window.getComputedStyle(el).textAlign;
    });

    expect(computedStyle).toBe("right");
  });
});
```

## 10. خطة التحسين

### 10.1 تحسينات قصيرة المدى

1. **زيادة تغطية الاختبارات**: الوصول لـ 90% تغطية
2. **تحسين أداء الاختبارات**: تقليل وقت التنفيذ
3. **إضافة اختبارات متقدمة**: اختبارات الأداء والأمان

### 10.2 تحسينات متوسطة المدى

1. **اختبارات الذكاء الاصطناعي**: اختبار نماذج AI
2. **اختبارات التكامل المتقدمة**: اختبارات microservices
3. **اختبارات التحميل**: اختبارات الضغط

### 10.3 تحسينات طويلة المدى

1. **اختبارات الذكاء الاصطناعي**: اختبار نماذج AI
2. **اختبارات التكامل المتقدمة**: اختبارات microservices
3. **اختبارات التحميل**: اختبارات الضغط

---

**آخر تحديث**: ديسمبر 2024  
**الإصدار**: 1.0.0  
**المسؤول**: فريق الجودة والاختبارات
