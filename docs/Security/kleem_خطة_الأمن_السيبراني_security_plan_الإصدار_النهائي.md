# Kleem — خطة الأمن السيبراني (Security Plan)

**الإصدار:** 1.0  
**التاريخ:** 15 أغسطس 2025  
**المالك:** فريق الأمن + المنصة (Kleem SecOps)

> الهدف: حماية سرية وسلامة وتوفّر بيانات Kleem وخدماته ضمن بيئة متعددة العملاء (Multi‑tenant) وقنوات متعددة (Omnichannel)، مع ذكاء اصطناعي يعتمد "الحقيقة قبل التوليد". هذه الخطة عملية وتعمل كمرجع تنفيذ وتشغيلي.

---

## 1) النطاق والأهداف
- يشمل: الواجهات (لوحة التاجر/الودجت/المتجر المصغّر)، API/Workers، n8n (الأوركستراتور)، قواعد البيانات (MongoDB/Qdrant)، التخزين (MinIO)، الكاش (Redis)، الرسائل (RabbitMQ)، وخدمات الـ Embedding/Extractor.  
- الأهداف:  
  1) تقليل سطح الهجوم.  
  2) إنهاء الحوادث سريعًا (Contain/Eradicate/Recover).  
  3) الحفاظ على التوافق مع SRS/Architecture/BRD.  
  4) الاستعداد للتوسع إلى K8s وامتثال إقليمي للبيانات.

---

## 2) نموذج التهديد (مختصر)
- **تطبيق/واجهة**: XSS/CSRF/SSRF، رفع ملفات ضارة، حقن (NoSQL/Command)، تسريب أسرار.  
- **المستخدم**: اختطاف جلسات، كلمات مرور ضعيفة، هجمات احتيال.  
- **البنية**: DDoS، اختراق حاويات، وصول غير مصرّح للبيانات، حركة داخلية غير مشفّرة.  
- **سلسلة التوريد**: حِزم NPM/OS بها ثغرات، مزوّدو قنوات/LLM.  
- **ذكاء/LLM**: Prompt Injection، تسريب سياق/مفاتيح، مخرجات مضللة.

---

## 3) تصنيف البيانات وسياسة التعامل
| الفئة | أمثلة | مستوى الحماية | الاحتفاظ الافتراضي |
|---|---|---|---|
| حسّاسة جدًا | كلمات مرور، مفاتيح، مفاتيح تشفير | تشفير حقلي + Vault + وصول محدود | لا تُحتفظ بالنص الصريح إطلاقًا |
| حسّاسة | محادثات العملاء، نوايا الشراء، بيانات المتجر | تشفير على مستوى التخزين + عزل مُستأجر + تحكم وصول | 12 شهرًا (قابل للتخصيص) |
| داخلية | سجلات تشغيل، مقاييس | تنقية PII، وصول فرق التشغيل فقط | 6–12 شهرًا |
| عامة | وثائق عامة، صفحات تسويق | حماية أساسية | حسب الحاجة |

**مبادئ:** تقليل البيانات (Minimization)، إخفاء الحقول في السجلات، حق النسيان والتصدير عند الطلب، عزل صارم لكل تاجر.

---

## 4) الهوية والوصول (IAM)
### 4.1 المصادقة
- JWT غير متماثل (**RS256/ES256**) مع مفاتيح مدارة في **Vault/KMS**.  
- **TTL** للـ Access Token: 15–30 دقيقة، **Refresh** بـ Rotation (كشف إعادة الاستخدام).  
- **MFA** إلزامي للأدمن والمستخدمين ذوي الحساسية؛ اختياري للتجار مع تشجيع.  
- مصادقة WebSocket بتمرير JWT آمن وتجديد دوري.

### 4.2 التفويض (RBAC)
- أدوار: **Owner/Admin، Agent، Viewer** (+ أدوار خدمة).  
- سياسات مسار + مستوى البيانات: لا استعلام بلا `merchantId` (حارس Query)، وقواعد افتراضية تفرض عزل المستأجر.  
- سجلات تدقيق لكل تغييرات الصلاحيات.

### 4.3 الحسابات الخدمية والأسرار
- أسرار التطبيق والمزوّدين في **Vault** مع **دوران مفاتيح** مُجدول.  
- سكوبات دقيقة للـ API Keys وWebhooks.  
- منع الأسرار في المستودعات (سكانر أسرار بالـ CI).

---

## 5) أمن التطبيق (AppSec)
### 5.1 Secure SDLC
- **SAST/DAST/Dependency Scanning** بكل بناء.  
- مراجعة كود ثنائية، فحوص ترخيص الحِزم، وSBOM.  
- فحوص بنيوية: ESLint/Prettier/Commit hooks.

### 5.2 تحقق المدخلات والمخرجات
- **Schema Validation** لكل API، قوائم Allow‑list للرفع (نوع/حجم/عدد).  
- **XSS**: ترميز/تنظيف المخرجات، **CSP** صارم (حظر inline/`eval`).  
- **CSRF**: SameSite + Anti‑CSRF Token + Double‑Submit.  
- **NoSQL/Command Injection**: ORM/Param binding؛ حظر `eval`، فصل أوامر النظام.  
- **SSRF**: حظر الاتصال لعناوين داخلية، قوائم نطاقات مسموحة للـ Extractor.  
- **ملفات الرفع**: AV (ClamAV)، فحص توقيع/نوع حقيقي، تخزين في مسار معزول، **Signed URLs**.

### 5.3 أمان الذكاء والـ LLM
- **Intent‑first + Tool‑gating**: لا رد للمنتجات دون أداة الحقيقة.  
- مصفيات Prompt Injection: قوالب نظام ثابتة، حجب تعليمات تجاوز السياسات، إزالة الروابط الخطرة.  
- تنظيف نصوص OCR/ASR قبل المعالجة.  
- منع تسريب المفاتيح والسياق عبر الطبقة الوسيطة.

### 5.4 إساءة الاستخدام والحدود
- **Rate Limiting** متعدد المستويات (IP/مستخدم/تاجر/خدمة)، **بُطء تدريجي**، وقوائم حظر تلقائي.  
- **Idempotency** لطلبات حساسة، **Replay Protection** للويبهوكس بالتوقيع والطابع الزمني.  
- قواعد رد آلي بعد الدوام (V1.1) مع حماية من التكرار.

---

## 6) أمن البيانات والتشفير
- **أثناء النقل**: TLS 1.3 لكل الاتصالات؛ mTLS داخليًا عند الإتاحة.  
- **أثناء التخزين**:  
  - MongoDB: تشفير قرص + **تشفير حقلي** لحقول حساسة (Per‑merchant keys).  
  - Qdrant: تشفير وحدات التخزين/اللقطات، تقييد الوصول الشبكي.  
  - MinIO: SSE‑S3 (AES‑256) + **Bucket Policies** + نسخ متماثل/نسخ احتياطي.  
  - Redis/RabbitMQ: قنوات خاصة + TLS + مصادقة قوية.  
- **إدارة المفاتيح**: Vault/KMS، دوران دوري، تقسيم صلاحيات إدارة المفاتيح، سجلات تدقيق.  
- **الاحتفاظ والحذف**: محادثات/أحداث 12 شهرًا افتراضيًا، تخصيص لكل تاجر، إجراءات **حق النسيان** و**تصدير** البيانات.

---

## 7) أمن البنية التحتية (InfraSec)
- **شبكات**: فصل شبكي (Front/Back)، لا منافذ مكشوفة لدوائر البيانات، جدران حماية على الحواف.  
- **حاويات**: مستخدم non‑root، ملفات نظام للقراءة فقط حيث أمكن، قيود موارد، تحديث صور منتظم.  
- **خوادم**: تقوية النظام (CIS)، تصحيحات أمنية تلقائية حرجة، SSH بمفاتيح فقط.  
- **Edge/WAF/DDoS**: طبقة حماية (Cloudflare/WAF)، قواعد Bot Management.  
- **K8s لاحقًا**: PSP/OPA، أسرار K8s عبر Vault، شبكات سياسات، HPA.

---

## 8) المراقبة والكشف (Detection)
- **Logs** مركزية (ELK/OpenSearch) مع إخفاء PII.  
- **Metrics** (Prometheus/Grafana) لأزمنة/أخطاء/طوابير.  
- **Tracing** (Jaeger) لتدفقات الحرجة.  
- **تنبيهات** محددة العتبات (توقّف خدمة، خطأ ≥ X%، زمن ≥ Yث، 429/5xx شاذة).  
- **قائمة الأسئلة غير المجابة** ولوحة الجودة للمراجعة والتدريب.

---

## 9) الاستجابة للحوادث (IR)
### 9.1 المراحل
1) **الكشف والتصعيد** → 2) **الاحتواء** (شبكي/حسابات/مفاتيح) → 3) **الاستئصال** (تصحيحات/إزالة شِفرات) → 4) **الاستعادة** (من نسخ نظيفة) → 5) **Postmortem** بمهل زمنية.

### 9.2 RACI مختصر
- **Incident Commander** (قائد الحادث)، **SecOps** (تحليل/أدلة)، **SRE** (استعادة/توسّع)، **Eng** (تصحيح)، **Comm** (تواصل خارجي).  
- قنوات اتصال موازية (Out‑of‑band) وخطة إعلام قانوني/عملاء عند الحاجة.

### 9.3 تمارين واختبارات
- محاكاة **DDoS/اختراق حساب/تسريب مفتاح** ربع سنويًا.  
- اختبار استعادة نسخ احتياطي **شهريًا**.

---

## 10) إدارة الثغرات والتغيير
- **Vuln Mgmt**: فحص أسبوعي لمكتبات النظام، CVE triage، تصحيح خلال **7 أيام حرجة/30 يومًا عالية**.  
- **Change Mgmt**: PRs مُراجَعة، تتبّع إصدار، إطلاق تدريجي، Rollback خطّي.  
- **Pentest** نصف سنوي + فحص OWASP ASVS.

---

## 11) المخاطر والضوابط (Risk & Controls Matrix)
| الخطر | الضابط | أداة/إجراء |
|---|---|---|
| XSS/CSRF | CSP/تنظيف/Anti‑CSRF | Helmet/DOMPurify/SameSite |
| Injection | Schema/Binding/حظر eval | Mongoose Validators/Param Binding |
| تسريب أسرار | Vault/سكانر أسرار/Least Privilege | Vault/Trufflehog/CI |
| Prompt Injection | قوالب نظام/Tool‑gating/فلترة | قواعد NLU + Quality Gate |
| DDoS | WAF/Rate Limit/Auto‑scale | Cloudflare/NGINX/Autoscaling |
| فقدان بيانات | نسخ مشفرة/اختبار استعادة | Snapshots/Recovery Drills |
| إساءة استخدام API | مفاتيح مقيّدة/حِصص/Idempotency | API Gateway/Redis |

---

## 12) خطوط أساس التهيئة (Baselines)
- **JWT**: RS256/ES256، TTL 15–30د، Refresh Rotation مع قائمة إلغاء.  
- **كلمات المرور**: ≥ 12 حرفًا، تعقيد، قفل بعد 5 محاولات/15 دقيقة.  
- **رفع ملفات**: أنواع مسموحة (jpg/png/webp/pdf/docx/xlsx)، حجم ≤ 10MB، فحص AV.  
- **TLS**: 1.3 فقط على الحافة، PFS، شهادات مجددة تلقائيًا.  
- **معدلات**:  
  - API عامة: 60 req/دقيقة/‏IP (قابلة للضبط)،  
  - تسجيل دخول: 5 محاولات/5 دقائق/‏IP،  
  - LLM/بحث: حصص لكل تاجر بحسب الخطة.  
- **الاحتفاظ**: محادثات/أحداث 12 شهرًا افتراضيًا (تغيير per‑merchant).  
- **RTO/RPO**: 4 ساعات / 1 ساعة.

---

## 13) الأطراف الثالثة والامتثال
- **تقييم مزوّدين** (قنوات/LLM/استضافة): مراجعة شهادات/التوافق (ISO 27001/CSA)، مواقع تخزين البيانات، شروط المعالجة (DPA).  
- **العقود**: بنود سرية، إشعار خرق، حدود مسؤولية.  
- **خصوصية**: شفافية الاستخدام، إعدادات مشاركة البيانات، سياسات طلب الحذف/التصدير.

---

## 14) خارطة طريق أمنية
- Q3‑Q4/2025: تقوية mTLS داخليًا، اعتماد Vault كامل، إدخال EDR للحاويات، تشغيل سياسات OPA.  
- Q1/2026: Mesh (Istio/Linkerd)، تصنيف آلي للبيانات الحساسة، Zero‑trust Segmentation، برنامج Bug‑Bounty.

---

**خاتمة**  
هذه الخطة قابلة للتنفيذ فورًا ضمن بيئة Docker الحالية، وتمهّد للانتقال إلى K8s. أي تغيير جذري في البنية أو القنوات يجب أن يقترن بمراجعة هذه الوثيقة وتحديث خطوط الأساس والضوابط المقابلة.

