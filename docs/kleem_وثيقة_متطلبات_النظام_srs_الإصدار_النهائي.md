# Kleem — وثيقة متطلبات النظام (System Requirements Specification)

**الإصدار:** 1.0  
**التاريخ:** 15 أغسطس 2025  
**المالك:** فريق Kleem (المنتج والهندسة والجودة)

---

## 1) المقدّمة
### 1.1 الغرض من الوثيقة
تحديد المتطلبات الوظيفية وغير الوظيفية لمنصة **Kleem** بما يضمن اتساق التنفيذ مع الرؤية والنطاق واحتياجات العمل.

### 1.2 نطاق النظام
منصة SaaS للدردشة الذكية متعددة القنوات للتجار العرب، مع **بحث دلالي على المنتجات**، **قاعدة معرفة** لكل تاجر، **متجر مصغّر** اختياري، وتكاملات مع متاجر خارجية. يديرها التاجر من لوحة موحّدة.

### 1.3 المراجع
- وثيقة رؤية المشروع (الإصدار 1.0).  
- وثيقة التصميم المعماري لمنصة Kleem.  
- وثيقة متطلبات العمل (BRD).  
- ملفات الـWorkflow الخاصة بالذكاء والتكاملات.

### 1.4 التعاريف والاختصارات (مختصر)
**ASR**: تحويل الكلام إلى نص. **OCR**: استخراج نص من الصور. **RAG**: استرجاع قبل التوليد. **Intent**: النيّة الدلالية للسؤال. **Order Intent**: نية الشراء. **Omnichannel**: إدارة القنوات من لوحة واحدة.

---

## 2) الوصف العام
### 2.1 منظور المنتج
خدمات مستقلة (Micro/Modular) تتواصل عبر REST/WebSocket وكيانات مشتركة (تاجر/عميل/محادثة/منتج/وثيقة معرفة/نية شراء). ودجت ويب قابل للتضمين + قنوات تواصل.

### 2.2 فئات المستخدمين
- **مالك/مدير المتجر** (Admin).  
- **مشغّل الدعم** (Agent).  
- **محلل/مدير نمو**.  
- **العميل النهائي (Shopper)**.

### 2.3 بيئة التشغيل
سحابي (Docker/K8s)، واجهات React/MUI، باك إند NestJS/TS، قاعدة MongoDB، Redis، تكاملات قنوات ومتاجر.

### 2.4 القيود
- دعم عربي كامل (فصحى ولهجات).  
- خصوصية وأمن عاليان.  
- زمن استجابة مُرضٍ للذكاء وللواجهات.

### 2.5 الافتراضات والاعتمادات
- توفّر واجهات APIs خارجية مستقرة لمزوّدي القنوات والمتاجر.  
- توفر بنية مراقبة وتنبيهات واسترداد نسخ.

---

## 3) المتطلبات الوظيفية (Functional Requirements)
> **تنبيه:** المتطلبات مُرقّمة حسب المجالات لسهولة التتبّع. لكل متطلب معيار قبول (AC).

### 3.1 المصادقة والتفويض (AUTH)
- **AUTH-001**: تسجيل دخول بالبريد/كلمة مرور مع إدارة جلسات.  
  **AC**: إنشاء/إنهاء جلسة، قفل تلقائي بعد خمول قابل للتهيئة.
- **AUTH-002**: أدوار وصلاحيات (مالك/مشغّل/قارئ).  
  **AC**: منع الوصول وفق الدور، سجلات محاولات ممنوعة.
- **AUTH-003**: دعم MFA اختياري.  
  **AC**: تفعيل/تعطيل لكل مستخدم، تسجيل نجاح/فشل.

### 3.2 القنوات والأومني‑قنال (CHAN)
- **CHAN-001**: دعم **الويب شات** (ودجت) و**تيليغرام** و**واتساب** في **V1**.  
  **AC**: استقبال/إرسال رسائل عبر القنوات الثلاث من لوحة واحدة.
- **CHAN-002**: لوحة موحّدة للمحادثات (Omnichannel Inbox).  
  **AC**: فلترة حسب القناة/الحالة/التاجر، إشعارات فورية.
- **CHAN-003**: خارطة طريق لتكامل **إنستغرام/فيسبوك** (V1.2+).  
  **AC**: وثيقة واجهات مبدئية وخطوات الاعتماد.

### 3.3 الدردشة والرسائل (CHAT)
- **CHAT-001**: رسائل نص/روابط/صور/صوت/ملفات (≤10MB).  
  **AC**: تحميل/تنزيل آمن، منع الامتدادات الخطرة.
- **CHAT-002**: حالة الكتابة والتسليم ووسوم المحادثة.  
  **AC**: بثّ عبر WebSocket وتخزين في DB.
- **CHAT-003**: بحث في سجل المحادثات وحفظ إشارات (Flags).  
  **AC**: نصي/زمني/حسب القناة.

### 3.4 الذكاء والنيّة (AI/INTENT)
- **AI-001**: توليد ردود عربية قصيرة بنبرة قابلة للتخصيص.  
  **AC**: قالب نبرة لكل تاجر، اختبار لغوي تلقائي.
- **INTENT-001**: **فهم النيّة** قبل اختيار المسار (منتج/معرفة/تصعيد).  
  **AC**: عند نيّة "منتج" يتم تشغيل مسار المنتجات، وإلا تُستخدم المعرفة/التصعيد.
- **AI-002**: قواعد **الحقيقة قبل التوليد** (RAG): لا إجابة عن المنتجات دون أدوات الحقيقة.  
  **AC**: منع رد المنتج إذا لم تُستدعَ أداة البحث بنجاح.

### 3.5 البحث الدلالي في المنتجات (PROD)
- **PROD-001**: استعلام دلالي يعيد الاسم/السعر/الرابط ومعرّف المنتج.  
  **AC**: رد يحتوي ≥ منتج واحد أو رسالة عدم التوفر + بدائل.
- **PROD-002**: استخراج الأقسام عند أسئلة استكشافية ("وش عندكم؟").  
  **AC**: قائمة أقسام قابلة للنقر/المتابعة.
- **PROD-003**: مسارات فشل واضحة (لا نتائج/انقطاع).  
  **AC**: رسالة واضحة + اقتراحات + تسجيل الحدث.

### 3.6 قاعدة المعرفة والتدريب (KB)
- **KB-001**: إنشاء/تحرير قاعدة معرفة لكل تاجر وفهرستها.  
  **AC**: CRUD للفئات/المقالات.
- **KB-002**: استيراد **Word/Excel/PDF** وروابط و**الأسئلة الشائعة**.  
  **AC**: استخراج النص وفهرسته، معاينة ما تم استخراجه.
- **KB-003**: بحث دلالي على المعرفة + الإصدارات والمراجعة قبل النشر.  
  **AC**: سجل مراجعات وموافقة نهائية.

### 3.7 التكاملات مع المتاجر (INTG)
- **INTG-001**: موصلات مع **Salla/Zid/Shopify/WooCommerce** (قراءة الكتالوج والروابط على الأقل في V1).  
  **AC**: سحب منتجات/فئات وروابط صالحة للعرض.
- **INTG-002**: الاستعلام عن حالة الطلب (إن توفر مصدر موثوق).  
  **AC**: جلب الحالة وعرضها مع رقم الطلب.
- **INTG-003**: نشر الودجت على متجر خارجي عبر سكربت تضمين.  
  **AC**: توليد كود جاهز مع مفتاح تاجر.

### 3.8 المتجر المصغّر (STF)
- **STF-001**: كتالوج خفيف (قائمة/تفاصيل) بثيم أساسي (شعار/لون/بانرات).  
  **AC**: عرض منتجات وروابطها، دعم البحث/الفلترة الأساسية.
- **STF-002**: **زر "الدردشة للشراء"** يمرّر سياق المنتج للمحادثة.  
  **AC**: فتح القناة المحددة وتمرير معرف المنتج/الرابط.
- **STF-003**: **جمع نية الشراء** وربطها بالعميل.  
  **AC**: سجل نوايا مع مصدر/تاريخ/منتج.

### 3.9 الودجت والويب شات (WIDG)
- **WIDG-001**: تخصيص المظهر (الألوان/الشعار/الحواف/اللغة).  
  **AC**: معاينة قبل النشر، كود تضمين خارجي.
- **WIDG-002**: سياسات افتتاحية ورسائل جاهزة وقواعد الرد الآلي (V1.1+).  
  **AC**: تشغيل/إيقاف وجداول زمنية.

### 3.10 التحليلات والتقارير (ANALYTICS)
- **AN-001**: جمع الأحداث (سؤال/رد/قناة/زمن استجابة/نتيجة البحث/نيّة/تقييم).  
  **AC**: مخطط زمني وتقارير يومية/أسبوعية/شهرية وتصدير CSV/PDF.
- **AN-002**: مؤشرات الأداء: الرضا، الحل الذاتي، زمن الاستجابة، التوفرية.  
  **AC**: لوحة تفاعلية مع فلاتر.
- **AN-003**: قائمة **الأسئلة غير المجابة** للتذكير والمعالجة.  
  **AC**: صفحة مراجعة وتعيين مسؤول وتتبّع إغلاق.

### 3.11 العملاء والنوايا (CRM)
- **CRM-001**: إنشاء سجل عميل تلقائي وربط القنوات به.  
  **AC**: توحيد هوية العميل عبر القنوات عندما يتاح.
- **CRM-002**: تتبع **Order Intent** لكل عميل.  
  **AC**: عرض تاريخ النوايا وارتباطها بالمنتجات.

### 3.12 الطلبات (ORDERS)
- **ORD-001**: استعلام حالة الطلب عبر مصادر موثوقة (إن توفرت).  
  **AC**: رقم الطلب + الحالة + رابط التتبع.

### 3.13 فهم الوسائط (MEDIA)
- **MEDIA-001**: **تحويل الصوت إلى نص** داخل المحادثة.  
  **AC**: دعم العربية، دقة ≥ مستوى مقبول ووقت معالجة معقول.
- **MEDIA-002**: **OCR** لاستخراج النص من الصور.  
  **AC**: استخراج نص قابل للبحث والتخزين في سياق المحادثة.
- **MEDIA-003**: قراءة المحتوى النصي من **Word/Excel/PDF**.  
  **AC**: تخزين المقتطفات المفيدة مع الميتاداتا.
- **MEDIA-004**: **رد صوتي** في خارطة الطريق (V2).

### 3.14 الذاكرة والسياق (MEM)
- **MEM-001**: نافذة ذاكرة محادثة لكل عميل (V1: آخر 10 محادثات).  
  **AC**: استدعاء أحدث التبادلات للسياق.
- **MEM-002**: **V2**: ملف عميل غني واسترجاع المحادثات الكاملة عبر القنوات.

### 3.15 التقييم والتعلّم (FDBK)
- **FDBK-001**: تقييم الردود داخل الودجت/القنوات.  
  **AC**: زر/اختصار للتقييم وتسجيل النتيجة.
- **FDBK-002**: تحويل **التقييمات السلبية** إلى إشارات تدريب (Vectors) والتحسين المستمر.  
  **AC**: مسار مراجعة وتتبّع أثر التصحيحات.

---

## 4) واجهات النظام الخارجية (External Interfaces)
### 4.1 واجهة المستخدم
- ودجت ويب (RTL/LTR)، تخصيص مظهر، دعم الجوال، اختصارات تقييم.

### 4.2 واجهات برمجة تطبيقات (REST)
- REST JSON مع Pagination/Filtering/Sorting وRate Limiting.  
- WebSocket للأحداث اللحظية (رسائل/حالة/تنبيهات).

### 4.3 واجهات القنوات
- تكامل بوت تيليغرام، واتساب (Business API)، الويب شات.  
- Webhooks قياسية لاستلام الرسائل والأحداث.

### 4.4 واجهات المتاجر الخارجية
- موصلات قراءة الكتالوج والطلبات (Salla/Zid/Shopify/WooCommerce).  
- خرائط حقول موحّدة وAdapters لأسماء الحقول المختلفة.

### 4.5 تنسيقات البيانات
- JSON UTF‑8، وقت بصيغة ISO‑8601، الأرقام بترميز قياسي، اللغات: العربية/الإنجليزية.

---

## 5) المتطلبات غير الوظيفية (Non‑Functional)
### 5.1 الأداء (Performance)
- واجهة المستخدم ≤ 2 ث، الذكاء ≤ 5 ث، تحميل الصفحات ≤ 3 ث.  
- 1000 مستخدم متزامن، 10k رسالة/دقيقة، نمو البيانات حتى 1TB مع ثبات الأداء.

### 5.2 الموثوقية والتوفرية (Reliability/Availability)
- توافرية شهرية **≥ 99.9%**.  
- RTO ≤ 4 ساعات، RPO ≤ 1 ساعة.  
- نسخ احتياطي دوري (يومي/أسبوعي/شهري) واختبارات استعادة.

### 5.3 الأمان (Security)
- HTTPS فقط، HSTS، منع الـMixed Content.  
- تشفير البيانات الساكنة (AES‑256)، كلمات المرور (bcrypt).  
- RBAC ومبدأ أقل صلاحية، كتلة IP/معدلات، جدران حماية للتطبيق.  
- سجلات تدقيق للوصول والعمليات الحساسة.

### 5.4 القابلية للتوسع (Scalability)
- تصميم أفقي، حاويات، Orchestrator (Kubernetes)، فصل مكوّنات كثيفة الحمل.  
- كاش Redis، قابلية Sharding/Replica لقاعدة البيانات.

### 5.5 قابلية الصيانة (Maintainability)
- معايير كود (ESLint/Prettier)، CI/CD، تغطية اختبارات ≥ 80% للوحدة.  
- وثائق واجهات وصناديق حيوية (Runbooks).

### 5.6 الرصد والمراقبة (Observability)
- مؤشرات Prometheus ولوحات Grafana، سجلات مركزية (ELK)، تتبع موزّع (Jaeger).  
- تنبيهات قابلة للتهيئة لأخطاء/زمن استجابة/معدلات.

### 5.7 التدويل والوصولية (i18n/a11y)
- دعم RTL، خطوط مناسبة عربية، مفاتيح ترجمة، تباين ألوان مناسب.  
- تسميات ARIA أساسية وإمكانية استخدام لوحة المفاتيح.

### 5.8 الخصوصية والامتثال
- الاحتفاظ بالبيانات وفق سياسة التاجر/البلد، إخفاء PII في السجلات، آليات حذف/تصدير بيانات العميل عند الطلب.

---

## 6) المتطلبات البيانية (Data Requirements)
**كيانات أساسية**: Merchant، Channel، Customer، Conversation، Message، Product، KnowledgeDoc، OrderIntent، Rating، Event.  
**سياسة الاحتفاظ**: المحادثات/الأحداث 12 شهرًا (قابلة للتخصيص)، المستندات حسب حاجة التاجر.  
**الفهرسة**: مؤشرات على (merchantId, customerId, createdAt) وجدولة لصيانة الفهارس.

---

## 7) القيود والاعتمادات
- اعتمادية على APIs القنوات والمتاجر؛ تغيّراتها قد تتطلب تكييفًا.  
- موارد سحابية كافية لأحمال الذكاء والفهرسة.

---

## 8) خارج النطاق (V1) وخارطة الطريق
- **خارج V1**: تكامل شركات الشحن المحلية، بوابات الدفع (اليمن/الخليج)، عربة متقدّمة/دفع داخل المحادثة، قنوات إنستغرام/فيسبوك، رد صوتي، فهم بصري متقدّم يتعدى نص الصور.  
- **V1.1**: قواعد **الرد الآلي**، لوحات نوايا الشراء، تحسين الودجت/التقارير.  
- **V1.2**: إنستغرام/فيسبوك، تخصيص مظهر المتجر المصغّر بشكل أعمق.  
- **V2**: ملف عميل غني (استرجاع كامل المحادثات)، ردود صوتية، وربط شحن/دفع.

---

## 9) التحقّق والقبول (Verification & Acceptance)
- تمارين تحميل (10k رسالة/دقيقة) وقياس SLA.  
- اختبارات أمن (OWASP ASVS) واختبارات اختراق مجدولة.  
- تتبّع مؤشرات الرضا/الاستجابة/الحل الذاتي.  
- سيناريوهات قبول لكل ميزة أساسية (منتج/معرفة/ودجت/تكامل قناة/متجر مصغّر).

---

## 10) الملاحق (Glossary مختصر)
**Intent‑first**: توجيه المسار وفق النيّة قبل اختيار الأداة.  
**Chat‑to‑Buy**: تحويل المحادثة إلى زيارة صفحة المنتج مع تمرير السياق.  
**Order Intent**: تسجيل رغبة الشراء لعميل محدد.

---

> **ملاحظة:** تحديث الأرقام/الأهداف يتم بالتنسيق مع BRD وخطة الإطلاق. أي تغيير جوهري يُسجّل كتعديل إصدار لهذه الوثيقة.

