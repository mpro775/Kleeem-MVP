# دليل الاختبار اليدوي — مصادقة العميل (Customer Auth)

> يغطي كل عمليات المصادقة الخاصة **بعميل المتجر** (Storefront): إرسال OTP، التحقق، تسجيل الدخول، الجلسة، وحماية المسارات.  
> **ملاحظة:** مصادقة التاجر/لوحة التحكم (تسجيل دخول بالبريد وكلمة المرور) وثيقة منفصلة.

---

## 1) نطاق الدليل

| البند | الوصف |
|--------|--------|
| **النطاق** | مصادقة عميل المتجر فقط (Customer): OTP، JWT عميل، مسارات `/customers/*` المحمية بـ CustomerGuard |
| **غير مشمول** | مصادقة التاجر/الأدمن (`/auth/login`, `/auth/register`, إلخ) |
| **المراجع** | `Backend: customers.controller.ts`, `customer-jwt.strategy.ts`, `otp.service.ts` |

---

## 2) البيئة والحسابات

| البند | القيمة (مثال — يعدّل حسب البيئة) |
|--------|-----------------------------------|
| **البيئة** | Staging / UAT |
| **Base URL API** | `https://<your-api>/api` أو `http://localhost:3000/api` |
| **معرّف تاجر للاختبار** | `merchantId` صالح (من لوحة التحكم أو قاعدة البيانات) |
| **جهة الاختبار** | Postman / متصفح + واجهة المتجر (إن وُجدت) |

---

## 3) قائمة العمليات (Process List)

1. **إرسال OTP** — العميل يطلب رمز تحقق على البريد أو الهاتف.
2. **التحقق من OTP وتسجيل الدخول** — إدخال الرمز الصحيح واستلام JWT عميل.
3. **تسجيل عميل جديد (Signup)** — التحقق من OTP مع اسم اختياري وإنشاء عميل جديد.
4. **الحصول على بياناتي (GET /customers/me)** — بعد تسجيل الدخول، جلب بيانات العميل الحالي.
5. **تحديث بياناتي (PATCH /customers/me)** — تحديث الاسم أو الموافقة التسويقية.
6. **استخدام JWT في مسارات محمية** — عناوين العميل (me/addresses)، طلباتي، إلخ.
7. **عميل محظور (isBlocked)** — التحقق من رفض الطلبات عند حظر العميل.
8. **انتهاء صلاحية / عدم صحة التوكن** — رفض الطلبات عند توكن منتهي أو غير صحيح.

---

## 4) حالات الاختبار حسب العملية

---

### العملية 1: إرسال OTP

**الـ API:** `POST /customers/otp/send`  
**Body:** `{ "merchantId": "<id>", "contact": "<email أو رقم هاتف>", "contactType": "email" | "phone" }`  
**الحدّ:** 3 طلبات في الدقيقة (Throttle).

#### السيناريو السعيد (Happy Path)

| المعرّف | CAUTH-SEND-001 |
|----------|-----------------|
| **العنوان** | إرسال OTP إلى بريد إلكتروني صحيح |
| **المتطلبات** | `merchantId` صالح، بيئة تعمل، خدمة إرسال البريد/الهاتف مفعّلة |
| **الخطوات** | 1. إرسال POST بالـ body: `merchantId`, `contact`: بريد صحيح (مثل `customer@example.com`), `contactType`: `email`. |
| **النتيجة المتوقعة** | 200، `{ "message": "تم إرسال رمز التحقق بنجاح" }`، ووصول رمز OTP إلى البريد (أو تسجيل في الـ log إن كان mock). |
| **الأولوية** | حرج |

#### تباينات (Variations)

| المعرّف | CAUTH-SEND-002 |
|----------|-----------------|
| **العنوان** | إرسال OTP إلى رقم هاتف صحيح |
| **الخطوات** | نفس الطلب مع `contact`: رقم هاتف بصيغة صحيحة (حسب التحقق في `otp.service`), `contactType`: `phone`. |
| **النتيجة المتوقعة** | 200، رسالة نجاح، ووصول OTP للهاتف (أو mock). |
| **الأولوية** | عالي |

#### سيناريوهات فشل وحالات حدية (Negative / Edge)

| المعرّف | العنوان | الخطوات | النتيجة المتوقعة | الأولوية |
|----------|---------|---------|-------------------|----------|
| CAUTH-SEND-003 | `merchantId` ناقص | إرسال body بدون `merchantId` أو قيمته فارغة | 400 مع رسالة تحقق (مطلوب) | عالي |
| CAUTH-SEND-004 | `contact` ناقص | body بدون `contact` أو فارغ | 400 | عالي |
| CAUTH-SEND-005 | `contactType` غير صالح | `contactType`: `"sms"` أو قيمة غير `email`/`phone` | 400 (تحقق من enum) | متوسط |
| CAUTH-SEND-006 | بريد بصيغة غير صحيحة | `contact`: `"not-an-email"`, `contactType`: `email` | 400 (تحقق من صيغة البريد) | عالي |
| CAUTH-SEND-007 | رقم هاتف بصيغة غير مقبولة | `contact`: قيمة لا تمر تحقق الهاتف في الخدمة, `contactType`: `phone` | 400 إن كان التحقق مفعّلاً | متوسط |
| CAUTH-SEND-008 | تجاوز حد الطلبات (Throttle) | إرسال 4 طلبات send خلال دقيقة واحدة بنفس المعطيات | الطلب الرابع: 429 Too Many Requests | عالي |
| CAUTH-SEND-009 | `merchantId` غير موجود | استخدام ObjectId لا يطابق تاجراً في النظام | حسب التصميم: 404 أو 200 (إن كان الإرسال لا يتحقق من وجود التاجر) | متوسط |

---

### العملية 2: التحقق من OTP وتسجيل الدخول

**الـ API:** `POST /customers/otp/verify`  
**Body:** `{ "merchantId", "contact", "contactType", "code" }`  
**الحدّ:** 5 طلبات في 5 دقائق.

#### السيناريو السعيد

| المعرّف | CAUTH-VERIFY-001 |
|----------|------------------|
| **العنوان** | التحقق برمز OTP صحيح — عميل موجود |
| **المتطلبات** | تم إرسال OTP مسبقاً ونفس الـ contact و merchantId، والعميل مسجّل سابقاً لهذا التاجر |
| **الخطوات** | 1. إرسال OTP (send). 2. إدخال الرمز المستلم في body: `code`, مع نفس `merchantId`, `contact`, `contactType`. 3. إرسال POST verify. |
| **النتيجة المتوقعة** | 200، `customer` (كائن العميل)، `accessToken` (JWT)، `isNewCustomer`: false. |
| **الأولوية** | حرج |

#### تباينات

| المعرّف | CAUTH-VERIFY-002 |
|----------|------------------|
| **العنوان** | التحقق برمز صحيح — عميل جديد (أول مرة) |
| **الخطوات** | نفس الخطوات مع contact لم يُستخدم من قبل لهذا التاجر. |
| **النتيجة المتوقعة** | 200، `customer` جديد، `accessToken`، `isNewCustomer`: true. |
| **الأولوية** | حرج |

#### سيناريوهات فشل وحالات حدية

| المعرّف | العنوان | الخطوات | النتيجة المتوقعة | الأولوية |
|----------|---------|---------|-------------------|----------|
| CAUTH-VERIFY-003 | رمز OTP خاطئ | إدخال `code` غير صحيح (مثلاً 000000) | 400 مع رسالة مناسبة (رمز غير صحيح أو منتهي) | حرج |
| CAUTH-VERIFY-004 | رمز OTP منتهي الصلاحية | استخدام رمز بعد انتهاء مدة صلاحية OTP في النظام | 400 | عالي |
| CAUTH-VERIFY-005 | عدم إرسال OTP مسبقاً | استدعاء verify مباشرة بدون send لنفس الـ contact/merchant | 400 (عدم وجود OTP أو انتهاء) | عالي |
| CAUTH-VERIFY-006 | `code` ناقص أو فارغ | body بدون `code` أو قيمته "" | 400 | عالي |
| CAUTH-VERIFY-007 | `merchantId` / `contact` / `contactType` غير متطابقة مع طلب الإرسال | استخدام merchantId أو contact مختلف عن الذي أُرسل له OTP | 400 إن كان التحقق مرتبطاً بالـ contact و merchantId | عالي |
| CAUTH-VERIFY-008 | تجاوز حد التحقق (5 في 5 دقائق) | تنفيذ 6 طلبات verify خلال 5 دقائق | 429 للطلبات الزائدة | متوسط |

---

### العملية 3: تسجيل عميل جديد (Signup)

**الـ API:** `POST /customers/signup`  
**Body:** نفس VerifyOtpDto مع حقل اختياري `name`.

#### السيناريو السعيد

| المعرّف | CAUTH-SIGNUP-001 |
|----------|------------------|
| **العنوان** | تسجيل دخول مع اسم اختياري |
| **الخطوات** | 1. send OTP. 2. POST signup بـ `merchantId`, `contact`, `contactType`, `code` (الصحيح), `name`: "أحمد". |
| **النتيجة المتوقعة** | 200، `customer` (الاسم = أحمد إن طُبّق)، `accessToken`، `isNewCustomer` true إن كان أول مرة. |
| **الأولوية** | عالي |

#### تباينات

| المعرّف | CAUTH-SIGNUP-002 |
|----------|------------------|
| **العنوان** | signup بدون اسم |
| **الخطوات** | نفس verify بدون `name`. |
| **النتيجة المتوقعة** | 200، عميل يُنشأ باسم افتراضي (مثل "عميل بريد إلكتروني" / "عميل هاتف"). |
| **الأولوية** | متوسط |

#### سيناريوهات فشل

| المعرّف | العنوان | النتيجة المتوقعة |
|----------|---------|-------------------|
| CAUTH-SIGNUP-003 | رمز OTP خاطئ في signup | 400 مثل verify |
| CAUTH-SIGNUP-004 | بيانات ناقصة (مثلاً بدون code) | 400 |

---

### العملية 4: الحصول على بياناتي (GET /customers/me)

**الـ API:** `GET /customers/me`  
**التوثيق:** `Authorization: Bearer <customer_accessToken>` (JWT الصادر من verify/signup).

#### السيناريو السعيد

| المعرّف | CAUTH-ME-001 |
|----------|--------------|
| **العنوان** | جلب بيانات العميل الحالي بجواز صالح |
| **الخطوات** | 1. تسجيل دخول عبر verify أو signup. 2. GET /customers/me مع header `Authorization: Bearer <accessToken>`. |
| **النتيجة المتوقعة** | 200، كائن العميل (اسم، بريد/هاتف، merchantId، إلخ). |
| **الأولوية** | حرج |

#### سيناريوهات فشل وحالات حدية

| المعرّف | العنوان | الخطوات | النتيجة المتوقعة | الأولوية |
|----------|---------|---------|-------------------|----------|
| CAUTH-ME-002 | عدم إرسال التوكن | GET بدون header Authorization | 401 Unauthorized | حرج |
| CAUTH-ME-003 | توكن منتهي الصلاحية | استخدام accessToken قديم (بعد انتهاء صلاحية JWT) | 401 | حرج |
| CAUTH-ME-004 | توكن تاجر/أدمن بدل عميل | استخدام JWT من /auth/login (role MERCHANT/ADMIN) | 401 (Invalid token for customer access) | عالي |
| CAUTH-ME-005 | توكن عميل محذوف | بعد حذف العميل من النظام، استخدام نفس التوكن | 401 (Customer not found) | متوسط |

---

### العملية 5: تحديث بياناتي (PATCH /customers/me)

**الـ API:** `PATCH /customers/me`  
**Body:** `{ "name"?: string, "marketingConsent"?: boolean }`

#### السيناريو السعيد

| المعرّف | CAUTH-UPD-001 |
|----------|---------------|
| **العنوان** | تحديث الاسم والموافقة التسويقية |
| **الخطوات** | 1. تسجيل دخول عميل. 2. PATCH /customers/me بـ `{ "name": "محمد", "marketingConsent": true }`. |
| **النتيجة المتوقعة** | 200، كائن العميل المحدّث (الاسم والـ marketingConsent كما أُرسل). |
| **الأولوية** | عالي |

#### تباينات

| المعرّف | العنوان | الخطوات | النتيجة المتوقعة |
|----------|---------|---------|-------------------|
| CAUTH-UPD-002 | تحديث الاسم فقط | PATCH بـ `{ "name": "..." }` | 200، الاسم محدّث |
| CAUTH-UPD-003 | تحديث الموافقة التسويقية فقط | PATCH بـ `{ "marketingConsent": false }` | 200، الحقل محدّث |

#### سيناريوهات فشل

| المعرّف | العنوان | النتيجة المتوقعة |
|----------|---------|-------------------|
| CAUTH-UPD-004 | عدم إرسال توكن | 401 |
| CAUTH-UPD-005 | توكن منتهي | 401 |

---

### العملية 6: استخدام JWT في مسارات محمية أخرى (عميل)

**مسارات مثال:** `GET/POST/PATCH/DELETE /customers/me/addresses`

#### السيناريو السعيد

| المعرّف | CAUTH-PROT-001 |
|----------|----------------|
| **العنوان** | الوصول لـ me/addresses بتوكن عميل صالح |
| **الخطوات** | 1. تسجيل دخول عميل. 2. GET /customers/me/addresses مع Bearer token. |
| **النتيجة المتوقعة** | 200 وقائمة العناوين (أو مصفوفة فارغة). |
| **الأولوية** | عالي |

#### سيناريوهات فشل

| المعرّف | العنوان | النتيجة المتوقعة |
|----------|---------|-------------------|
| CAUTH-PROT-002 | طلب بدون توكن لـ me/addresses | 401 |
| CAUTH-PROT-003 | توكن تاجر على مسار عميل | 401 |

---

### العملية 7: عميل محظور (isBlocked)

**المنطق:** في `CustomerJwtStrategy` إذا `customer.isBlocked === true` يُرمى `UnauthorizedException('Customer account is blocked')`.

#### السيناريو السعيد (سلوك متوقع)

| المعرّف | CAUTH-BLK-001 |
|----------|---------------|
| **العنوان** | رفض أي طلب بتوكن عميل محظور |
| **المتطلبات** | عميل موجود وتم تعيين `isBlocked: true` له (من لوحة التاجر). |
| **الخطوات** | 1. الحصول على accessToken لهذا العميل (قبل الحظر أو من جلسة سابقة). 2. GET /customers/me (أو أي مسار محمي بـ CustomerGuard). |
| **النتيجة المتوقعة** | 401 مع رسالة تدل على أن الحساب محظور (Customer account is blocked). |
| **الأولوية** | عالي |

#### تباين

| المعرّف | CAUTH-BLK-002 |
|----------|---------------|
| **العنوان** | بعد إلغاء الحظر، الطلبات تعمل مجدداً |
| **الخطوات** | إلغاء الحظر من لوحة التاجر، ثم إعادة استخدام نفس التوكن أو تسجيل دخول جديد. |
| **النتيجة المتوقعة** | 200 على /customers/me بعد إلغاء الحظر (مع توكن جديد إن انتهت الجلسة). |
| **الأولوية** | متوسط |

---

### العملية 8: انتهاء صلاحية التوكن وعدم صحته

| المعرّف | العنوان | الخطوات | النتيجة المتوقعة | الأولوية |
|----------|---------|---------|-------------------|----------|
| CAUTH-TOK-001 | JWT منتهي | استخدام accessToken بعد وقت انتهاء صلاحيته | 401 | حرج |
| CAUTH-TOK-002 | JWT معدّل (تزوير) | تغيير حرف في التوكن وإرساله | 401 | حرج |
| CAUTH-TOK-003 | JWT بتوقيع خاطئ (secret مختلف) | توكن صادر من بيئة أخرى | 401 | عالي |
| CAUTH-TOK-004 | customerId في الـ payload لا يوجد في DB | حذف العميل ثم استخدام التوكن القديم | 401 (Customer not found) | عالي |

---

## 5) ملخص الحالات وترتيب التنفيذ

| الأولوية | الحالات |
|----------|---------|
| **حرج** | CAUTH-SEND-001, CAUTH-VERIFY-001, CAUTH-VERIFY-002, CAUTH-VERIFY-003, CAUTH-ME-001, CAUTH-ME-002, CAUTH-ME-003, CAUTH-ME-004, CAUTH-BLK-001, CAUTH-TOK-001, CAUTH-TOK-002 |
| **عالي** | CAUTH-SEND-002, CAUTH-SEND-003–008, CAUTH-VERIFY-004–007, CAUTH-SIGNUP-001, CAUTH-ME-005, CAUTH-UPD-001, CAUTH-PROT-001–003, CAUTH-BLK-002, CAUTH-TOK-003–004 |
| **متوسط** | CAUTH-SEND-009, CAUTH-VERIFY-008, CAUTH-SIGNUP-002–004, CAUTH-UPD-002–005 |

**ترتيب مقترح للتنفيذ:**  
1) إرسال OTP (سعيد + أهم السلبيات).  
2) التحقق من OTP (سعيد، عميل جديد، رمز خاطئ، منتهي).  
3) GET/PATCH /customers/me (سعيد + بدون توكن + توكن منتهي + توكن تاجر).  
4) عميل محظور.  
5) انتهاء/تزوير التوكن.  
6) باقي التباينات والحدود (Throttle، حقول ناقصة، إلخ).

---

## 6) قائمة التحقق السريعة (Checklist)

يمكن استخدام الجدول التالي أثناء التنفيذ (✔ / ✘ / ملاحظات).

| المعرّف | الوصف | النتيجة | ملاحظات |
|----------|--------|---------|----------|
| CAUTH-SEND-001 | إرسال OTP بريد — سعيد | | |
| CAUTH-SEND-002 | إرسال OTP هاتف | | |
| CAUTH-SEND-003–009 | إرسال OTP — سلبيات وحدود | | |
| CAUTH-VERIFY-001 | verify عميل موجود | | |
| CAUTH-VERIFY-002 | verify عميل جديد | | |
| CAUTH-VERIFY-003–008 | verify — سلبيات وحدود | | |
| CAUTH-SIGNUP-001–004 | signup | | |
| CAUTH-ME-001–005 | GET me | | |
| CAUTH-UPD-001–005 | PATCH me | | |
| CAUTH-PROT-001–003 | مسارات محمية (مثل addresses) | | |
| CAUTH-BLK-001–002 | عميل محظور | | |
| CAUTH-TOK-001–004 | صلاحية/صحة التوكن | | |

---

## 7) مراجع تقنية سريعة

- **إرسال OTP:** `POST /api/customers/otp/send` — Throttle 3/دقيقة.
- **التحقق:** `POST /api/customers/otp/verify` — Throttle 5/5 دقائق.
- **تسجيل مع اسم:** `POST /api/customers/signup`.
- **بياناتي:** `GET /api/customers/me`, `PATCH /api/customers/me` — تحتاج `Authorization: Bearer <customer_accessToken>`.
- **نوع التواصل:** `contactType` إما `email` أو `phone` (حسب ContactType في النظام).

---

*آخر تحديث: فبراير 2025 — إصدار 1.0*
