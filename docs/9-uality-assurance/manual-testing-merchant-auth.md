# دليل الاختبار اليدوي — مصادقة التاجر (Merchant / Dashboard Auth)

> يغطي كل عمليات المصادقة الخاصة **بمستخدم لوحة التحكم** (التاجر/الأدمن): التسجيل، تسجيل الدخول، التحقق من البريد، استعادة كلمة المرور، التحديث، التأكد من التاجر، إكمال onboarding، تغيير كلمة المرور، Refresh، وتسجيل الخروج.  
> **ملاحظة:** مصادقة عميل المتجر (OTP) في [دليل مصادقة العميل](./manual-testing-customer-auth.md).

---

## 1) نطاق الدليل

| البند         | الوصف                                                                                                              |
| ------------- | ------------------------------------------------------------------------------------------------------------------ |
| **النطاق**    | مصادقة مستخدم لوحة التحكم: `/auth/*` (تسجيل، دخول، تحقق بريد، كلمة مرور، جلسة، خروج) ومسارات محمية بـ JwtAuthGuard |
| **غير مشمول** | مصادقة عميل المتجر (OTP عبر `/customers/otp/*`)                                                                    |
| **المراجع**   | `Backend: auth.controller.ts`, `auth.service.ts`, `jwt.strategy.ts`                                                |

---

## 2) البيئة والحسابات

| البند                  | القيمة (مثال — يعدّل حسب البيئة)                                                                                |
| ---------------------- | --------------------------------------------------------------------------------------------------------------- |
| **البيئة**             | Staging / UAT                                                                                                   |
| **Base URL API**       | `https://<your-api>/api` أو `http://localhost:3000/api`                                                         |
| **حساب تاجر للاختبار** | بريد + كلمة مرور مستخدم مسجّل ومُتحقق من بريده                                                                  |
| **جهة الاختبار**       | Postman / متصفح (لوحة التحكم)، مع دعم Cookies إن وُجد (لـ refresh/logout)                                       |
| **ملاحظة**             | تسجيل الدخول يُرجع accessToken + refreshToken وقد يضبط cookies (HttpOnly)؛ Refresh قد يتطلب CSRF إن كان مفعّلاً |

---

## 3) قائمة العمليات (Process List)

1. **التسجيل (Register)** — إنشاء حساب تاجر جديد (بريد، كلمة مرور، اسم).
2. **تسجيل الدخول (Login)** — الدخول بالبريد وكلمة المرور واستلام التوكنات.
3. **إعادة إرسال رمز التحقق (Resend verification)** — طلب رمز تحقق بريد جديد.
4. **التحقق من البريد (Verify email)** — إدخال الرمز المُرسل وتفعيل الحساب.
5. **طلب إعادة تعيين كلمة المرور (Forgot password)** — إرسال رابط إعادة التعيين إلى البريد.
6. **التحقق من صلاحية رابط إعادة التعيين (Validate reset token)** — التحقق من أن الرابط صالح قبل عرض نموذج تعيين كلمة مرور جديدة.
7. **إعادة تعيين كلمة المرور (Reset password)** — تعيين كلمة مرور جديدة عبر الرابط المرسل.
8. **التأكد من وجود التاجر (Ensure merchant)** — إنشاء/التحقق من ربط المستخدم بتاجر (بعد الدخول).
9. **إكمال الـ onboarding (Onboarding complete)** — تعليم firstLogin = false بعد جولة التعريف.
10. **تغيير كلمة المرور (Change password)** — تغيير كلمة المرور من داخل الحساب (يتطلب الدخول).
11. **تحديث التوكن (Refresh)** — استصدار accessToken جديد باستخدام refreshToken.
12. **تسجيل الخروج (Logout)** — إبطال الجلسة الحالية ومسح cookies.
13. **تسجيل الخروج من كل الأجهزة (Logout all)** — إبطال كل جلسات المستخدم.

---

## 4) حالات الاختبار حسب العملية

---

### العملية 1: التسجيل (Register)

**الـ API:** `POST /auth/register`  
**Body:** `{ "email", "password", "confirmPassword", "name" }` — كلمة المرور والاسم: 8 أحرف و 3 أحرف على الأقل على التوالي، و`confirmPassword` يطابق `password`.  
**الحدّ:** افتراضي 5 طلبات في 60 ثانية (AUTH_REGISTER_TTL / AUTH_REGISTER_LIMIT).

#### السيناريو السعيد (Happy Path)

| المعرّف              | MAUTH-REG-001                                                                                                                                                    |
| -------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **العنوان**          | تسجيل تاجر جديد ببيانات صحيحة                                                                                                                                    |
| **المتطلبات**        | التسجيل غير معطّل (DISABLE_USER_SIGNUP)، بريد غير مستخدم مسبقاً                                                                                                  |
| **الخطوات**          | إرسال POST بـ email صحيح، password ≥8 أحرف، confirmPassword مطابق، name ≥3 أحرف.                                                                                 |
| **النتيجة المتوقعة** | 201، `accessToken`، `user` (id, name, email, role: MERCHANT, merchantId: null, firstLogin: true, emailVerified: false). إرسال بريد تحقق (إن كانت الخدمة مفعّلة). |
| **الأولوية**         | حرج                                                                                                                                                              |

#### تباينات (Variations)

| المعرّف              | MAUTH-REG-002                                                            |
| -------------------- | ------------------------------------------------------------------------ |
| **العنوان**          | تسجيل ثم التحقق من البريد — نفس المستخدم يكمّل verify-email لاحقاً       |
| **الخطوات**          | 1. Register. 2. استلام رمز التحقق من البريد. 3. POST /auth/verify-email. |
| **النتيجة المتوقعة** | بعد Verify: 200، accessToken، user مع emailVerified: true.               |
| **الأولوية**         | حرج                                                                      |

#### سيناريوهات فشل وحالات حدية (Negative / Edge)

| المعرّف       | العنوان                             | الخطوات                                    | النتيجة المتوقعة                           | الأولوية |
| ------------- | ----------------------------------- | ------------------------------------------ | ------------------------------------------ | -------- |
| MAUTH-REG-003 | البريد مستخدم مسبقاً                | نفس البريد مسجّل من قبل                    | 409 أو 400 مع رسالة (البريد مستخدم مسبقاً) | حرج      |
| MAUTH-REG-004 | بريد بصيغة غير صحيحة                | email: "not-email"                         | 400 (تحقق من صيغة البريد)                  | عالي     |
| MAUTH-REG-005 | كلمة مرور أقصر من 8 أحرف            | password: "1234567"                        | 400 (minLength)                            | عالي     |
| MAUTH-REG-006 | تأكيد كلمة المرور غير مطابق         | confirmPassword ≠ password                 | 400 (كلمتا المرور غير متطابقتين)           | عالي     |
| MAUTH-REG-007 | اسم أقصر من 3 أحرف                  | name: "ab"                                 | 400 (minLength)                            | متوسط    |
| MAUTH-REG-008 | حقل ناقص (مثلاً بدون name أو email) | حذف حقل مطلوب من الـ body                  | 400                                        | عالي     |
| MAUTH-REG-009 | التسجيل معطّل (DISABLE_USER_SIGNUP) | تفعيل المتغير ثم محاولة تسجيل              | 400 (التسجيل مؤقتاً متوقف)                 | عالي     |
| MAUTH-REG-010 | تجاوز حد الطلبات (Throttle)         | أكثر من 5 تسجيلات في الدقيقة من نفس المصدر | 429                                        | متوسط    |

---

### العملية 2: تسجيل الدخول (Login)

**الـ API:** `POST /auth/login`  
**Body:** `{ "email", "password" }`  
**الحدّ:** افتراضي 5 طلبات في 60 ثانية. قد يُضبط cookies (accessToken, refreshToken) و CSRF.

#### السيناريو السعيد (Happy Path)

| المعرّف              | MAUTH-LOGIN-001                                                                                                             |
| -------------------- | --------------------------------------------------------------------------------------------------------------------------- |
| **العنوان**          | تسجيل دخول ببريد وكلمة مرور صحيحين وتاجر مُتحقق من بريده                                                                    |
| **المتطلبات**        | مستخدم موجود، emailVerified: true، الحساب والتاجر غير معطّلين                                                               |
| **الخطوات**          | POST /auth/login بـ email و password صحيحين.                                                                                |
| **النتيجة المتوقعة** | 200، accessToken، refreshToken، user (id, name, email, role, merchantId, firstLogin, emailVerified). وضبط cookies إن وُجدت. |
| **الأولوية**         | حرج                                                                                                                         |

#### تباينات (Variations)

| المعرّف              | MAUTH-LOGIN-002                     |
| -------------------- | ----------------------------------- |
| **العنوان**          | تسجيل دخول أدمن (إن وُجد دور ADMIN) |
| **الخطوات**          | نفس الطلب بحساب role: ADMIN.        |
| **النتيجة المتوقعة** | 200، user.role: ADMIN.              |
| **الأولوية**         | عالي                                |

#### سيناريوهات فشل وحالات حدية (Negative / Edge)

| المعرّف         | العنوان                      | الخطوات                                  | النتيجة المتوقعة                  | الأولوية |
| --------------- | ---------------------------- | ---------------------------------------- | --------------------------------- | -------- |
| MAUTH-LOGIN-003 | بريد أو كلمة مرور خاطئة      | password خاطئة أو email غير موجود        | 400 (بيانات الدخول غير صحيحة)     | حرج      |
| MAUTH-LOGIN-004 | البريد غير مُتحقق منه        | مستخدم مسجّل لكن لم ينفّذ verify-email   | 400 (البريد غير مُتحقق منه)       | حرج      |
| MAUTH-LOGIN-005 | الحساب معطّل (active: false) | مستخدم معطّل من الإدارة                  | 400 (الحساب معطّل)                | عالي     |
| MAUTH-LOGIN-006 | التاجر معطّل أو محذوف        | مستخدم مرتبط بتاجر inactive أو deletedAt | 400 (تم إيقاف حساب التاجر مؤقتًا) | عالي     |
| MAUTH-LOGIN-007 | حقل ناقص أو بريد غير صالح    | body بدون password أو email بصيغة خاطئة  | 400                               | عالي     |
| MAUTH-LOGIN-008 | تجاوز حد الطلبات (Throttle)  | أكثر من 5 محاولات دخول في الدقيقة        | 429                               | عالي     |

---

### العملية 3: إعادة إرسال رمز التحقق (Resend verification)

**الـ API:** `POST /auth/resend-verification`  
**Body:** `{ "email" }`  
**الحدّ:** افتراضي 3 طلبات في 60 ثانية.

#### السيناريو السعيد (Happy Path)

| المعرّف              | MAUTH-RESEND-001                                                                         |
| -------------------- | ---------------------------------------------------------------------------------------- |
| **العنوان**          | إعادة إرسال رمز التحقق لبريد مسجّل وغير مُتحقق منه                                       |
| **المتطلبات**        | مستخدم موجود و emailVerified: false، ومرّت مدة كافية منذ آخر إرسال (نافذة إعادة الإرسال) |
| **الخطوات**          | POST /auth/resend-verification بـ email المستخدم.                                        |
| **النتيجة المتوقعة** | 200، رسالة نجاح. وصول بريد تحقق جديد (أو تسجيل في الـ log).                              |
| **الأولوية**         | عالي                                                                                     |

#### سيناريوهات فشل وحالات حدية (Negative / Edge)

| المعرّف          | العنوان                            | الخطوات                                     | النتيجة المتوقعة                               | الأولوية |
| ---------------- | ---------------------------------- | ------------------------------------------- | ---------------------------------------------- | -------- |
| MAUTH-RESEND-002 | البريد غير مسجّل                   | email لا يطابق أي مستخدم                    | 400 (البريد غير مسجّل)                         | عالي     |
| MAUTH-RESEND-003 | البريد مُتحقق منه مسبقاً           | مستخدم لديه emailVerified: true             | 400 (البريد مُتحقق منه مسبقاً)                 | عالي     |
| MAUTH-RESEND-004 | إعادة الطلب خلال نافذة منع التكرار | طلب ثانٍ خلال دقيقة من الأول (نفس المستخدم) | 200 بدون إرسال بريد جديد (سلوك التصميم الحالي) | متوسط    |
| MAUTH-RESEND-005 | تجاوز حد الطلبات                   | أكثر من 3 طلبات في الدقيقة                  | 429                                            | متوسط    |

---

### العملية 4: التحقق من البريد (Verify email)

**الـ API:** `POST /auth/verify-email`  
**Body:** `{ "email", "code" }` — الرمز 6 أرقام.  
**الحدّ:** افتراضي 5 طلبات في 60 ثانية.

#### السيناريو السعيد (Happy Path)

| المعرّف              | MAUTH-VERIFY-001                                                                      |
| -------------------- | ------------------------------------------------------------------------------------- |
| **العنوان**          | التحقق برمز صحيح خلال صلاحية الرمز                                                    |
| **المتطلبات**        | مستخدم مسجّل، تم إرسال رمز تحقق (register أو resend)، الرمز لم ينتهِ (مثلاً 15 دقيقة) |
| **الخطوات**          | POST /auth/verify-email بـ email المستخدم و code المستلم.                             |
| **النتيجة المتوقعة** | 200، accessToken، user (emailVerified: true، وربما إنشاء/ربط تاجر merchantId).        |
| **الأولوية**         | حرج                                                                                   |

#### سيناريوهات فشل وحالات حدية (Negative / Edge)

| المعرّف          | العنوان             | الخطوات                                         | النتيجة المتوقعة              | الأولوية |
| ---------------- | ------------------- | ----------------------------------------------- | ----------------------------- | -------- |
| MAUTH-VERIFY-002 | رمز خاطئ            | code غير صحيح                                   | 400 (رمز التحقق غير صحيح)     | حرج      |
| MAUTH-VERIFY-003 | رمز منتهي الصلاحية  | استخدام الرمز بعد انتهاء المدة (مثلاً 15 دقيقة) | 400 (انتهت صلاحية رمز التحقق) | عالي     |
| MAUTH-VERIFY-004 | بريد غير مسجّل      | email لا يطابق مستخدماً                         | 400 (رمز غير صحيح أو منتهي)   | عالي     |
| MAUTH-VERIFY-005 | رمز بطول غير 6 أحرف | code: "12345" أو "1234567"                      | 400 (تحقق الطول)              | متوسط    |
| MAUTH-VERIFY-006 | تجاوز حد الطلبات    | أكثر من 5 طلبات في الدقيقة                      | 429                           | متوسط    |

---

### العملية 5: طلب إعادة تعيين كلمة المرور (Forgot password)

**الـ API:** `POST /auth/forgot-password`  
**Body:** `{ "email" }`  
**الحدّ:** افتراضي 3 طلبات في 300 ثانية (5 دقائق).  
**ملاحظة:** لأسباب أمنية قد يُرجع 200 حتى لو البريد غير مسجّل (لا كشف عن وجود الحساب).

#### السيناريو السعيد (Happy Path)

| المعرّف              | MAUTH-FORGOT-001                                                                |
| -------------------- | ------------------------------------------------------------------------------- |
| **العنوان**          | طلب إعادة تعيين كلمة مرور لبريد مسجّل                                           |
| **المتطلبات**        | مستخدم موجود، ومرّت مدة كافية منذ آخر طلب reset (نافذة منع التكرار)             |
| **الخطوات**          | POST /auth/forgot-password بـ email المستخدم.                                   |
| **النتيجة المتوقعة** | 200، status: "ok"، message. وصول بريد يحتوي رابط إعادة التعيين (token + email). |
| **الأولوية**         | حرج                                                                             |

#### تباينات (Variations)

| المعرّف              | MAUTH-FORGOT-002                                               |
| -------------------- | -------------------------------------------------------------- |
| **العنوان**          | طلب إعادة تعيين لبريد غير مسجّل                                |
| **الخطوات**          | POST بـ email لا يطابق أي مستخدم.                              |
| **النتيجة المتوقعة** | 200 مع نفس الرسالة (لا كشف عن عدم وجود الحساب). لا إرسال بريد. |
| **الأولوية**         | عالي                                                           |

#### سيناريوهات فشل وحالات حدية (Negative / Edge)

| المعرّف          | العنوان              | الخطوات                    | النتيجة المتوقعة | الأولوية |
| ---------------- | -------------------- | -------------------------- | ---------------- | -------- |
| MAUTH-FORGOT-003 | بريد بصيغة غير صحيحة | email: "invalid"           | 400              | عالي     |
| MAUTH-FORGOT-004 | تجاوز حد الطلبات     | أكثر من 3 طلبات في 5 دقائق | 429              | عالي     |

---

### العملية 6: التحقق من صلاحية رابط إعادة التعيين (Validate reset token)

**الـ API:** `GET /auth/reset-password/validate?email=...&token=...`  
**ملاحظة:** عادةً يُستدعى من صفحة إعادة التعيين (المستخدم غير مسجّل الدخول). إن كان الـ API يفرض JWT عالمياً فقد يُرجع 401 بدون توكن؛ في هذه الحالة إما جعل هذا المسار عاماً أو استدعاؤه دون إرسال توكن.

#### السيناريو السعيد (Happy Path)

| المعرّف              | MAUTH-VALID-001                                                                |
| -------------------- | ------------------------------------------------------------------------------ |
| **العنوان**          | التحقق من رابط صالح (token + email صحيحان ولم ينتهيا)                          |
| **المتطلبات**        | تم طلب forgot-password مسبقاً واستلام الرابط، الرابط لم ينتهِ (مثلاً 30 دقيقة) |
| **الخطوات**          | GET /auth/reset-password/validate مع query email و token من الرابط.            |
| **النتيجة المتوقعة** | 200، `{ "valid": true }`.                                                      |
| **الأولوية**         | عالي                                                                           |

#### سيناريوهات فشل وحالات حدية (Negative / Edge)

| المعرّف         | العنوان                                       | الخطوات                            | النتيجة المتوقعة          | الأولوية |
| --------------- | --------------------------------------------- | ---------------------------------- | ------------------------- | -------- |
| MAUTH-VALID-002 | token خاطئ أو منتهي                           | token معدّل أو منتهي الصلاحية      | 200، `{ "valid": false }` | عالي     |
| MAUTH-VALID-003 | email لا يطابق المستخدم الذي صدر له الـ token | استخدام email آخر مع نفس الـ token | 200، `{ "valid": false }` | متوسط    |
| MAUTH-VALID-004 | نقص email أو token في الـ query               | حذف أحد المعاملين                  | 400 أو valid: false       | متوسط    |

---

### العملية 7: إعادة تعيين كلمة المرور (Reset password)

**الـ API:** `POST /auth/reset-password`  
**Body:** `{ "email", "token", "newPassword", "confirmPassword" }` — كلمة المرور الجديدة ≥8 أحرف، و confirmPassword يطابق newPassword.  
**الحدّ:** افتراضي 5 طلبات في 300 ثانية.

#### السيناريو السعيد (Happy Path)

| المعرّف              | MAUTH-RESET-001                                                                                               |
| -------------------- | ------------------------------------------------------------------------------------------------------------- |
| **العنوان**          | إعادة تعيين كلمة المرور برابط صالح وكلمة جديدة صحيحة                                                          |
| **المتطلبات**        | token صالح وغير منتهٍ، وتم استلامه من نفس المستخدم (email).                                                   |
| **الخطوات**          | POST /auth/reset-password بـ email، token من الرابط، newPassword و confirmPassword متطابقان وطول كل منهما ≥8. |
| **النتيجة المتوقعة** | 200، status: "ok"، message. إمكانية تسجيل الدخول بالكلمة الجديدة.                                             |
| **الأولوية**         | حرج                                                                                                           |

#### سيناريوهات فشل وحالات حدية (Negative / Edge)

| المعرّف         | العنوان                        | الخطوات                                 | النتيجة المتوقعة                                                        | الأولوية |
| --------------- | ------------------------------ | --------------------------------------- | ----------------------------------------------------------------------- | -------- |
| MAUTH-RESET-002 | token خاطئ أو منتهي            | token معدّل أو منتهي                    | 200 بدون تغيير (الخدمة تُرجع 200 ولا تكشف سبب الفشل) أو 400 حسب التصميم | عالي     |
| MAUTH-RESET-003 | newPassword ≠ confirmPassword  | قيمتان مختلفتان                         | 400 (كلمتا المرور غير متطابقتين)                                        | حرج      |
| MAUTH-RESET-004 | كلمة مرور جديدة أقصر من 8 أحرف | newPassword: "1234567"                  | 400 (minLength)                                                         | عالي     |
| MAUTH-RESET-005 | حقول ناقصة                     | عدم إرسال token أو email أو newPassword | 400                                                                     | عالي     |

---

### العملية 8: التأكد من وجود التاجر (Ensure merchant)

**الـ API:** `POST /auth/ensure-merchant`  
**التوثيق:** `Authorization: Bearer <accessToken>` (JWT مستخدم لوحة التحكم).

#### السيناريو السعيد (Happy Path)

| المعرّف              | MAUTH-ENSURE-001                                                                     |
| -------------------- | ------------------------------------------------------------------------------------ |
| **العنوان**          | مستخدم لديه تاجر مسبقاً — التحقق من الربط فقط                                        |
| **المتطلبات**        | مستخدم مسجّل الدخول ومرتبط بـ merchantId، والتاجر نشط وغير محذوف                     |
| **الخطوات**          | POST /auth/ensure-merchant مع Bearer accessToken.                                    |
| **النتيجة المتوقعة** | 200، accessToken (جديد)، user (merchantId معبّأ، firstLogin، emailVerified، active). |
| **الأولوية**         | حرج                                                                                  |

#### تباينات (Variations)

| المعرّف              | MAUTH-ENSURE-002                                                                                 |
| -------------------- | ------------------------------------------------------------------------------------------------ |
| **العنوان**          | مستخدم بدون تاجر — إنشاء تاجر جديد وربطه                                                         |
| **المتطلبات**        | مستخدم مسجّل الدخول و emailVerified: true، وبدون merchantId، و DISABLE_MERCHANT_SIGNUP غير مفعّل |
| **الخطوات**          | POST /auth/ensure-merchant مع Bearer token.                                                      |
| **النتيجة المتوقعة** | 200، user مع merchantId جديد.                                                                    |
| **الأولوية**         | حرج                                                                                              |

#### سيناريوهات فشل وحالات حدية (Negative / Edge)

| المعرّف          | العنوان                                    | الخطوات                                       | النتيجة المتوقعة                         | الأولوية |
| ---------------- | ------------------------------------------ | --------------------------------------------- | ---------------------------------------- | -------- |
| MAUTH-ENSURE-003 | عدم إرسال توكن                             | طلب بدون Authorization                        | 401                                      | حرج      |
| MAUTH-ENSURE-004 | توكن منتهي أو غير صالح                     | Bearer token منتهي أو معدّل                   | 401                                      | حرج      |
| MAUTH-ENSURE-005 | البريد غير مُتحقق منه عند إنشاء تاجر       | مستخدم بدون merchantId و emailVerified: false | 400 (البريد غير مُتحقق منه)              | عالي     |
| MAUTH-ENSURE-006 | إنشاء تجار معطّل (DISABLE_MERCHANT_SIGNUP) | تفعيل المتغير ومستخدم بدون تاجر               | 400 (إنشاء حسابات تجار جدد مؤقتاً متوقف) | عالي     |
| MAUTH-ENSURE-007 | التاجر الحالي معطّل أو محذوف               | مستخدم مرتبط بتاجر inactive أو deletedAt      | 400 (تم إيقاف حساب التاجر مؤقتًا)        | عالي     |

---

### العملية 9: إكمال الـ onboarding (Onboarding complete)

**الـ API:** `POST /auth/onboarding-complete`  
**التوثيق:** `Authorization: Bearer <accessToken>`.

#### السيناريو السعيد (Happy Path)

| المعرّف              | MAUTH-ONB-001                                       |
| -------------------- | --------------------------------------------------- |
| **العنوان**          | تعليم إكمال جولة التعريف — firstLogin يصبح false    |
| **المتطلبات**        | مستخدم مسجّل الدخول                                 |
| **الخطوات**          | POST /auth/onboarding-complete مع Bearer token.     |
| **النتيجة المتوقعة** | 200، accessToken (جديد)، user مع firstLogin: false. |
| **الأولوية**         | عالي                                                |

#### سيناريوهات فشل وحالات حدية (Negative / Edge)

| المعرّف       | العنوان                           | الخطوات                           | النتيجة المتوقعة     | الأولوية |
| ------------- | --------------------------------- | --------------------------------- | -------------------- | -------- |
| MAUTH-ONB-002 | عدم إرسال توكن                    | طلب بدون Authorization: Bearer    | 401                  | عالي     |
| MAUTH-ONB-003 | userId غير موجود في النظام (نادر) | توكن لـ userId محذوف أو غير موجود | 400 (user not found) | متوسط    |

---

### العملية 10: تغيير كلمة المرور (Change password)

**الـ API:** `POST /auth/change-password`  
**التوثيق:** `Authorization: Bearer <accessToken>`.  
**Body:** `{ "currentPassword", "newPassword", "confirmPassword" }` — الجديدة والتأكيد ≥8 أحرف ومتطابقان.  
**الحدّ:** افتراضي 5 طلبات في 300 ثانية.

#### السيناريو السعيد (Happy Path)

| المعرّف              | MAUTH-CHG-001                                                                                                                      |
| -------------------- | ---------------------------------------------------------------------------------------------------------------------------------- |
| **العنوان**          | تغيير كلمة المرور بكلمة حالية صحيحة وجديدة متطابقة                                                                                 |
| **المتطلبات**        | مستخدم مسجّل الدخول                                                                                                                |
| **الخطوات**          | POST /auth/change-password مع Bearer token و body: currentPassword صحيحة، newPassword و confirmPassword متطابقان وطول كل منهما ≥8. |
| **النتيجة المتوقعة** | 200، message نجاح. الدخول لاحقاً بالكلمة الجديدة فقط.                                                                              |
| **الأولوية**         | حرج                                                                                                                                |

#### سيناريوهات فشل وحالات حدية (Negative / Edge)

| المعرّف       | العنوان                        | الخطوات                                              | النتيجة المتوقعة                    | الأولوية |
| ------------- | ------------------------------ | ---------------------------------------------------- | ----------------------------------- | -------- |
| MAUTH-CHG-002 | كلمة المرور الحالية خاطئة      | currentPassword غير صحيحة                            | 400 (كلمة المرور الحالية غير صحيحة) | حرج      |
| MAUTH-CHG-003 | newPassword ≠ confirmPassword  | إرسال newPassword و confirmPassword قيمتهما مختلفتان | 400 (كلمتا المرور غير متطابقتين)    | عالي     |
| MAUTH-CHG-004 | كلمة مرور جديدة أقصر من 8 أحرف | إرسال newPassword أو confirmPassword بأقل من 8 أحرف  | 400 (minLength)                     | عالي     |
| MAUTH-CHG-005 | عدم إرسال توكن                 | طلب بدون Authorization: Bearer                       | 401                                 | حرج      |
| MAUTH-CHG-006 | توكن منتهي                     | استخدام accessToken منتهي الصلاحية                   | 401                                 | عالي     |

---

### العملية 11: تحديث التوكن (Refresh)

**الـ API:** `POST /auth/refresh`  
**Body (اختياري):** `{ "refreshToken" }` — إن لم يُرسل يُؤخذ من cookie إن وُجد.  
**الحدّ:** افتراضي 10 طلبات في 60 ثانية. قد يتطلب CSRF (header x-csrf-token و cookie csrf-token).

#### السيناريو السعيد (Happy Path)

| المعرّف              | MAUTH-REF-001                                                                                                         |
| -------------------- | --------------------------------------------------------------------------------------------------------------------- |
| **العنوان**          | استصدار accessToken جديد باستخدام refreshToken صالح                                                                   |
| **المتطلبات**        | refreshToken صادر من login ولم يُبطَل ولم ينتهِ                                                                       |
| **الخطوات**          | POST /auth/refresh مع refreshToken في body أو في cookie. إن كان CSRF مفعّلاً: إرسال x-csrf-token و cookie csrf-token. |
| **النتيجة المتوقعة** | 200، accessToken، refreshToken (قد يتجدد)، user. وتحديث cookies إن وُجدت.                                             |
| **الأولوية**         | حرج                                                                                                                   |

#### سيناريوهات فشل وحالات حدية (Negative / Edge)

| المعرّف       | العنوان                          | الخطوات                                       | النتيجة المتوقعة                 | الأولوية |
| ------------- | -------------------------------- | --------------------------------------------- | -------------------------------- | -------- |
| MAUTH-REF-002 | عدم توفير refreshToken           | لا body ولا cookie                            | 401 (refresh token not provided) | حرج      |
| MAUTH-REF-003 | refreshToken منتهي أو معدّل      | 401 (invalid/expired)                         | حرج                              |
| MAUTH-REF-004 | refreshToken مُبطَل (بعد logout) | استخدام توكن تم إبطاله                        | 401                              | عالي     |
| MAUTH-REF-005 | CSRF غير صحيح (إن كان مطلوباً)   | عدم إرسال أو إرسال قيمة خاطئة لـ x-csrf-token | 401 (csrf token invalid)         | عالي     |
| MAUTH-REF-006 | تجاوز حد الطلبات                 | أكثر من 10 refresh في الدقيقة                 | 429                              | متوسط    |

---

### العملية 12: تسجيل الخروج (Logout)

**الـ API:** `POST /auth/logout`  
**التوثيق:** `Authorization: Bearer <accessToken>`.  
**Body (اختياري):** `{ "refreshToken" }` — إن لم يُرسل يُؤخذ من cookie.

#### السيناريو السعيد (Happy Path)

| المعرّف              | MAUTH-OUT-001                                                                                                                      |
| -------------------- | ---------------------------------------------------------------------------------------------------------------------------------- |
| **العنوان**          | تسجيل الخروج مع إبطال الـ refreshToken ومسح cookies                                                                                |
| **المتطلبات**        | مستخدم مسجّل الدخول (accessToken صالح)                                                                                             |
| **الخطوات**          | POST /auth/logout مع Bearer accessToken و (إن وُجد) refreshToken في body أو cookie.                                                |
| **النتيجة المتوقعة** | 200، message. إبطال الـ refreshToken؛ مسح cookies المصادقة. الطلبات اللاحقة بنفس accessToken تفشل بعد انتهاء صلاحيته أو blacklist. |
| **الأولوية**         | حرج                                                                                                                                |

#### سيناريوهات فشل وحالات حدية (Negative / Edge)

| المعرّف       | العنوان                                                | الخطوات                                          | النتيجة المتوقعة | الأولوية |
| ------------- | ------------------------------------------------------ | ------------------------------------------------ | ---------------- | -------- |
| MAUTH-OUT-002 | طلب بدون accessToken                                   | 401                                              | عالي             |
| MAUTH-OUT-003 | إرسال refreshToken لشخص آخر (لا يطابق المستخدم الحالي) | إن كان التحقق مفعّلاً: 401 (invalid token owner) | متوسط            |

---

### العملية 13: تسجيل الخروج من كل الأجهزة (Logout all)

**الـ API:** `POST /auth/logout-all`  
**التوثيق:** `Authorization: Bearer <accessToken>`.

#### السيناريو السعيد (Happy Path)

| المعرّف              | MAUTH-OUTALL-001                                                                                                    |
| -------------------- | ------------------------------------------------------------------------------------------------------------------- |
| **العنوان**          | إبطال كل جلسات المستخدم ومسح cookies                                                                                |
| **المتطلبات**        | مستخدم مسجّل الدخول                                                                                                 |
| **الخطوات**          | POST /auth/logout-all مع Bearer token.                                                                              |
| **النتيجة المتوقعة** | 200، message. إبطال كل الـ refresh tokens للمستخدم؛ مسح cookies. لا إمكانية استخدام أي جلسة سابقة حتى إعادة الدخول. |
| **الأولوية**         | عالي                                                                                                                |

#### سيناريوهات فشل وحالات حدية (Negative / Edge)

| المعرّف          | العنوان        | الخطوات | النتيجة المتوقعة | الأولوية |
| ---------------- | -------------- | ------- | ---------------- | -------- |
| MAUTH-OUTALL-002 | عدم إرسال توكن | 401     | عالي             |

---

## 5) ملخص الحالات وترتيب التنفيذ

| الأولوية  | الحالات (أمثلة)                                                                                                                                                                                                                                                                                                                                          |
| --------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **حرج**   | MAUTH-REG-001, MAUTH-REG-003؛ MAUTH-LOGIN-001, MAUTH-LOGIN-003, MAUTH-LOGIN-004؛ MAUTH-VERIFY-001, MAUTH-VERIFY-002؛ MAUTH-FORGOT-001؛ MAUTH-RESET-001, MAUTH-RESET-003؛ MAUTH-ENSURE-001, MAUTH-ENSURE-002, MAUTH-ENSURE-003, MAUTH-ENSURE-004؛ MAUTH-CHG-001, MAUTH-CHG-002, MAUTH-CHG-005؛ MAUTH-REF-001, MAUTH-REF-002, MAUTH-REF-003؛ MAUTH-OUT-001 |
| **عالي**  | باقي سيناريوهات التسجيل والدخول والتحقق والكلمة والـ ensure والـ refresh والـ logout مع التركيز على التحقق من البيانات والصلاحيات والحدود                                                                                                                                                                                                                |
| **متوسط** | التباينات، حدود الطلبات (Throttle)، وحالات حدية نادرة                                                                                                                                                                                                                                                                                                    |

**ترتيب مقترح للتنفيذ:**

1. التسجيل (سعيد + بريد مكرر + تحقق).
2. تسجيل الدخول (سعيد + بيانات خاطئة + بريد غير مُتحقق + حساب/تاجر معطّل).
3. إعادة إرسال التحقق + التحقق من البريد.
4. نسق استعادة كلمة المرور: forgot → validate → reset.
5. Ensure merchant (مع/بدون تاجر، ومعطّل، وتوكن).
6. Onboarding complete.
7. تغيير كلمة المرور.
8. Refresh و Logout و Logout all.

---

## 6) قائمة التحقق السريعة (Checklist)

| المعرّف                | الوصف                        | النتيجة | ملاحظات |
| ---------------------- | ---------------------------- | ------- | ------- |
| MAUTH-REG-001 – 010    | التسجيل                      |         |         |
| MAUTH-LOGIN-001 – 008  | تسجيل الدخول                 |         |         |
| MAUTH-RESEND-001 – 005 | إعادة إرسال التحقق           |         |         |
| MAUTH-VERIFY-001 – 006 | التحقق من البريد             |         |         |
| MAUTH-FORGOT-001 – 004 | طلب إعادة التعيين            |         |         |
| MAUTH-VALID-001 – 004  | التحقق من رابط إعادة التعيين |         |         |
| MAUTH-RESET-001 – 005  | إعادة تعيين كلمة المرور      |         |         |
| MAUTH-ENSURE-001 – 007 | التأكد من التاجر             |         |         |
| MAUTH-ONB-001 – 003    | إكمال الـ onboarding         |         |         |
| MAUTH-CHG-001 – 006    | تغيير كلمة المرور            |         |         |
| MAUTH-REF-001 – 006    | تحديث التوكن                 |         |         |
| MAUTH-OUT-001 – 003    | تسجيل الخروج                 |         |         |
| MAUTH-OUTALL-001 – 002 | تسجيل الخروج من كل الأجهزة   |         |         |

---

## 7) مراجع تقنية سريعة

- **التسجيل:** `POST /api/auth/register` — حد 5/60 ثانية (قابل للتعديل).
- **الدخول:** `POST /api/auth/login` — حد 5/60 ثانية؛ يُرجع access + refresh وقد يضبط cookies.
- **التحقق من البريد:** `POST /api/auth/verify-email` — الرمز 6 أحرف.
- **استعادة كلمة المرور:** `POST /api/auth/forgot-password`، `GET /api/auth/reset-password/validate?email=&token=`، `POST /api/auth/reset-password`.
- **بعد الدخول:** `POST /api/auth/ensure-merchant`، `POST /api/auth/onboarding-complete`، `POST /api/auth/change-password` — تتطلب Bearer token.
- **الجلسة:** `POST /api/auth/refresh` (قد يتطلب CSRF)، `POST /api/auth/logout`، `POST /api/auth/logout-all`.
- **كلمة المرور:** الحد الأدنى 8 أحرف؛ تأكيد كلمة المرور يجب أن يطابق الحقل الأصلي في register/change-password/reset-password.

---

_آخر تحديث: فبراير 2025 — إصدار 1.0_
