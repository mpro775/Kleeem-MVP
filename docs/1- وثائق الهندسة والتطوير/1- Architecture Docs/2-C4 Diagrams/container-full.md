# C4 المستوى 2 — الحاويات (المجموعة الكاملة)
*آخر تحديث: 2025-09-27 18:50*

> **مخطط حاويات C4** — يعرض مجموعة Docker Compose الكاملة مع جميع الأدوات التشغيلية المساعدة. هذا هو المستوى المتوسط من نموذج C4 الذي يركز على بنية التطبيق وتدفق البيانات.

---

## 🎯 الغرض والنطاق

**الغرض الرئيسي:** عكس مجموعة `docker-compose` الفعلية مع جميع الأدوات التشغيلية المساعدة.

**النطاق:** يركز هذا المخطط على **الحاويات التشغيلية** وعلى علاقاتها مع بعضها البعض. يجيب على:
- ما هي المكونات الرئيسية في البنية التحتية؟
- كيف تتفاعل مع بعضها البعض؟
- ما هي الأدوات المساعدة المتاحة؟

**الجمهور المستهدف:**
- 🛠️ **مهندسو العمليات/SRE** — للنشر والمراقبة والتوسع
- 👨‍💻 **مهندسو الخلفية** — لفهم التكاملات والتبعيات
- 🔧 **مهندسو DevOps** — للتخطيط والصيانة والاستكشاف

---

## 🏗️ بنية المخطط

### ملف المصدر
- **الموقع:** [`kaleem-container-full.mmd`](./kaleem-container-full.mmd)
- **التنسيق:** مخطط Mermaid (TD - من أعلى لأسفل)
- **التوليد:** يتم تصييره تلقائياً عبر CI/CD

### التنظيم البصري

يتم تنظيم المخطط في طبقات منطقية:

1. **System Actors** — المستخدمون والعملاء الخارجيون
2. **Edge/DMZ Layer** — محيط الشبكة والمدخل
3. **Core Application** — منطق العمل الرئيسي
4. **External Systems** — الأنظمة الخارجية
5. **Data & Storage** — الثبات والتخزين المؤقت
6. **Observability** — المراقبة والسجلات
7. **Security & Configuration** — الأمان والإعدادات

---

## 🏢 بنية الحاويات

### طبقة Edge / DMZ
**محيط الشبكة للتعامل مع حركة المرور الواردة وبوابات API الخارجية:**

- **Nginx LB** — موازن الحمل لـ Nginx مع TLS
- **Nginx Reverse Proxy** — خادم عكسي مع إنهاء TLS
- **WhatsApp Evolution API** — بوابة WhatsApp Business API المستضافة ذاتياً

### طبقة التطبيق الأساسي

#### تطبيقات الواجهة الأمامية
**واجهات المستخدم لأنواع مختلفة من المستخدمين:**

- **Merchant Dashboard** — لوحة تحكم التاجر (React/Vite SPA)
- **Webchat Widget** — واجهة الدردشة المدمجة للعملاء

#### خدمات الخلفية
**منطق العمل الأساسي ومحركات المعالجة:**

- **API Server** — خادم API (NestJS / REST & GraphQL)
- **Background Workers** — العاملين في الخلفية (Node.js / المهام غير المتزامنة)
- **n8n Workflow Engine** — محرك سير العمل للأتمتة (الإنتاج والتجربة)
- **Embedding Service** — خدمة التضمين (FastAPI)
- **Extractor Service** — خدمة الاستخراج
- **AI Reply Worker** — عامل الردود الذكية
- **Webhook Dispatcher** — موزع الـ Webhooks
- **Indexing Worker** — عامل الفهرسة

#### طبقة الثبات البياني
**أنظمة التخزين والتخزين المؤقت الأساسية:**

- **MongoDB** — قاعدة البيانات الرئيسية (+ mongo-express للإدارة)
- **Redis Cluster** — التخزين المؤقت، الجلسات، تحديد المعدل، قوائم الانتظار
- **Qdrant** — قاعدة بيانات المتجهات للبحث الدلالي
- **MinIO** — التخزين الموضعي للوسائط والملفات
- **RabbitMQ** — وسيط الرسائل للعاملين

---

## 🔗 الأنظمة الخارجية والتكاملات

### القنوات الخارجية
**منصات التواصل للتفاعل مع العملاء:**

- **Telegram Bot API** — منصة المراسلة للتجارة التفاعلية
- **WhatsApp Cloud API** — رسائل الأعمال الرسمية
- **Instagram Basic Display API** — التكامل مع التجارة الاجتماعية
- **Facebook Messenger Platform** — منصة الرسائل المباشرة

### منصات التجارة الإلكترونية
**أنظمة إدارة المتاجر ومعالجة الطلبات:**

- **Salla API** — منصة التجارة السعودية
- **Zid API** — منصة التجارة في منطقة الشرق الأوسط وشمال أفريقيا
- **Shopify API** — منصة التجارة العالمية
- **WooCommerce API** — متاجر ووردبريس

### خدمات الذكاء الاصطناعي
**معالجات الذكاء الاصطناعي الخارجية:**

- **Google Gemini API** — نموذج اللغة الأساسي للمحادثة والتضمين
- **OpenAI API** — نماذج GPT البديلة للميزات المتقدمة

### المراقبة والتتبع
**البنية التحتية للمراقبة وتتبع الأخطاء:**

- **Prometheus** — جمع المقاييس والتنبيه
- **Grafana** — لوحات المراقبة والتنبيه
- **Loki** — تجميع السجلات المركزي
- **Tempo** — التتبع الموزع لتدفق الطلبات
- **OTel Collector** — جامع OpenTelemetry
- **cAdvisor** — مراقبة الحاويات
- **Glitchtip** — إدارة الأخطاء (+ Postgres)

### الأمان والإعدادات
**إدارة الأسرار والوصول:**

- **Secrets Manager** — متغيرات البيئة ومفاتيح API
- **HashiCorp Vault** — إدارة الأسرار على مستوى المؤسسة

---

## 🔄 تفاعلات النظام وتدفق البيانات

### التفاعلات المتزامنة (الوقت الفعلي)
**أنماط الطلب والاستجابة الفورية:**

```
العميل/التاجر → HTTPS → Nginx → موازن الحمل → خادم API
خادم API → HTTP → MongoDB (عمليات CRUD)
خادم API → عمليات التخزين المؤقت → Redis
خادم API → استعلامات البحث المتجهي → Qdrant
خادم API → عمليات الملفات → MinIO
خادم API → استعادة الأسرار → مدير الأسرار
```

### التفاعلات غير المتزامنة (المعالجة في الخلفية)
**المعالجة المؤجلة وأنماط الأحداث:**

```
خادم API → قائمة الانتظار → RabbitMQ → العاملين في الخلفية
العاملين → عمليات البيانات → MongoDB
العاملين → عمليات المتجهات → Qdrant
العاملين → عمليات الملفات → MinIO
العاملين → نشر الرسائل → القنوات الخارجية
العاملين → مكالمات API للذكاء الاصطناعي → Gemini/OpenAI
```

### بوابة WhatsApp Evolution
**معالجة WhatsApp Business API المستضافة ذاتياً:**

```
WhatsApp خارجي → Webhook/SendMessage → Evolution API → خادم API
```

---

## 📊 مسؤوليات الحاويات

| الحاوية | المسؤولية الرئيسية | التقنية | قابلية التوسع |
|---------|-------------------|---------|-------------|
| **خادم API** | API، منطق العمل، توجيه الطلبات | NestJS, TypeScript | توسع أفقي |
| **العاملين في الخلفية** | المهام غير المتزامنة، قوائم الانتظار | Node.js, TypeScript | توسع أفقي |
| **n8n** | أتمتة سير العمل، العمليات التجارية | n8n, JavaScript | مثيل واحد |
| **MongoDB** | تخزين المستندات، متعدد المستأجرين | MongoDB | قراءة replicas، sharding |
| **Redis** | التخزين المؤقت، الجلسات، قوائم الانتظار | Redis Cluster | نمط التجميع |
| **Qdrant** | البحث المتجهي، المطابقة الدلالية | Qdrant | توسع أفقي |
| **MinIO** | التخزين الموضعي، إدارة الوسائط | MinIO | النشر الموزع |

---

## 🎨 مبادئ التصميم البصري

### ترميز الألوان
- **أزرق (الممثلون)** — مستخدمو النظام والعملاء الخارجيون
- **برتقالي (الحافة)** — محيط الشبكة ومكونات الدخول
- **أزرق فاتح (الواجهة الأمامية)** — تطبيقات جانب العميل
- **أخضر (الخلفية)** — منطق العمل من جانب الخادم
- **أحمر (قاعدة البيانات)** — الثبات والتخزين
- **رمادي (الخارجي)** — الأنظمة والـ APIs الخارجية
- **أردوازي (المراقبة)** — المراقبة والسجلات
- **برتقالي (الأمان)** — الأمان والإعدادات

### استراتيجية التخطيط
- **القسم العلوي:** ممثلو النظام ونقاط الدخول
- **محيط الشبكة:** مكونات Edge/DMZ
- **النواة التطبيقية:** الواجهة الأمامية والخلفية
- **التبعيات الخارجية:** التكاملات مع الأطراف الثالثة
- **البيانات والمراقبة:** التخزين وأدوات المراقبة
- **الأمان:** الأمان والإعدادات

---

## 🔍 قراءة المخطط

### ما يظهره هذا المخطط

1. **بنية التطبيق** — الحاويات التشغيلية الرئيسية وأغراضها
2. **أنماط تدفق البيانات** — التزامن مقابل المعالجة غير المتزامنة
3. **التبعيات الخارجية** — نقاط التكامل مع الخدمات الخارجية
4. **اختيارات التقنية** — إطارات العمل وقواعد البيانات المختارة
5. **حدود قابلية التوسع** — أي المكونات يمكن توسيعها أفقياً

### ما لا يظهره هذا المخطط

- **التفاصيل الداخلية للمكونات** — راجع مخطط مكونات API
- **طبولوجيا البنية التحتية** — راجع مخطط النشر
- **أمان الشبكة** — مجرد للتركيز على مخاوف التطبيق
- **تفاصيل مخطط البيانات** — راجع وثائق ERD

---

## 📈 مصفوفة تعقيد التكامل

| نوع التكامل | البروتوكول | التكرار | التعقيد | الحرجة |
|-------------|---------|--------|---------|-------|
| **واجهات برمجة التطبيقات للرسائل** | Webhook/HTTP | عالي | متوسط | عالي |
| **مزامنة التجارة الإلكترونية** | Webhook/REST | متوسط | عالي | عالي |
| **معالجة الذكاء الاصطناعي** | REST API | منخفض | منخفض | متوسط |
| **تخزين البيانات** | برنامج تشغيل أصلي | عالي | منخفض | حرج |
| **المراقبة** | دفع/سحب | مستمر | منخفض | عالي |
| **الأمان** | متنوع | منخفض | متوسط | حرج |

---

## 🚀 الاعتبارات التشغيلية

### استراتيجية النشر
- **تنسيق الحاويات:** Docker Compose (التطوير)، Kubernetes (الإنتاج)
- **اكتشاف الخدمة:** DNS داخلي وموازنة الحمل
- **إدارة الإعدادات:** إعدادات تعتمد على البيئة مع الأسرار

### أنماط قابلية التوسع
- **خادم API:** توسع أفقي مع موازن الحمل
- **العاملين في الخلفية:** توسع بناءً على عمق قائمة الانتظار
- **قواعد البيانات:** قراءة replicas واستراتيجيات sharding
- **التخزين المؤقت:** تجمع Redis للتوافر العالي

### المراقبة والتنبيه
- **مقاييس التطبيق:** زمن استجابة الطلب، معدلات الخطأ، الإنتاجية
- **مقاييس البنية التحتية:** CPU، الذاكرة، استخدام القرص
- **مقاييس الأعمال:** معدلات التحويل، تفاعل المستخدمين
- **توجيه التنبيهات:** بناءً على الخطورة والمكون

---

## 🔧 التطوير والاختبار

### التطوير المحلي
- **Docker Compose:** المجموعة الكاملة للتطوير المحلي
- **إعادة التحميل الساخن:** تطوير API والواجهة الأمامية
- **إعدادات التصحيح:** إعدادات محسنة للتطوير

### استراتيجية الاختبار
- **اختبارات الوحدة:** منطق الحاوية الفردية
- **اختبارات التكامل:** التواصل بين الحاويات
- **اختبارات E2E:** رحلة المستخدم الكاملة
- **اختبارات الأداء:** اختبار الحمل والضغط

---

## 🔗 الوثائق ذات الصلة

### السابقة
- **[مخطط الحاويات](./container.md)** — المكونات الرئيسية وعلى علاقاتها
- **[مخطط السياق](./context.md)** — سياق النظام والتبعيات الخارجية
- **[نظرة عامة على النظام](../../../1-%D9%88%D8%AB%D8%A7%D8%A6%D9%82%20%D8%A7%D9%84%D9%87%D9%86%D8%AF%D8%B3%D8%A9%20%D9%88%D8%A7%D9%84%D8%AA%D8%B7%D9%88%D9%8A%D8%B1/1-%20Architecture%20Docs/1-System%20Overview/Kaleem-System-Overview-AR.md)** — الملخص التنفيذي

### اللاحقة
- **[مكونات API](./api-components.md)** — البنية الداخلية للوحدات
- **[مخطط النشر](./deployment.md)** — طبولوجيا البنية التحتية

### المراجع الخارجية
- **[توثيق NestJS](https://docs.nestjs.com/)** — مرجع إطار عمل الخلفية
- **[توثيق Mermaid](https://mermaid.js.org/)** — مرجع صيغة المخطط
- **[توثيق Docker](https://docs.docker.com/)** — تنسيق الحاويات

---

## 📝 الصيانة والتحديثات

### محفزات التحديث
- إدخال خدمة أو حاوية جديدة
- تغييرات في مجموعة التقنيات
- تعديلات في أنماط التكامل
- متطلبات الأداء أو قابلية التوسع

### دورة المراجعة
- **شهرياً:** فحص الدقة الفنية واكتمال المعلومات
- **ربع سنوي:** تقييم الجاهزية التشغيلية
- **سنوياً:** مراجعة العمارة الكاملة والتحديث

### تاريخ الإصدارات
- **الإصدار 1.0 (2025-09-27):** مخطط حاويات C4 محترف مع تفاعلات مفصلة
- **الإصدار 0.1 (2025-09-27):** تخطيط أساسي للحاويات مع الخدمات الأساسية

---

> **الخطوات التالية:** بعد فهم علاقات الحاويات، انتقل إلى **[مكونات API](./api-components.md)** لبنية الوحدات الداخلية، أو **[مخطط النشر](./deployment.md)** لتخطيط البنية التحتية.
