# ูุฑู ููู ุชูููู ุงูุฑุณุงุฆู ูุงูุงูุชูุงู ุฅูู ุงููุชุฌูุงุช - ูุธุงู ูููู ุงูุดุงูู

## ูุธุฑุฉ ุนุงูุฉ ุนูู ุงููุธุงู

ูุธุงู ูููู ูุฏุนู ุชููููุงู ุดุงููุงู ูุฑุณุงุฆู ุงูุจูุช ูุน ุงูุชูุงู ุฐูู ูููุชุฌูุงุช ูุชุญุณูู ุงูุงุณุชุฌุงุจุงุช:

- **ุชูููู ุงูุฑุณุงุฆู**: ูุธุงู ุชุตููู ุงูุฑุฏูุฏ (ุฌูุฏ/ุณูุก) ูุน ุชุนูููุงุช
- **ุชุญุณูู ุงูุฐูุงุก ุงูุงุตุทูุงุนู**: ุฅูุดุงุก ุชุนูููุงุช ูู ุงูุฑุฏูุฏ ุงูุณูุฆุฉ
- **ุงูุงูุชูุงู ูููุชุฌูุงุช**: ููุฑุณุฉ ุงูุฑุฏูุฏ ุงูุฌูุฏุฉ ูู Qdrant
- **ุงูุชุนูู ุงููุณุชูุฑ**: ุชุญุณูู ุงูุจูุช ุจูุงุกู ุนูู ุงูุชุบุฐูุฉ ุงูุฑุงุฌุนุฉ
- **ุงูุจุญุซ ุงููุชุฌูู**: ุงุณุชุฑุฌุงุน ุงูุฑุฏูุฏ ุงููุดุงุจูุฉ ูู ุงููุนุฑูุฉ

## 1. ูุฎุทุท ุงูุชุฏูู ุงูุนุงู (Flowchart)

```mermaid
graph TD
    A[ุชููู ุฑุฏ ุงูุจูุช] --> B[ุนุฑุถ ุงูุฑุฏ ูููุณุชุฎุฏู<br/>ูุน ุฎูุงุฑุงุช ุงูุชูููู]
    B --> C[ุงูุชุธุงุฑ ุชูููู ุงููุณุชุฎุฏู<br/>thumbs up/down + ุชุนููู]

    C --> D{ููุน ุงูุชูููู}
    D -->|ุฅูุฌุงุจู ๐| E[ุญูุธ ุงูุชูููู ุงูุฅูุฌุงุจู<br/>ุฒูุงุฏุฉ ุฏุฑุฌุฉ ุงูุซูุฉ]
    D -->|ุณูุจู ๐| F[ุญูุธ ุงูุชูููู ุงูุณูุจู<br/>ุทูุจ ุชุนููู ุฅุถุงูู]

    F --> G[ุชุญููู ุงูุฑุฏ ุงูุณูุจู<br/>ุงุณุชุฎุฑุงุฌ ุงููุดููุฉ]
    G --> H[ุฅูุดุงุก ุชุนูููุงุช ุฌุฏูุฏุฉ<br/>ุจุงุณุชุฎุฏุงู Gemini AI]

    H --> I[ุญูุธ ุงูุชุนูููุงุช<br/>ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช]
    I --> J[ุชุญุฏูุซ prompt ุงูุจูุช<br/>ุฅุถุงูุฉ ุงูุชุนูููุงุช ุงูุฌุฏูุฏุฉ]

    E --> K[ูุญุต ุงูุฌูุฏุฉ ุงูุนุงููุฉ<br/>score > threshold]
    K --> L{ุฌูุฏุฉ ุนุงููุฉุ}
    L -->|ูุนู| M[ุฅุถุงูุฉ ูููุนุฑูุฉ ุงููุชุฌููุฉ<br/>ููุฑุณุฉ ูู Qdrant]
    L -->|ูุง| N[ุชุฌุงูู ุงูุฑุฏ<br/>ูุง ูุถุงู ูููุนุฑูุฉ]

    M --> O[ุชุญุฏูุซ ูุงุนุฏุฉ ุงููุนุฑูุฉ<br/>ูุชุงุญุฉ ููุจุญุซ ุงููุณุชูุจูู]

    P[ุงูุจุญุซ ุงูุฌุฏูุฏ] --> Q[ุงุณุชูุงู ุงูุงุณุชุนูุงู<br/>ูู ุงููุณุชุฎุฏู]
    Q --> R[ุชุญููู ููุชุฌู<br/>ุชุถููู ุงูุงุณุชุนูุงู]
    R --> S[ุงูุจุญุซ ูู Qdrant<br/>ููุงุฑูุฉ ุงููุชุฌูุงุช]

    S --> T[ุชุตููุฉ ุงููุชุงุฆุฌ<br/>ุญุณุจ ุฏุฑุฌุฉ ุงูุชุดุงุจู]
    T --> U[ุชุฑุชูุจ ุงููุชุงุฆุฌ<br/>ุญุณุจ ุงูุตูุฉ ูุงูุชูููู]
    U --> V[ุฅุฑุฌุงุน ุงููุชุงุฆุฌ<br/>ูุน ุงููุตุงุฏุฑ ูุงูุซูุฉ]

    W[ุงูุชุนูู ุงููุณุชูุฑ] --> X[ูุฑุงูุจุฉ ุงูุฃุฏุงุก<br/>ูุนุฏู ุงูุชููููุงุช ุงูุฅูุฌุงุจูุฉ]
    X --> Y[ุชุญุณูู ุงูุฎูุงุฑุฒููุฉ<br/>ุถุจุท ุงููุนููุงุช]
    Y --> Z[ุชุญุฏูุซ ุงููููุฐุฌ<br/>ุชุญุณูู ุงูุงุณุชุฌุงุจุงุช]
```

## 2. ูุฎุทุท ุงูุชุณูุณู (Sequence Diagram)

```mermaid
sequenceDiagram
    participant C as Customer
    participant W as Website/Widget
    participant B as Bot Service
    participant DB as Database
    participant AI as Gemini AI
    participant VS as Vector Service
    participant AN as Analytics
    participant INS as Instructions Service

    Note over C,W: ุชููู ุฑุฏ ุงูุจูุช
    W->>C: ุนุฑุถ ุฑุฏ ุงูุจูุช
    C->>W: ุชูููู ุงูุฑุฏ (๐/๐ + ุชุนููู)

    Note over W,B: ุญูุธ ุงูุชูููู
    W->>B: POST /rate-message
    B->>DB: ุญูุธ ุงูุชูููู ูู ุงูุฑุณุงูุฉ

    alt ุชูููู ุณูุจู
        Note over B,AI: ุฅูุดุงุก ุชุนูููุงุช ูู ุงูุฑุฏ ุงูุณูุจู
        B->>AI: ุทูุจ ุฅูุดุงุก ุชุนูููุงุช ูู ุงูุฑุฏ ุงูุณูุจู
        AI-->>B: ุชุนูููุงุช ุฌุฏูุฏุฉ

        Note over B,INS: ุญูุธ ุงูุชุนูููุงุช
        B->>INS: ุญูุธ ุงูุชุนูููุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
        INS->>DB: ุฅุฏุฑุงุฌ ุงูุชุนูููุงุช ุงูุฌุฏูุฏุฉ

        Note over B: ุชุญุฏูุซ prompt ุงูุจูุช
        B->>B: ุฅุถุงูุฉ ุงูุชุนูููุงุช ููู system prompt
    else ุชูููู ุฅูุฌุงุจู ุนุงูู ุงูุฌูุฏุฉ
        Note over B,VS: ุฅุถุงูุฉ ูููุนุฑูุฉ ุงููุชุฌููุฉ
        B->>VS: ููุฑุณุฉ ุงูุฑุฏ ูู Qdrant
        VS-->>B: ุชุฃููุฏ ุงูููุฑุณุฉ
        DB-->>B: ุชุญุฏูุซ ุญุงูุฉ ุงูุฑุณุงูุฉ
    end

    Note over AN: ุชุณุฌูู ุงูููุงููุณ
    B->>AN: ุชุณุฌูู ุงูุชูููู ูุงูุชุญุณูู
    AN-->>B: ุชุฃููุฏ ุงูุชุณุฌูู

    Note over C,W: ุจุญุซ ุฌุฏูุฏ
    C->>W: ุฅุฑุณุงู ุงุณุชุนูุงู ุฌุฏูุฏ
    W->>B: ุทูุจ ุงูุจุญุซ
    B->>VS: ุจุญุซ ูุชุฌูู ูู Qdrant
    VS-->>B: ูุชุงุฆุฌ ุงูุจุญุซ ุงููุฑุชุจุฉ

    Note over B: ูุนุงูุฌุฉ ุงููุชุงุฆุฌ
    B->>B: ุฏูุฌ ูุน ุงูุฑุฏูุฏ ุงูุฌุฏูุฏุฉ
    B->>W: ุฅุฑุฌุงุน ุงููุชุงุฆุฌ ุงููุญุณูุฉ
    W-->>C: ุนุฑุถ ุงููุชุงุฆุฌ ูููุณุชุฎุฏู
```

## 3. ุขูุฉ ุงูุญุงูุงุช (State Machine)

```mermaid
stateDiagram-v2
    [*] --> ุนุฑุถ_ุงูุฑุฏ: ุงูุจูุช ูุฑุฏ ุนูู ุงููุณุชุฎุฏู

    ุนุฑุถ_ุงูุฑุฏ --> ุงูุชุธุงุฑ_ุงูุชูููู: ุนุฑุถ ุฎูุงุฑุงุช ุงูุชูููู
    ุงูุชุธุงุฑ_ุงูุชูููู --> ุชูููู_ุงููุณุชุฎุฏู: ุงููุณุชุฎุฏู ูููู

    ุชูููู_ุงููุณุชุฎุฏู --> ุญูุธ_ุงูุชูููู: ุญูุธ ุงูุชูููู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
    ุญูุธ_ุงูุชูููู --> ูุญุต_ููุน_ุงูุชูููู: ุฅูุฌุงุจู ุฃู ุณูุจู

    ูุญุต_ููุน_ุงูุชูููู --> ุชูููู_ุฅูุฌุงุจู: ๐
    ูุญุต_ููุน_ุงูุชูููู --> ุชูููู_ุณูุจู: ๐

    ุชูููู_ุฅูุฌุงุจู --> ูุญุต_ุงูุฌูุฏุฉ: ุฏุฑุฌุฉ ุนุงููุฉุ
    ูุญุต_ุงูุฌูุฏุฉ --> ุฌูุฏุฉ_ุนุงููุฉ: score > threshold
    ูุญุต_ุงูุฌูุฏุฉ --> ุฌูุฏุฉ_ุนุงุฏูุฉ: score ุนุงุฏู

    ุฌูุฏุฉ_ุนุงููุฉ --> ุฅุถุงูุฉ_ูููุนุฑูุฉ: ููุฑุณุฉ ูู Qdrant
    ุฅุถุงูุฉ_ูููุนุฑูุฉ --> ูุนุฑูุฉ_ูููุฑุณุฉ: ุฌุงูุฒ ููุจุญุซ

    ุฌูุฏุฉ_ุนุงุฏูุฉ --> ุชุฌุงูู_ุงูุฑุฏ: ูุง ูุถุงู ูููุนุฑูุฉ

    ุชูููู_ุณูุจู --> ุชุญููู_ุงููุดููุฉ: ุงุณุชุฎุฑุงุฌ ุณุจุจ ุงูุณูุจูุฉ
    ุชุญููู_ุงููุดููุฉ --> ุฅูุดุงุก_ุชุนูููุงุช: ุจุงุณุชุฎุฏุงู Gemini AI
    ุฅูุดุงุก_ุชุนูููุงุช --> ุญูุธ_ุงูุชุนูููุงุช: ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
    ุญูุธ_ุงูุชุนูููุงุช --> ุชุญุฏูุซ_ุงูุจุฑููุจุช: ุฅุถุงูุฉ ุงูุชุนูููุงุช

    ุชุญุฏูุซ_ุงูุจุฑููุจุช --> ุชุญุณูู_ุงูุจูุช: ุงูุจูุช ูุญุฏุซ

    ูุนุฑูุฉ_ูููุฑุณุฉ --> ุงูุจุญุซ_ุงูุฌุฏูุฏ: ุทูุจ ุจุญุซ
    ุชุญุณูู_ุงูุจูุช --> ุงูุจุญุซ_ุงูุฌุฏูุฏ
    ุชุฌุงูู_ุงูุฑุฏ --> ุงูุจุญุซ_ุงูุฌุฏูุฏ

    ุงูุจุญุซ_ุงูุฌุฏูุฏ --> ุชุญููู_ููุชุฌู: ุชุถููู ุงูุงุณุชุนูุงู
    ุชุญููู_ููุชุฌู --> ุจุญุซ_ูุชุฌูู: ูู Qdrant
    ุจุญุซ_ูุชุฌูู --> ุชุตููุฉ_ุงููุชุงุฆุฌ: ุญุณุจ ุงูุตูุฉ
    ุชุตููุฉ_ุงููุชุงุฆุฌ --> ุชุฑุชูุจ_ุงููุชุงุฆุฌ: ุญุณุจ ุงูุฏุฑุฌุฉ
    ุชุฑุชูุจ_ุงููุชุงุฆุฌ --> ุฅุฑุฌุงุน_ุงููุชุงุฆุฌ: ูููุณุชุฎุฏู

    ุฅุฑุฌุงุน_ุงููุชุงุฆุฌ --> ุชุณุฌูู_ุงูุชุญูููุงุช: ูุฑุงูุจุฉ ุงูุฃุฏุงุก
    ุชุณุฌูู_ุงูุชุญูููุงุช --> ุงุณุชูุฑุงุฑ_ุงูุนูู: ุงููุธุงู ูุนูู

    ุฎุทุฃ_ุงูุชูููู --> ุฅุนุงุฏุฉ_ุงููุญุงููุฉ: ูุญุงููุฉ ุฃุฎุฑู
    ุฅุนุงุฏุฉ_ุงููุญุงููุฉ --> ุญูุธ_ุงูุชูููู
```

### ุชุนุฑูู ุงูุญุงูุงุช

| ุงูุญุงูุฉ            | ุงููุตู                           | ุงูุฅุฌุฑุงุกุงุช ุงููุณููุญุฉ |
| ----------------- | ------------------------------- | ------------------ |
| `ุนุฑุถ_ุงูุฑุฏ`        | ุนุฑุถ ุฑุฏ ุงูุจูุช ูููุณุชุฎุฏู           | ุนุฑุถ ุฎูุงุฑุงุช ุงูุชูููู |
| `ุงูุชุธุงุฑ_ุงูุชูููู`  | ุงูุชุธุงุฑ ุชูููู ุงููุณุชุฎุฏู           | ุนุฑุถ ุฎูุงุฑุงุช ๐/๐   |
| `ุชูููู_ุงููุณุชุฎุฏู`  | ุงููุณุชุฎุฏู ูููู ุงูุฑุฏ              | ุญูุธ ุงูุชูููู        |
| `ุญูุธ_ุงูุชูููู`     | ุญูุธ ุงูุชูููู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช   | ุชุญุฏูุซ ุณุฌู ุงูุฑุณุงูุฉ  |
| `ูุญุต_ููุน_ุงูุชูููู` | ุชุญุฏูุฏ ููุน ุงูุชูููู               | ุชุตููู ุงูุชูููู      |
| `ุชูููู_ุฅูุฌุงุจู`    | ุชูููู ุฅูุฌุงุจู ูู ุงููุณุชุฎุฏู        | ูุญุต ุงูุฌูุฏุฉ         |
| `ุชูููู_ุณูุจู`      | ุชูููู ุณูุจู ูู ุงููุณุชุฎุฏู          | ุชุญููู ุงููุดููุฉ      |
| `ูุญุต_ุงูุฌูุฏุฉ`      | ูุญุต ุฏุฑุฌุฉ ุฌูุฏุฉ ุงูุฑุฏ              | ุชูููู ุงูุตูุฉ        |
| `ุฌูุฏุฉ_ุนุงููุฉ`      | ุงูุฑุฏ ุนุงูู ุงูุฌูุฏุฉ                | ุฅุถุงูุฉ ูููุนุฑูุฉ      |
| `ุฌูุฏุฉ_ุนุงุฏูุฉ`      | ุงูุฑุฏ ุนุงุฏู ุงูุฌูุฏุฉ                | ุชุฌุงูู ุงูุฑุฏ         |
| `ุชุญููู_ุงููุดููุฉ`   | ุชุญููู ุณุจุจ ุงูุชูููู ุงูุณูุจู        | ุงุณุชุฎุฑุงุฌ ุงููุดููุฉ    |
| `ุฅูุดุงุก_ุชุนูููุงุช`   | ุฅูุดุงุก ุชุนูููุงุช ุฌุฏูุฏุฉ             | ุงุณุชุฏุนุงุก Gemini AI  |
| `ุญูุธ_ุงูุชุนูููุงุช`   | ุญูุธ ุงูุชุนูููุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช | ุฅุฏุฑุงุฌ ุงูุชุนูููุงุช    |
| `ุชุญุฏูุซ_ุงูุจุฑููุจุช`  | ุชุญุฏูุซ prompt ุงูุจูุช              | ุฅุถุงูุฉ ุงูุชุนูููุงุช    |
| `ุฅุถุงูุฉ_ูููุนุฑูุฉ`   | ุฅุถุงูุฉ ุงูุฑุฏ ูููุนุฑูุฉ ุงููุชุฌููุฉ     | ููุฑุณุฉ ูู Qdrant    |
| `ูุนุฑูุฉ_ูููุฑุณุฉ`    | ุงููุนุฑูุฉ ุฌุงูุฒุฉ ููุจุญุซ             | ุฌููุน ุนูููุงุช ุงูุจุญุซ  |
| `ุชุญุณูู_ุงูุจูุช`     | ุงูุจูุช ูุญุฏุซ ุจุงูุชุนูููุงุช ุงูุฌุฏูุฏุฉ   | ุชุญุณูู ุงูุงุณุชุฌุงุจุงุช   |
| `ุงูุจุญุซ_ุงูุฌุฏูุฏ`    | ุทูุจ ุจุญุซ ุฌุฏูุฏ                    | ุชูููุฐ ุงูุงุณุชุนูุงู    |
| `ุชุญููู_ููุชุฌู`     | ุชุญููู ุงูุงุณุชุนูุงู ููุชุฌู           | ุชุถููู ุงููุต         |
| `ุจุญุซ_ูุชุฌูู`       | ุงูุจุญุซ ูู Qdrant                 | ุงุณุชุฑุฌุงุน ุงููุชุงุฆุฌ    |
| `ุชุตููุฉ_ุงููุชุงุฆุฌ`   | ุชุฑุชูุจ ูุชุตููุฉ ุงููุชุงุฆุฌ            | ุชุญุณูู ุงูุนุฑุถ        |
| `ุชุฑุชูุจ_ุงููุชุงุฆุฌ`   | ุชุฑุชูุจ ุญุณุจ ุงูุตูุฉ ูุงูุชูููู        | ุฅุนุฏุงุฏ ุงููุชุงุฆุฌ      |
| `ุฅุฑุฌุงุน_ุงููุชุงุฆุฌ`   | ุฅุฑุฌุงุน ุงููุชุงุฆุฌ ูููุณุชุฎุฏู          | ุนุฑุถ ุงููุญุชูู        |
| `ุชุณุฌูู_ุงูุชุญูููุงุช` | ุชุณุฌูู ุงูููุงููุณ ูุงูุฅุญุตุงุฆูุงุช      | ูุฑุงูุจุฉ ุงูุฃุฏุงุก      |

## 4. ูุฎุทุท ุณูุฑ ุงูุนูู ุงูุชุฌุงุฑู (BPMN)

```mermaid
graph TB
    Start([ุจุฏุก]) --> BotResponse[ุฑุฏ ุงูุจูุช]
    BotResponse --> UserEvaluation[ุชูููู ุงููุณุชุฎุฏู]

    UserEvaluation --> EvaluationType{ููุน ุงูุชูููู}
    EvaluationType -->|ุฅูุฌุงุจู| QualityCheck[ูุญุต ุงูุฌูุฏุฉ]
    EvaluationType -->|ุณูุจู| ProblemAnalysis[ุชุญููู ุงููุดููุฉ]

    QualityCheck --> HighQuality{ุฌูุฏุฉ ุนุงููุฉุ}
    HighQuality -->|ูุนู| AddToKnowledge[ุฅุถุงูุฉ ูููุนุฑูุฉ]
    HighQuality -->|ูุง| IgnoreResponse[ุชุฌุงูู ุงูุฑุฏ]

    ProblemAnalysis --> GenerateInstructions[ุฅูุดุงุก ุชุนูููุงุช]
    GenerateInstructions --> SaveInstructions[ุญูุธ ุงูุชุนูููุงุช]
    SaveInstructions --> UpdatePrompt[ุชุญุฏูุซ ุงูุจุฑููุจุช]

    AddToKnowledge --> VectorIndexing[ููุฑุณุฉ ุงููุชุฌูุงุช]
    VectorIndexing --> KnowledgeIndexed[ูุนุฑูุฉ ูููุฑุณุฉ]

    IgnoreResponse --> BotImproved[ุงูุจูุช ูุญุฏุซ]
    UpdatePrompt --> BotImproved
    KnowledgeIndexed --> BotImproved

    BotImproved --> NewSearch[ุจุญุซ ุฌุฏูุฏ]
    NewSearch --> QueryEmbedding[ุชุญููู ุงูุงุณุชุนูุงู]
    QueryEmbedding --> VectorSearch[ุงูุจุญุซ ุงููุชุฌูู]
    VectorSearch --> FilterResults[ุชุตููุฉ ุงููุชุงุฆุฌ]
    FilterResults --> SortResults[ุชุฑุชูุจ ุงููุชุงุฆุฌ]
    SortResults --> ReturnResults[ุฅุฑุฌุงุน ุงููุชุงุฆุฌ]

    ReturnResults --> LogAnalytics[ุชุณุฌูู ุงูุชุญูููุงุช]
    LogAnalytics --> ContinueOperation[ุงุณุชูุฑุงุฑ ุงูุนูู]

    subgraph "ุงูุชุนูู ุงููุณุชูุฑ"
        MonitorPerformance[ูุฑุงูุจุฉ ุงูุฃุฏุงุก] --> AnalyzeMetrics[ุชุญููู ุงูููุงููุณ]
        AnalyzeMetrics --> OptimizeAlgorithm[ุชุญุณูู ุงูุฎูุงุฑุฒููุฉ]
        OptimizeAlgorithm --> UpdateModel[ุชุญุฏูุซ ุงููููุฐุฌ]
    end
```

## 5. ุชูุงุตูู ุชูููุฉ ููู ูุฑุญูุฉ

### 5.1 ูุฑุญูุฉ ุชูููู ุงูุฑุณุงุฆู

#### 5.1.1 ูุธุงู ุงูุชูููู

**Endpoint**: `POST /rate-message/{sessionId}/{msgIdx}`

**ุงูุจูุงูุงุช ุงููุทููุจุฉ**:

```typescript
interface RateMessageDto {
  rating: 0 | 1; // 0 = ุณูุจูุ 1 = ุฅูุฌุงุจู
  feedback?: string; // ุชุนููู ุฅุถุงูู (ุงุฎุชูุงุฑู)
}
```

**ุนูููุฉ ุงููุนุงูุฌุฉ**:

```typescript
async function rateMessage(
  sessionId: string,
  msgIdx: number,
  rating: 0 | 1,
  feedback?: string,
) {
  // 1. ุงูุนุซูุฑ ุนูู ุงูุฑุณุงูุฉ
  const message = await messagesRepo.findBySessionAndIndex(sessionId, msgIdx);

  // 2. ุญูุธ ุงูุชูููู
  message.rating = rating;
  message.feedback = feedback;
  await message.save();

  // 3. ุฅุฐุง ูุงู ุงูุชูููู ุณูุจูุงู
  if (rating === 0) {
    // ุฅูุดุงุก ุชุนูููุงุช ูู ุงูุฑุฏ ุงูุณูุจู
    const instruction = await geminiService.generateInstructionFromBadReply(
      message.text,
    );

    // ุญูุธ ุงูุชุนูููุงุช
    await instructionsService.create({
      merchantId: message.merchantId,
      instruction,
      relatedReplies: [message.text],
      type: 'auto',
    });
  }

  // 4. ุฅุฐุง ูุงู ุงูุชูููู ุฅูุฌุงุจูุงู ูุนุงูู ุงูุฌูุฏุฉ
  if (rating === 1 && isHighQuality(message)) {
    // ุฅุถุงูุฉ ูููุนุฑูุฉ ุงููุชุฌููุฉ
    await vectorService.upsertKnowledge([
      {
        id: generateId(),
        vector: await embedText(message.text),
        payload: {
          text: message.text,
          type: 'bot_response',
          rating: 1,
          merchantId: message.merchantId,
        },
      },
    ]);
  }

  return { status: 'ok' };
}
```

#### 5.1.2 ุชุญููู ุฌูุฏุฉ ุงูุฑุฏ

```typescript
function isHighQuality(message: Message): boolean {
  // ูุนุงููุฑ ุงูุฌูุฏุฉ ุงูุนุงููุฉ
  const criteria = [
    message.text.length > 50, // ุทูู ููุงุณุจ
    !message.text.includes('ูุง ุฃููู'), // ุนุฏู ุงูุงูุชุจุงุณ
    !message.text.includes('ุนุฐุฑุงู'), // ุนุฏู ุงูุงุนุชุฐุงุฑ
    message.text.includes('ูููููู') || // ุชูุฏูู ุงููุณุงุนุฏุฉ
      message.text.includes('ุณุฃุณุงุนุฏู') ||
      message.text.includes('ุงูุฅุฌุงุจุฉ'),
  ];

  return criteria.filter(Boolean).length >= 2; // ูุนูุงุฑูู ุนูู ุงูุฃูู
}
```

### 5.2 ูุฑุญูุฉ ุฅูุดุงุก ุงูุชุนูููุงุช

#### 5.2.1 ุฅูุดุงุก ุชุนูููุงุช ูู ุงูุฑุฏูุฏ ุงูุณูุจูุฉ

**ุงุณุชุฏุนุงุก Gemini AI**:

```typescript
async function generateInstructionFromBadReply(
  badReply: string,
): Promise<string> {
  const prompt = `
    ุงูุฑุฏ ุงูุชุงูู ุชู ุชููููู ุณูุจููุง ูู ูุจู ุงูุชุงุฌุฑ: "${badReply}".
    ุตูุบ ุชูุฌูููุง ูุฎุชุตุฑูุง ุฌุฏูุง (ุณุทุฑ ูุงุญุฏ ููุทุ 15 ูููุฉ ุฃู ุฃููุ ูุง ุชุดุฑุญ ุงูุณุจุจ)
    ูููุน ูุณุงุนุฏ ุงูุฐูุงุก ุงูุงุตุทูุงุนู ูู ุชูุฑุงุฑ ูุฐุง ุงูุฎุทุฃ.
  `;

  const result = await model.generateContent(prompt);
  return result.response.text().trim();
}
```

**ุฃูุซูุฉ ููุชุนูููุงุช ุงููููุดุฃุฉ**:

- "ูุง ุชูุฏู ูุนูููุงุช ุฎุงุทุฆุฉ ุนู ุงูุฃุณุนุงุฑ"
- "ุชุฃูุฏ ูู ููู ุงูุณุคุงู ูุจู ุงูุฅุฌุงุจุฉ"
- "ูุง ุชูุชุฑุถ ุงููุนูููุงุชุ ุงุทูุจ ุงูุชูุถูุญ"
- "ุฑูุฒ ุนูู ุญู ูุดููุฉ ุงูุนููู"

#### 5.2.2 ุญูุธ ุงูุชุนูููุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

```typescript
const instruction = await instructionsService.create({
  merchantId,
  instruction: generatedInstruction,
  relatedReplies: [badReply],
  type: 'auto',
  active: true,
});
```

### 5.3 ูุฑุญูุฉ ููุฑุณุฉ ุงููุชุฌูุงุช

#### 5.3.1 ุฅุถุงูุฉ ุงูุฑุฏูุฏ ุงูุฌูุฏุฉ ูููุนุฑูุฉ

```typescript
async function addHighQualityResponseToKnowledge(message: Message) {
  const embedding = await embeddingService.embedText(message.text);

  await vectorService.upsertKnowledge([
    {
      id: generateId(),
      vector: embedding,
      payload: {
        text: message.text,
        type: 'bot_response',
        rating: 1,
        merchantId: message.merchantId,
        sessionId: message.sessionId,
        timestamp: message.timestamp,
      },
    },
  ]);
}
```

#### 5.3.2 ุชุญุฏูุซ prompt ุงูุจูุช

```typescript
async function updateBotPrompt(merchantId: string) {
  const instructions =
    await instructionsService.getActiveInstructions(merchantId);

  const systemPrompt = `
    ุฃูุช ูุณุงุนุฏ ุฐูู ููุชุฌุฑ ุฅููุชุฑููู.
    ${instructions.map((i) => i.instruction).join('\n')}

    ููุงุนุฏ ุนุงูุฉ:
    - ูู ููุฐุจุงู ููุณุงุนุฏุงู
    - ูุฏู ูุนูููุงุช ุฏูููุฉ
    - ูุง ุชูุชุฑุถ ูุนูููุงุช ุบูุฑ ูุคูุฏุฉ
  `;

  // ุชุญุฏูุซ prompt ูู n8n workflow
  await updateN8nPrompt(merchantId, systemPrompt);
}
```

### 5.4 ูุฑุญูุฉ ุงูุจุญุซ ุงููุชุฌูู

#### 5.4.1 ุชุญููู ุงูุงุณุชุนูุงู ููุชุฌู

```typescript
async function searchSimilarResponses(query: string, merchantId: string) {
  // 1. ุชุญููู ุงูุงุณุชุนูุงู ููุชุฌู
  const queryEmbedding = await embeddingService.embedText(query);

  // 2. ุงูุจุญุซ ูู Qdrant
  const results = await vectorService.search({
    collection: 'knowledge',
    vector: queryEmbedding,
    filter: { merchantId },
    limit: 5,
    score_threshold: 0.7,
  });

  // 3. ุชุตููุฉ ูุชุฑุชูุจ ุงููุชุงุฆุฌ
  return results
    .filter((result) => result.score > 0.8)
    .sort((a, b) => b.score - a.score)
    .map((result) => ({
      text: result.payload.text,
      similarity: result.score,
      source: 'vector_knowledge',
    }));
}
```

#### 5.4.2 ุฏูุฌ ูุน ุงูุจุญุซ ุงููุตู

```typescript
async function hybridSearch(query: string, merchantId: string) {
  // 1. ุงูุจุญุซ ุงููุตู ูู MongoDB
  const textResults = await searchTextInDatabase(query, merchantId);

  // 2. ุงูุจุญุซ ุงููุชุฌูู ูู Qdrant
  const vectorResults = await searchSimilarResponses(query, merchantId);

  // 3. ุฏูุฌ ุงููุชุงุฆุฌ
  const combinedResults = [
    ...textResults.map((r) => ({ ...r, source: 'text_search' })),
    ...vectorResults.map((r) => ({ ...r, source: 'vector_search' })),
  ];

  // 4. ุชุฑุชูุจ ุญุณุจ ุงูุตูุฉ
  return combinedResults
    .sort((a, b) => b.similarity - a.similarity)
    .slice(0, 5);
}
```

## 6. ูุนุงููุฑ ุงูุฃูุงู ูุงูุญูุงูุฉ

### 6.1 ุงูุชุญูู ูู ุงูุตูุงุญูุฉ

```typescript
// ุงูุชุญูู ูู ุตูุงุญูุฉ ุงููุณุชุฎุฏู ููุชูููู
const message = await messagesRepo.findBySessionAndIndex(sessionId, msgIdx);
const user = await getCurrentUser();

if (message.sessionId !== user.sessionId) {
  throw new ForbiddenException('Cannot rate this message');
}
```

### 6.2 Rate Limiting

- **ุชูููู ุงูุฑุณุงุฆู**: 10 ุชููููุงุช/ุฏูููุฉ ููู ูุณุชุฎุฏู
- **ุฅูุดุงุก ุงูุชุนูููุงุช**: 5 ุชุนูููุงุช/ุฏูููุฉ ููู ุชุงุฌุฑ
- **ุงูุจุญุซ ุงููุชุฌูู**: 100 ุทูุจ/ุฏูููุฉ ููู ุชุงุฌุฑ

### 6.3 ููุน ุงูุฅุณุงุกุฉ

```typescript
// ูุญุต ุงูุชุนูููุงุช ุงููุณูุฆุฉ
function isAbusiveFeedback(feedback: string): boolean {
  const abusivePatterns = ['ูููุฉ ูุณูุฆุฉ', 'ุณุจ', 'ุดุชู'];
  return abusivePatterns.some((pattern) =>
    feedback.toLowerCase().includes(pattern),
  );
}
```

## 7. ูุณุงุฑุงุช ุงูุฎุทุฃ ูุงูุชุนุงูู ูุนูุง

### 7.1 ุฃุฎุทุงุก ุงูุชูููู

```javascript
INVALID_RATING; // ูููุฉ ุชูููู ุบูุฑ ุตุญูุญุฉ
MESSAGE_NOT_FOUND; // ุงูุฑุณุงูุฉ ุบูุฑ ููุฌูุฏุฉ
UNAUTHORIZED_ACCESS; // ุบูุฑ ูุฎูู ููุชูููู
SESSION_EXPIRED; // ุงูุชูุช ุตูุงุญูุฉ ุงูุฌูุณุฉ
```

### 7.2 ุฃุฎุทุงุก ุฅูุดุงุก ุงูุชุนูููุงุช

```javascript
AI_GENERATION_FAILED; // ูุดู ูู ุฅูุดุงุก ุงูุชุนูููุงุช
INSTRUCTION_TOO_LONG; // ุงูุชุนูููุงุช ุทูููุฉ ุฌุฏุงู
INVALID_INSTRUCTION; // ุงูุชุนูููุงุช ุบูุฑ ุตุญูุญุฉ
```

### 7.3 ุฃุฎุทุงุก ุงูููุฑุณุฉ

```javascript
VECTOR_INDEX_FAILED; // ูุดู ูู ููุฑุณุฉ Qdrant
EMBEDDING_FAILED; // ูุดู ูู ุชูููุฏ ุงูุชุถูููุงุช
DUPLICATE_CONTENT; // ูุญุชูู ููุฑุฑ ููุฌูุฏ ูุณุจูุงู
```

## 8. ุฎุทุฉ ุงูุงุฎุชุจุงุฑ ูุงูุชุญูู

### 8.1 ุงุฎุชุจุงุฑุงุช ุงููุญุฏุฉ

- ุงุฎุชุจุงุฑ ูุธุงู ุงูุชูููู (ุฅูุฌุงุจู/ุณูุจู)
- ุงุฎุชุจุงุฑ ุฅูุดุงุก ุงูุชุนูููุงุช ูู ุงูุฑุฏูุฏ ุงูุณูุจูุฉ
- ุงุฎุชุจุงุฑ ููุฑุณุฉ ุงูุฑุฏูุฏ ุงูุฌูุฏุฉ
- ุงุฎุชุจุงุฑ ุงูุจุญุซ ุงููุชุฌูู

### 8.2 ุงุฎุชุจุงุฑุงุช ุงูุชูุงูู

- ุงุฎุชุจุงุฑ ุงูุชูุงูู ูุน Gemini AI
- ุงุฎุชุจุงุฑ ุงูุชูุงูู ูุน Qdrant
- ุงุฎุชุจุงุฑ ุชุญุฏูุซ prompt ุงูุจูุช
- ุงุฎุชุจุงุฑ ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก

### 8.3 ุงุฎุชุจุงุฑุงุช ุงูุฃุฏุงุก

- ุงุฎุชุจุงุฑ ุงูุจุญุซ ูู ููุงุนุฏ ุจูุงูุงุช ูุจูุฑุฉ
- ุงุฎุชุจุงุฑ ุชูููุฏ ุงูุชุถูููุงุช ุจุงูุฌููุฉ
- ุงุฎุชุจุงุฑ ููุฑุณุฉ ูููุงุช ูุจูุฑุฉ ูู ุงููุญุชูู
- ุงุฎุชุจุงุฑ ุงุณุชููุงู ุงูุฐุงูุฑุฉ ูุงููุนุงูุฌ

---

_ุชู ุฅูุดุงุก ูุฐุง ุงูุชูุซูู ุจูุงุณุทุฉ ูุธุงู ูููู ูุฅุฏุงุฑุฉ ุงููุชุงุฌุฑ ุงูุฐููุฉ_
